<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coach Objectifs IA ‚Äì OHI & Workflows</title>

  <!-- SheetJS pour Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { primary:'#3b82f6', secondary:'#8b5cf6', success:'#10b981', warning:'#f59e0b', danger:'#ef4444' } } } };
  </script>

  <!-- Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-hover { transition: all .25s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,.1); }
    .progress-ring { transform: rotate(-90deg); }
    .pulse-dot { animation: pulse 2s infinite; } @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- ===== AUTH ===== -->
  <section id="authScreen" class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8">
      <h1 class="text-2xl font-bold text-gray-900 mb-2">Bienvenue üëã</h1>
      <p class="text-sm text-gray-600 mb-6">Connectez-vous pour acc√©der au tableau de bord.</p>

      <form id="emailForm" class="space-y-3">
        <input id="authEmail" type="email" placeholder="Email" class="w-full border rounded-xl px-4 py-3" required>
        <input id="authPass" type="password" placeholder="Mot de passe" class="w-full border rounded-xl px-4 py-3" required>
        <button id="emailLoginBtn" type="submit" class="w-full bg-primary text-white rounded-xl py-3 hover:bg-blue-600 flex items-center justify-center gap-2">
          <span>Se connecter</span>
          <span id="emailSpinner" class="hidden w-4 h-4 border-2 border-white/60 border-t-white rounded-full animate-spin"></span>
        </button>
      </form>

      <div class="my-4 flex items-center gap-3">
        <div class="h-px bg-gray-200 flex-1"></div>
        <span class="text-xs text-gray-400">ou</span>
        <div class="h-px bg-gray-200 flex-1"></div>
      </div>

      <button id="googleBtn" class="w-full border rounded-xl py-3 hover:bg-gray-50 flex items-center justify-center gap-2">
        <span>Continuer avec Google</span>
        <span id="googleSpinner" class="hidden w-4 h-4 border-2 border-gray-400 border-t-gray-700 rounded-full animate-spin"></span>
      </button>

      <p class="text-xs text-gray-500 mt-6">Pas de compte ? Saisissez votre email et mot de passe ci-dessus puis :</p>
      <button id="signupBtn" class="mt-2 w-full border rounded-xl py-2 text-sm hover:bg-gray-50">Cr√©er un compte</button>
    </div>
  </section>

  <!-- ===== HEADER ===== -->
  <header id="appHeader" class="gradient-bg text-white shadow-lg hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-6">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-white/20 rounded-xl grid place-items-center">
            <svg class="w-8 h-8 text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold">Coach Objectifs IA</h1>
            <p class="text-white/80 text-sm">Votre compagnon intelligent pour atteindre vos objectifs</p>
          </div>
        </div>
        <div class="flex items-center gap-6">
          <nav class="hidden md:flex gap-2">
            <button id="navDashboard" class="px-3 py-2 rounded-lg hover:bg-white/20 text-sm">Tableau de bord</button>
            <button id="navWorkflows" class="px-3 py-2 rounded-lg hover:bg-white/20 text-sm">Workflows</button>
            <button id="navExecution" class="px-3 py-2 rounded-lg hover:bg-white/20 text-sm">Ex√©cution</button>
          </nav>
          <div class="flex items-center gap-2 bg-white/20 rounded-lg px-4 py-2">
            <div class="w-2 h-2 bg-green-400 rounded-full pulse-dot"></div>
            <span id="userEmail" class="text-sm">‚Äî</span>
          </div>
          <button id="logoutBtn" class="bg-white/20 rounded-lg px-4 py-2 hover:bg-white/30 transition">D√©connexion</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ===== DASHBOARD ===== -->
  <main id="appScreen" class="hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <!-- OHI (col 2) -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-2xl p-6 shadow-sm">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-xl font-semibold text-gray-900">Mes OHI</h3>
              <div class="flex flex-wrap gap-2">
                <button id="openOhiFormBtn" class="bg-primary text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600">+ Ajouter un OHI</button>
                <input id="importFile" type="file" accept=".xlsx,.xls,.csv" class="hidden">
                <button id="importBtn" class="border px-3 py-2 rounded-lg text-sm hover:bg-gray-50">Importer</button>
                <button id="exportBtn" class="border px-3 py-2 rounded-lg text-sm hover:bg-gray-50">Exporter</button>
                <button id="templateBtn" class="border px-3 py-2 rounded-lg text-sm hover:bg-gray-50">T√©l√©charger Mod√®le</button>
              </div>
            </div>

            <!-- Form -->
            <form id="addOhiForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 hidden">
              <input id="title" type="text" placeholder="Titre" required class="border rounded-xl p-3"/>
              <input id="deadline" type="date" required class="border rounded-xl p-3"/>
              <textarea id="description" placeholder="Description" class="border rounded-xl p-3 md:col-span-2"></textarea>
              <select id="priority" class="border rounded-xl p-3">
                <option value="high">Haute</option>
                <option value="medium">Moyenne</option>
                <option value="low">Basse</option>
              </select>
              <div class="flex gap-3 md:col-span-2">
                <button type="button" id="cancelOhiBtn" class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300">Annuler</button>
                <button type="submit" class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-blue-600 flex items-center justify-center gap-2">
                  <span>Ajouter</span>
                  <span id="ohiSpinner" class="hidden w-4 h-4 border-2 border-white/60 border-t-white rounded-full animate-spin"></span>
                </button>
              </div>
            </form>

            <div id="ohiList" class="space-y-4"></div>
          </div>
        </div>

        <!-- Progression Globale (col 1) -->
        <div class="bg-white rounded-2xl p-6 shadow-sm">
          <h3 class="text-xl font-semibold text-gray-900 mb-6">Progression Globale</h3>
          <div class="flex items-center justify-center mb-6">
            <div class="relative w-32 h-32">
              <svg class="w-32 h-32 progress-ring">
                <circle cx="64" cy="64" r="56" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
                <circle id="progressCircle" cx="64" cy="64" r="56" stroke="#3b82f6" stroke-width="8" fill="none"
                        stroke-dasharray="351.86" stroke-dashoffset="351.86" stroke-linecap="round"></circle>
              </svg>
              <div class="absolute inset-0 grid place-items-center">
                <span id="globalProgress" class="text-2xl font-bold text-gray-900">0%</span>
              </div>
            </div>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between text-sm"><span class="text-gray-600">OHI total</span><span id="totalObjectives" class="font-medium">0</span></div>
            <div class="flex justify-between text-sm"><span class="text-gray-600">OHI compl√©t√©s</span><span id="completedObjectives" class="font-medium">0</span></div>
            <div class="flex justify-between text-sm"><span class="text-gray-600">Prochaine √©ch√©ance</span><span id="nextDeadline" class="font-medium text-orange-600">-</span></div>
          </div>
        </div>
      </div>

      <!-- Tourbillons -->
      <div class="bg-white rounded-2xl p-6 shadow-sm mb-8 border-l-4 border-orange-500">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-orange-100 rounded-lg grid place-items-center">
              <svg class="w-6 h-6 text-orange-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/></svg>
            </div>
            <div>
              <h3 class="text-xl font-semibold text-gray-900">üå™Ô∏è Tourbillons du Mois</h3>
              <p class="text-sm text-gray-600">Actions importantes pour ne pas se disperser</p>
            </div>
          </div>
          <button id="openWhirlwindModalBtn" class="bg-orange-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-orange-700">+ Nouveau Tourbillon</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div>
            <h4 class="font-medium text-gray-900 mb-3">Actions en cours</h4>
            <div id="activeWhirlwinds" class="space-y-3"></div>
          </div>
          <div>
            <h4 class="font-medium text-gray-900 mb-3">Actions termin√©es</h4>
            <div id="completedWhirlwinds" class="space-y-3"></div>
          </div>
        </div>
      </div>

      <!-- Toast -->
      <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-sm px-4 py-2 rounded-lg shadow-lg hidden"></div>
    </div>
  </main>

  <!-- ===== WORKFLOWS PAGE ===== -->
  <section id="workflowsScreen" class="hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Workflows disponibles</h2>
        <span class="text-sm text-gray-500">Depuis Firestore ‚Üí collection <code>workflows</code></span>
      </div>
      <div id="wfList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
      <div id="wfEmpty" class="hidden text-center text-gray-500 py-16">
        <p class="mb-2">Aucun workflow trouv√©.</p>
        <p class="text-sm">Ajoute un document dans <code>workflows</code> (ex. <em>SEO ‚Üí Article ‚Üí Newsletter</em>).</p>
      </div>
    </div>
  </section>

  <!-- ===== EXECUTION PAGE ===== -->
  <section id="executionScreen" class="hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Ex√©cution d'un job</h2>
      </div>

      <div class="bg-white rounded-2xl p-6 shadow-sm mb-6">
        <div class="flex flex-col sm:flex-row gap-3 sm:items-end">
          <div class="flex-1">
            <label class="block text-sm text-gray-700 mb-1">Job ID</label>
            <input id="jobIdInput" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="Colle ici un jobId (ou lance un workflow)">
          </div>
          <button id="loadJobBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600">Charger</button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <div class="lg:col-span-1 bg-white rounded-2xl p-6 shadow-sm">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Statut du job</h3>
          <div id="jobMeta" class="space-y-2 text-sm text-gray-700">
            <div><span class="text-gray-500">Workflow:</span> <span id="jobWorkflow">‚Äî</span></div>
            <div><span class="text-gray-500">Statut:</span> <span id="jobStatus" class="px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-700">‚Äî</span></div>
            <div><span class="text-gray-500">Cr√©√© le:</span> <span id="jobCreated">‚Äî</span></div>
          </div>
          <div class="mt-6 flex gap-3">
            <button id="approveBtn" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg opacity-50 cursor-not-allowed" disabled>Approuver</button>
            <button id="rejectBtn" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg opacity-50 cursor-not-allowed" disabled>Rejeter</button>
          </div>
        </div>

        <div class="lg:col-span-2 bg-white rounded-2xl p-6 shadow-sm">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">√âtapes (runs)</h3>
          </div>
          <div id="runsList" class="space-y-3"></div>
          <div id="runsEmpty" class="hidden text-center text-gray-500 py-10 text-sm">Aucun run pour l'instant.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== MODALS ===== -->
  <div id="whirlwindModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-lg w-full mx-4">
      <h3 class="text-xl font-semibold text-gray-900 mb-6">üå™Ô∏è Nouveau Tourbillon</h3>
      <form id="whirlwindForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Action √† mener</label>
          <input type="text" id="whirlwindTitle" class="w-full border rounded-lg px-3 py-2" placeholder="Ex: √âtablir la masse salariale" required>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Cat√©gorie</label>
            <select id="whirlwindCategory" class="w-full border rounded-lg px-3 py-2">
              <option value="management">üë• Management</option>
              <option value="finance">üí∞ Finance</option>
              <option value="operations">‚öôÔ∏è Op√©rations</option>
              <option value="strategy">üéØ Strat√©gie</option>
              <option value="hr">üëî RH</option>
              <option value="communication">üì¢ Communication</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Priorit√©</label>
            <select id="whirlwindPriority" class="w-full border rounded-lg px-3 py-2">
              <option value="high">üî¥ Haute</option>
              <option value="medium">üü° Moyenne</option>
              <option value="low">üü¢ Basse</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">√âch√©ance</label>
          <input type="date" id="whirlwindDeadline" class="w-full border rounded-lg px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
          <textarea id="whirlwindNotes" rows="3" class="w-full border rounded-lg px-3 py-2" placeholder="D√©tails, personnes impliqu√©es, ressources n√©cessaires..."></textarea>
        </div>
        <div class="flex gap-3 pt-2">
          <button type="button" id="cancelWhirlwindBtn" class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300">Annuler</button>
          <button type="submit" class="flex-1 bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 flex items-center justify-center gap-2">
            <span>Cr√©er</span>
            <span id="whirlwindSpinner" class="hidden w-4 h-4 border-2 border-white/60 border-t-white rounded-full animate-spin"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Launch workflow modal -->
  <div id="launchModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-lg w-full mx-4">
      <h3 class="text-xl font-semibold text-gray-900 mb-4">üöÄ Lancer le workflow</h3>
      <p id="launchWfName" class="text-sm text-gray-600 mb-4">‚Äî</p>
      <form id="launchForm" class="space-y-4">
        <div>
          <label class="block text-sm text-gray-700 mb-1">Sujet</label>
          <input id="inSubject" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="Ex: Chaussures de running" required>
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">Audience</label>
          <input id="inAudience" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="Ex: D√©butants, sportifs...">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-700 mb-1">Ton</label>
            <select id="inTone" class="w-full border rounded-lg px-3 py-2">
              <option value="expert">Expert</option>
              <option value="convivial">Convivial</option>
              <option value="persuasif">Persuasif</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-700 mb-1">Langue</label>
            <select id="inLang" class="w-full border rounded-lg px-3 py-2">
              <option value="fr">Fran√ßais</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>
        <div class="flex gap-3 pt-2">
          <button type="button" id="cancelLaunchBtn" class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300">Annuler</button>
          <button type="submit" class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-blue-600 flex items-center justify-center gap-2">
            <span>Lancer</span>
            <span id="launchSpinner" class="hidden w-4 h-4 border-2 border-white/60 border-t-white rounded-full animate-spin"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ================= SCRIPTS APP ================= -->
  <script>
    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyD4JaJelN4LbkbLfGVJVbCAY6gK9sPAN3I",
      authDomain: "tableau-de-bord-intelligent.firebaseapp.com",
      projectId: "tableau-de-bord-intelligent",
      storageBucket: "tableau-de-bord-intelligent.appspot.com",
      messagingSenderId: "226539421183",
      appId: "1:226539421183:web:7386e6a4274f1c9fde3bca",
      measurementId: "G-7K0EN05CJ7"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
    auth.useDeviceLanguage();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    // ---------- helpers ----------
    const $ = (s) => document.querySelector(s);
    const show = (el) => el.classList.remove('hidden');
    const hide = (el) => el.classList.add('hidden');
    const spin = (el, on) => el && el.classList.toggle('hidden', !on);
    function toast(msg, err=false){ const t=$('#toast'); if(!t) return; t.textContent=msg; t.classList.remove('hidden'); t.classList.toggle('bg-red-600',err); t.classList.toggle('bg-gray-900',!err); setTimeout(()=>t.classList.add('hidden'),2200); }
    const fmtDate = (ts) => { if(!ts) return '‚Äî'; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString(); };

    // ---------- Navigation ----------
    function showScreen(screen){
      const map = { dashboard: '#appScreen', workflows: '#workflowsScreen', execution: '#executionScreen' };
      ['#appScreen','#workflowsScreen','#executionScreen'].forEach(id=>hide($(id)));
      show($(map[screen]));
    }
    $('#navDashboard')?.addEventListener('click', ()=>showScreen('dashboard'));
    $('#navWorkflows')?.addEventListener('click', ()=>{ showScreen('workflows'); loadWorkflows(); });
    $('#navExecution')?.addEventListener('click', ()=>showScreen('execution'));

    // ---------- auth state ----------
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        hide($('#authScreen'));
        show($('#appHeader')); show($('#appScreen'));
        $('#userEmail').textContent = user.email || 'Connect√©';
        await Promise.all([loadOhis(), loadWhirlwinds()]);
      } else {
        show($('#authScreen'));
        hide($('#appHeader')); hide($('#appScreen')); hide($('#workflowsScreen')); hide($('#executionScreen'));
      }
    });

    // ---------- email login ----------
    $('#emailForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); spin($('#emailSpinner'), true);
      try { await auth.signInWithEmailAndPassword($('#authEmail').value.trim(), $('#authPass').value.trim()); toast('Connect√© ‚úÖ'); }
      catch(err){ toast(err.message || 'Erreur de connexion', true); }
      finally { spin($('#emailSpinner'), false); }
    });

    // ---------- signup ----------
    $('#signupBtn').addEventListener('click', async ()=>{
      const email=$('#authEmail').value.trim(); const pass=$('#authPass').value.trim(); if(!email||!pass) return toast('Renseigne email et mot de passe.');
      try { await auth.createUserWithEmailAndPassword(email, pass); toast('Compte cr√©√© üéâ'); }
      catch(err){ toast(err.message || 'Erreur cr√©ation compte', true); }
    });

    // ---------- Google ----------
    $('#googleBtn').addEventListener('click', async ()=>{
      const provider = new firebase.auth.GoogleAuthProvider(); spin($('#googleSpinner'), true);
      try { await auth.signInWithPopup(provider); }
      catch(err){ if(err && /popup/.test(String(err.message||''))) { await auth.signInWithRedirect(provider); } else { toast(err.message||'Erreur Google', true); } }
      finally { spin($('#googleSpinner'), false); }
    });

    // ---------- logout ----------
    $('#logoutBtn').addEventListener('click', async ()=>{ try { await auth.signOut(); toast('D√©connect√©'); } catch { toast('Erreur d√©connexion', true); } });

    // ================= DASHBOARD (OHI) =================
    let ohis = [];
    async function loadOhis(){
      const u=auth.currentUser; if(!u) return;
      const snap=await db.collection('users').doc(u.uid).collection('ohis').orderBy('createdAt','desc').get();
      ohis=snap.docs.map(d=>({id:d.id,...d.data()}));
      renderOhis(); updateStatsFromOhis();
    }

    function renderOhis(){
      const list = $('#ohiList'); if(!list) return;
      if(!ohis.length){
        list.innerHTML = `
        <div class="text-center text-gray-500 py-8">
          <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" viewBox="0 0 20 20" fill="currentColor"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          <p>Aucun OHI</p><p class="text-sm">Ajoutez votre premier OHI</p>
        </div>`; return;
      }
      list.innerHTML = ohis.map(o=>{
        const pr=(o.priority||'').toLowerCase(); const prColor = pr==='high'?'text-red-600': pr==='medium'?'text-yellow-600':'text-green-600';
        const progress=Number(o.progress||0); const daysLeft=o.deadline?Math.ceil((new Date(o.deadline)-new Date())/86400000):null;
        const badge=o.deadline ? (daysLeft<0?`<span class="text-xs text-red-600">${Math.abs(daysLeft)} jours de retard</span>`:`<span class="text-xs text-gray-600">${daysLeft} jours restants</span>`) : '';
        return `
          <div class="border border-gray-200 rounded-xl p-4 card-hover">
            <div class="flex items-start justify-between mb-3">
              <div>
                <h4 class="font-semibold text-gray-900">${o.title||'(Sans titre)'}</h4>
                <p class="text-sm text-gray-600">${o.description||''}</p>
                <div class="mt-1 text-xs ${prColor}">Priorit√©: ${o.priority||'-'}</div>
              </div>
              <div class="text-right">${badge}</div>
            </div>
            <div class="mb-3">
              <div class="flex justify-between text-sm mb-1"><span class="text-gray-600">Progression</span><span class="font-medium">${progress}%</span></div>
              <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-primary h-2 rounded-full" style="width:${progress}%"></div></div>
            </div>
            <div class="flex gap-2">
              <button class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm" data-action="ohiprog" data-delta="-10" data-id="${o.id}">-10%</button>
              <button class="px-3 py-1 bg-primary text-white hover:bg-blue-600 rounded text-sm" data-action="ohiprog" data-delta="10" data-id="${o.id}">+10%</button>
              <button class="px-3 py-1 bg-green-600 text-white hover:bg-green-700 rounded text-sm" data-action="ohidone" data-id="${o.id}">Termin√©</button>
              <button class="px-3 py-1 bg-red-100 text-red-600 hover:bg-red-200 rounded text-sm" data-action="ohidel" data-id="${o.id}">Supprimer</button>
            </div>
          </div>`;
      }).join('');
    }

    $('#ohiList')?.addEventListener('click', async (e)=>{
      const btn=e.target.closest('[data-action]'); if(!btn) return; const id=btn.dataset.id; const u=auth.currentUser; if(!u) return toast('Non connect√©', true);
      const ref=db.collection('users').doc(u.uid).collection('ohis').doc(id);
      try{
        if(btn.dataset.action==='ohiprog'){
          const delta=parseInt(btn.dataset.delta,10);
          const curr=ohis.find(x=>x.id===id)?.progress||0;
          const next=Math.max(0,Math.min(100,curr+delta));
          await ref.update({progress:next,completed:next===100});
          toast('Progression mise √† jour');
        } else if(btn.dataset.action==='ohidone'){
          await ref.update({progress:100,completed:true}); toast('OHI termin√© üéØ');
        } else if(btn.dataset.action==='ohidel'){
          if(!confirm('Supprimer cet OHI ?')) return; await ref.delete(); toast('OHI supprim√©');
        }
        loadOhis();
      } catch(err){ toast('Action impossible', true); }
    });

    $('#openOhiFormBtn')?.addEventListener('click', ()=>{
      $('#addOhiForm').classList.remove('hidden');
      const d=new Date(); d.setMonth(d.getMonth()+1); $('#deadline').value=d.toISOString().split('T')[0];
    });
    $('#cancelOhiBtn')?.addEventListener('click', ()=>{ $('#addOhiForm').classList.add('hidden'); $('#addOhiForm').reset(); });

    $('#addOhiForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault(); const u=auth.currentUser; if(!u) return; spin($('#ohiSpinner'), true);
      const data={ title:$('#title').value.trim(), description:$('#description').value.trim(), priority:$('#priority').value, deadline:$('#deadline').value||null, progress:0, completed:false, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
      try{ await db.collection('users').doc(u.uid).collection('ohis').add(data); toast('OHI ajout√©.'); $('#addOhiForm').reset(); $('#addOhiForm').classList.add('hidden'); loadOhis(); }
      catch(err){ console.error('OHI error:',err); toast(err.message||'Erreur ajout OHI', true); }
      finally{ spin($('#ohiSpinner'), false); }
    });

    function updateStatsFromOhis(){
      const total=ohis.length;
      const completed=ohis.filter(o=>o.completed).length;
      $('#totalObjectives').textContent=total;
      $('#completedObjectives').textContent=completed;
      const next=ohis.filter(o=>!o.completed && o.deadline).sort((a,b)=>new Date(a.deadline)-new Date(b.deadline))[0];
      $('#nextDeadline').textContent= next?`${Math.ceil((new Date(next.deadline)-new Date())/86400000)} jours`:'-';
      const avg=Math.round((ohis.reduce((s,o)=>s+(o.progress||0),0)/Math.max(1,total)));
      $('#globalProgress').textContent=`${avg}%`;
      const c=$('#progressCircle'), C=2*Math.PI*56, off=C-(avg/100)*C; c.style.strokeDashoffset=off;
    }

    // ====== IMPORT / EXPORT OHI ======
    <script>
      
// -- helpers texte
function slugifyHeader(s) {
  if (!s) return "";
  return String(s)
    .normalize('NFD')                       // s√©pare accents
    .replace(/\p{Diacritic}/gu, '')        // retire accents
    .toLowerCase()
    .replace(/\([^)]*\)/g, ' ')            // retire le contenu entre parenth√®ses
    .replace(/[^a-z0-9% ]+/g, ' ')         // garde alphanum / %
    .replace(/\s+/g, ' ')
    .trim();
}

// Liste √©largie d‚Äôalias (apr√®s slugify)
const HEADER_ALIASES = {
  titre: [
    'titre','intitule','intitul√©','objectif','nom','libelle','libell√©','title'
  ],
  description: [
    'description','details','detail','desc','commentaire','notes','note'
  ],
  priorite: [
    'priorite','priorit√©','priority','prio','niveau priorite','niveau de priorite','niveau de priorit√©'
  ],
  echeance: [
    'echeance','√©ch√©ance','deadline','date','date limite','date echeance','date d echeance','due','due date','scadence'
  ],
  progression: [
    'progression','avancement','progress','%','pourcentage','taux progression','taux avancement'
  ],
};

// Essaie de mapper chaque colonne source -> cl√© canonique {titre, description, priorite, echeance, progression}
function buildHeaderMap(rawHeaders) {
  const map = {};
  rawHeaders.forEach((h) => {
    const slug = slugifyHeader(h);
    for (const [canon, aliases] of Object.entries(HEADER_ALIASES)) {
      if (aliases.includes(slug) || aliases.some(a => slug.includes(a))) {
        // on affecte seulement si pas d√©j√† mapp√© (priorit√© au 1er match)
        if (!map[canon]) map[canon] = h;
      }
    }
  });
  return map;
}

// Convertit une cellule date potentielle (string "2025-12-31", "31/12/2025" ou num√©ro Excel)
function parseDateCell(val) {
  if (val == null || val === '') return null;
  if (typeof val === 'number') {
    // num√©ro de s√©rie Excel -> date JS
    const excelEpoch = new Date(Date.UTC(1899, 11, 30));
    const ms = val * 86400000;
    const d = new Date(excelEpoch.getTime() + ms);
    return d.toISOString().slice(0,10);
  }
  const s = String(val).trim();
  // d√©j√† ISO
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  // remplace slash -> tiret et tente un parse
  const t = s.replace(/\//g, '-');
  const d = new Date(t);
  if (!isNaN(d)) return d.toISOString().slice(0,10);
  return null;
}

// T√©l√©charge un Blob
function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

// 1) T√©l√©charger le MOD√àLE (exactement format√© comme attendu)
document.getElementById('templateBtn').addEventListener('click', () => {
  const wb = XLSX.utils.book_new();
  // En-t√™tes EXACTES (ligne 1) + une ligne d‚Äôexemple
  const data = [
    ["Titre","Description","Priorit√© (high|medium|low)","√âch√©ance (YYYY-MM-DD)","Progression (0-100)"],
    ["Lancer le site","Mettre en ligne la v1","high","2025-12-31","0"]
  ];
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "OHIs"); // nom d‚Äôonglet standard
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  downloadBlob(new Blob([wbout], {type:"application/octet-stream"}), "Modele_OHI.xlsx");
});

// 2) Exporter les OHI (m√™mes en-t√™tes/ordre que le mod√®le)
document.getElementById('exportBtn').addEventListener('click', () => {
  if (!Array.isArray(ohis)) return toast("Aucun OHI √† exporter", true);
  const rows = [
    ["Titre","Description","Priorit√© (high|medium|low)","√âch√©ance (YYYY-MM-DD)","Progression (0-100)"]
  ];
  ohis.forEach(o => {
    // On force l‚Äôordre/format
    rows.push([
      o.title || "",
      o.description || "",
      (o.priority || "medium"),
      (o.deadline || ""),
      String(o.progress ?? 0)
    ]);
  });
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "OHIs");
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  downloadBlob(new Blob([wbout], {type:"application/octet-stream"}), `Export_OHI_${new Date().toISOString().slice(0,10)}.xlsx`);
  toast("Export cr√©√© ‚úÖ");
});

// 3) Importer (tol√©rant sur les en-t√™tes, CSV/XLS/XLSX)
document.getElementById('importBtn').addEventListener('click', () => {
  document.getElementById('importFile').value = "";
  document.getElementById('importFile').click();
});

document.getElementById('importFile').addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  try {
    const arrayBuffer = await file.arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];

    // IMPORTANT : header:1 -> on lit d‚Äôabord les en-t√™tes bruts
    const rows = XLSX.utils.sheet_to_json(sheet, { header:1, defval:"" });
    if (!rows.length) return toast("Fichier vide", true);

    const headers = rows[0];                  // 1√®re ligne
    const dataRows = rows.slice(1);           // lignes suivantes
    const headerMap = buildHeaderMap(headers);

    if (!headerMap.titre) {
      return toast("Mod√®le non reconnu : la colonne 'Titre' (ou √©quivalent) est requise. T√©l√©charge d‚Äôabord le Mod√®le.", true);
    }

    const u = auth.currentUser;
    if (!u) return toast("Connecte-toi d'abord", true);

    // Index des colonnes
    const idx = {};
    headers.forEach((h, i) => {
      const slug = slugifyHeader(h);
      for (const [canon, aliases] of Object.entries(HEADER_ALIASES)) {
        if (aliases.includes(slug) || aliases.some(a => slug.includes(a))) {
          if (idx[canon] == null) idx[canon] = i;
        }
      }
    });

    const toCreate = [];
    for (const row of dataRows) {
      if (!Array.isArray(row)) continue;
      const title = String(row[idx.titre ?? -1] || "").trim();
      if (!title) continue; // ignore lignes sans titre

      const description = idx.description != null ? String(row[idx.description] || "").trim() : "";
      let priority = idx.priorite != null ? String(row[idx.priorite] || "").trim().toLowerCase() : "medium";
      if (!['high','medium','low'].includes(priority)) priority = "medium";

      const rawDeadline = idx.echeance != null ? row[idx.echeance] : null;
      const deadline = parseDateCell(rawDeadline);
      let progress = 0;
      if (idx.progression != null) {
        const p = Number(String(row[idx.progression]).replace(',', '.'));
        progress = isNaN(p) ? 0 : Math.max(0, Math.min(100, Math.round(p)));
      }

      toCreate.push({
        title, description, priority,
        deadline,
        progress,
        completed: progress === 100,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      });
    }

    if (!toCreate.length) return toast("Aucune ligne valide trouv√©e (colonne 'Titre').", true);

    // √âcritures Firestore
    for (const doc of toCreate) {
      await db.collection('users').doc(u.uid).collection('ohis').add(doc);
    }

    toast(`Import termin√© : ${toCreate.length} OHI${toCreate.length>1?'s':''} cr√©√©s ‚úÖ`);
    await loadOhis();
  } catch (err) {
    console.error(err);
    toast("√âchec de l'import. Essaye avec le Mod√®le ou v√©rifie les en-t√™tes.", true);
  }
});
</script>

    // ================= WORKFLOWS =================
    let workflows = [];
    async function loadWorkflows(){
      const snap = await db.collection('workflows').get();
      workflows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderWorkflows();
    }
    function renderWorkflows(){
      const list=$('#wfList'); const empty=$('#wfEmpty'); if(!list) return;
      if(!workflows.length){ list.innerHTML=''; show(empty); return; }
      hide(empty);
      list.innerHTML = workflows.map(w=>{
        const steps = Array.isArray(w.steps)? w.steps.length : 0;
        return `
          <div class="bg-white rounded-2xl p-6 shadow-sm card-hover border border-gray-100">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h4 class="text-lg font-semibold text-gray-900">${w.name || '(Sans nom)'}</h4>
                <p class="text-sm text-gray-600 mt-1">${w.description || ''}</p>
                <div class="mt-3 text-xs text-gray-500">${steps} √©tape(s)</div>
              </div>
              <button class="shrink-0 px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600" data-action="launch" data-id="${w.id}">Lancer</button>
            </div>
          </div>`;
      }).join('');
    }
    $('#wfList')?.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-action="launch"]'); if(!btn) return; const wf = workflows.find(x=>x.id===btn.dataset.id); if(!wf) return;
      $('#launchWfName').textContent = wf.name || wf.id; $('#launchForm').dataset.wfid = wf.id; show($('#launchModal'));
    });
    $('#cancelLaunchBtn')?.addEventListener('click', ()=>{ hide($('#launchModal')); $('#launchForm').reset(); });

    $('#launchForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault(); const u=auth.currentUser; if(!u) return toast('Non connect√©', true);
      const wfId = e.currentTarget.dataset.wfid; if(!wfId) return toast('Workflow introuvable', true);
      const inputs = { subject: $('#inSubject').value.trim(), audience: $('#inAudience').value.trim(), tone: $('#inTone').value, language: $('#inLang').value };
      spin($('#launchSpinner'), true);
      try {
        const job = { workflowType: wfId, inputs, status: 'queued', createdBy: u.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
        const ref = await db.collection('jobs').add(job);
        toast('Job cr√©√© üöÄ'); hide($('#launchModal')); $('#launchForm').reset();
        $('#jobIdInput').value = ref.id; showScreen('execution'); startWatchingJob(ref.id);
      } catch(err){ console.error('Launch error:', err); toast(err.message||'Erreur cr√©ation job', true); }
      finally{ spin($('#launchSpinner'), false); }
    });

    // ================= EXECUTION =================
    let unsubJob = null, unsubRuns = null;
    function clearWatchers(){ if(unsubJob){unsubJob();unsubJob=null;} if(unsubRuns){unsubRuns();unsubRuns=null;} }
    function badge(text, kind){
      const cls = { queued:'bg-gray-100 text-gray-700', pending:'bg-gray-100 text-gray-700', running:'bg-blue-100 text-blue-700', completed:'bg-green-100 text-green-700', finished:'bg-green-100 text-green-700', failed:'bg-red-100 text-red-700' }[kind] || 'bg-gray-100 text-gray-700';
      return `<span class="px-2 py-0.5 rounded-full text-xs ${cls}">${text}</span>`;
    }
    function startWatchingJob(jobId){
      if(!jobId) return; clearWatchers();
      unsubJob = db.collection('jobs').doc(jobId).onSnapshot(doc=>{
        if(!doc.exists){ toast('Job introuvable', true); return; }
        const j = { id: doc.id, ...doc.data() };
        $('#jobWorkflow').textContent = j.workflowType || '‚Äî';
        $('#jobStatus').outerHTML = badge(j.status||'‚Äî', (j.status||'queued'));
        $('#jobCreated').textContent = fmtDate(j.createdAt);
      }, err=>{ console.error(err); toast('Erreur lecture job', true); });
      unsubRuns = db.collection('runs').where('jobId','==',jobId).orderBy('startedAt','asc').onSnapshot(snap=>{
        const items = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        renderRuns(items);
      }, err=>{ console.error(err); toast('Erreur lecture runs', true); });
    }
    function renderRuns(items){
      const list = $('#runsList'), empty=$('#runsEmpty'); if(!list) return; if(!items.length){ list.innerHTML=''; show(empty); return; } hide(empty);
      list.innerHTML = items.map(r=>{
        const started = fmtDate(r.startedAt), ended = fmtDate(r.endedAt);
        const st = r.status || 'running';
        return `
          <div class="border border-gray-200 rounded-xl p-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium text-gray-900">${r.step || '(√âtape)'} ${badge(st, st)}</div>
                <div class="text-xs text-gray-500 mt-1">D√©but: ${started} ¬∑ Fin: ${ended}</div>
              </div>
              <div class="text-right text-sm text-gray-700">
                ${r.output && r.output.summary ? `<span class='text-gray-500'>R√©sum√©:</span> ${r.output.summary}` : ''}
              </div>
            </div>
          </div>`;
      }).join('');
    }
    $('#loadJobBtn')?.addEventListener('click', ()=>{ const id=$('#jobIdInput').value.trim(); if(!id) return toast('Entre un jobId.'); startWatchingJob(id); });

    // ================= TOURBILLONS =================
    let whirlwinds = [];
    async function loadWhirlwinds(){ const u=auth.currentUser; if(!u) return; const snap=await db.collection('users').doc(u.uid).collection('whirlwinds').orderBy('createdAt','desc').get(); whirlwinds=snap.docs.map(d=>({id:d.id,...d.data()})); renderWhirlwinds(); }
    function renderWhirlwinds(){
      const activeC=$('#activeWhirlwinds'), doneC=$('#completedWhirlwinds'); if(!activeC||!doneC) return; const active=whirlwinds.filter(w=>!w.completed), done=whirlwinds.filter(w=>w.completed);
      activeC.innerHTML = active.length ? active.map(w=>{ const daysLeft=w.deadline?Math.ceil((new Date(w.deadline)-new Date())/86400000):null; const isOverdue=daysLeft!==null && daysLeft<0; const priColor=w.priority==='high'?'border-red-500 bg-red-50': w.priority==='medium'?'border-yellow-500 bg-yellow-50':'border-green-500 bg-green-50'; const priLabel=w.priority==='high'?'üî¥ Haute': w.priority==='medium'?'üü° Moyenne':'üü¢ Basse'; const icon={management:'üë•', finance:'üí∞', operations:'‚öôÔ∏è', strategy:'üéØ', hr:'üëî', communication:'üì¢'}[w.category]||'üå™Ô∏è'; return `
          <div class="border-l-4 ${priColor} p-4 rounded-lg">
            <div class="flex items-start justify-between mb-2">
              <div class="flex items-center gap-2"><span>${icon}</span><h4 class="font-medium text-gray-900">${w.title}</h4></div>
              <span class="text-xs ${isOverdue ? 'text-red-600' : 'text-gray-600'}">${w.deadline ? (isOverdue ? `${Math.abs(daysLeft)}j retard` : `${daysLeft}j restants`) : ''}</span>
            </div>
            <p class="text-sm text-gray-600 mb-3">${w.notes||''}</p>
            <div class="flex items-center justify-between">
              <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700">${priLabel}</span>
              <div class="space-x-2">
                <button class="text-xs bg-green-600 text-white px-3 py-1 rounded" data-action="done-whirlwind" data-id="${w.id}">‚úì Termin√©</button>
                <button class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded" data-action="delete-whirlwind" data-id="${w.id}">Supprimer</button>
              </div>
            </div>
          </div>`; }).join('') : `<div class="text-center text-gray-500 py-4 text-sm">Aucune action en cours</div>`;
      doneC.innerHTML = done.length ? done.slice(0,3).map(w=>{ const icon={management:'üë•', finance:'üí∞', operations:'‚öôÔ∏è', strategy:'üéØ', hr:'üëî', communication:'üì¢'}[w.category]||'üå™Ô∏è'; return `
          <div class="border border-gray-200 p-3 rounded-lg bg-gray-50 opacity-75">
            <div class="flex items-center gap-2 mb-1"><span class="text-sm">${icon}</span><h4 class="text-sm font-medium text-gray-700 line-through">${w.title}</h4><span class="text-xs text-green-600">‚úì</span></div>
            <p class="text-xs text-gray-500">${w.notes||''}</p>
          </div>`; }).join('') : `<div class="text-center text-gray-500 py-4 text-sm">Aucune action termin√©e</div>`;
    }
    $('#openWhirlwindModalBtn')?.addEventListener('click', ()=>{ const d=new Date(); d.setMonth(d.getMonth()+1); $('#whirlwindDeadline').value=d.toISOString().split('T')[0]; show($('#whirlwindModal')); });
    $('#cancelWhirlwindBtn')?.addEventListener('click', ()=>{ hide($('#whirlwindModal')); $('#whirlwindForm').reset(); });
    $('#whirlwindForm')?.addEventListener('submit', async (e)=>{ e.preventDefault(); const u=auth.currentUser; if(!u) return; spin($('#whirlwindSpinner'), true);
      const data={ title:$('#whirlwindTitle').value.trim(), category:$('#whirlwindCategory').value, priority:$('#whirlwindPriority').value, deadline:$('#whirlwindDeadline').value||null, notes:$('#whirlwindNotes').value.trim(), completed:false, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
      try{ await db.collection('users').doc(u.uid).collection('whirlwinds').add(data); hide($('#whirlwindModal')); $('#whirlwindForm').reset(); toast('Tourbillon ajout√©.'); loadWhirlwinds(); }
      catch(err){ toast('Erreur ajout tourbillon', true); }
      finally{ spin($('#whirlwindSpinner'), false); }
    });
    $('#activeWhirlwinds')?.addEventListener('click', async (e)=>{ const doneBtn=e.target.closest('[data-action="done-whirlwind"]'); const delBtn=e.target.closest('[data-action="delete-whirlwind"]'); if(!doneBtn && !delBtn) return; const u=auth.currentUser; if(!u) return; const id=(doneBtn||delBtn).dataset.id; const ref=db.collection('users').doc(u.uid).collection('whirlwinds').doc(id); try{ if(doneBtn){ await ref.update({completed:true}); toast('Marqu√© termin√©.'); } if(delBtn){ if(!confirm('Supprimer ce tourbillon ?')) return; await ref.delete(); toast('Tourbillon supprim√©.'); } loadWhirlwinds(); } catch { toast('Action impossible', true); } });

    // √âcran par d√©faut
    showScreen('dashboard');
  </script>
</body>
</html>
