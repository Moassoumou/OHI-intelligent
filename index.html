<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coach Objectifs IA – OHI + Livrables</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { primary:'#3b82f6', secondary:'#8b5cf6', success:'#10b981', warning:'#f59e0b', danger:'#ef4444' }}}};
  </script>

  <!-- Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-hover { transition: all .25s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,.1); }
    .pulse-dot { animation: pulse 2s infinite; } @keyframes pulse {0%,100%{opacity:1} 50%{opacity:.5}}
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- ===== AUTH ===== -->
  <section id="authScreen" class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8">
      <h1 class="text-2xl font-bold text-gray-900 mb-2">Bienvenue 👋</h1>
      <p class="text-sm text-gray-600 mb-6">Connectez-vous pour accéder au tableau de bord.</p>

      <form id="emailForm" class="space-y-3">
        <input id="authEmail" type="email" placeholder="Email" class="w-full border rounded-xl px-4 py-3" required>
        <input id="authPass" type="password" placeholder="Mot de passe" class="w-full border rounded-xl px-4 py-3" required>
        <button id="emailLoginBtn" type="submit" class="w-full bg-primary text-white rounded-xl py-3 hover:bg-blue-600 flex items-center justify-center gap-2">
          <span>Se connecter</span>
          <span id="emailSpinner" class="hidden w-4 h-4 border-2 border-white/60 border-t-white rounded-full animate-spin"></span>
        </button>
      </form>

      <div class="my-4 flex items-center gap-3">
        <div class="h-px bg-gray-200 flex-1"></div>
        <span class="text-xs text-gray-400">ou</span>
        <div class="h-px bg-gray-200 flex-1"></div>
      </div>

      <button id="googleBtn" class="w-full border rounded-xl py-3 hover:bg-gray-50 flex items-center justify-center gap-2">
        <span>Continuer avec Google</span>
        <span id="googleSpinner" class="hidden w-4 h-4 border-2 border-gray-400 border-t-gray-700 rounded-full animate-spin"></span>
      </button>

      <p class="text-xs text-gray-500 mt-6">Pas de compte ? Saisissez votre email et mot de passe ci-dessus puis :</p>
      <button id="signupBtn" class="mt-2 w-full border rounded-xl py-2 text-sm hover:bg-gray-50">Créer un compte</button>
    </div>
  </section>

  <!-- ===== HEADER ===== -->
  <header id="appHeader" class="gradient-bg text-white shadow-lg hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-6">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-white/20 rounded-xl grid place-items-center">
            <svg class="w-8 h-8 text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold">Coach Objectifs IA</h1>
            <p class="text-white/80 text-sm">Votre compagnon intelligent pour atteindre vos objectifs</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2 bg-white/20 rounded-lg px-4 py-2">
            <div class="w-2 h-2 bg-green-400 rounded-full pulse-dot"></div>
            <span id="userEmail" class="text-sm">—</span>
          </div>
          <button id="logoutBtn" class="bg-white/20 rounded-lg px-4 py-2 hover:bg-white/30 transition">Déconnexion</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ===== APP ===== -->
  <main id="appScreen" class="hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

      <!-- OHI + Progress -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">

        <!-- OHI -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-2xl p-6 shadow-sm">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-xl font-semibold text-gray-900">Mes OHI</h3>
              <button id="openOhiFormBtn" class="bg-primary text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600">+ Ajouter un OHI</button>
            </div>

            <!-- Form OHI -->
            <form id="addOhiForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 hidden">
              <input id="title" type="text" placeholder="Titre" required class="border rounded-xl p-3"/>
              <input id="deadline" type="date" required class="border rounded-xl p-3"/>
              <textarea id="description" placeholder="Description" class="border rounded-xl p-3 md:col-span-2"></textarea>
              <select id="priority" class="border rounded-xl p-3">
                <option value="high">Haute</option>
                <option value="medium" selected>Moyenne</option>
                <option value="low">Basse</option>
              </select>
              <div class="flex gap-3 md:col-span-2">
                <button type="button" id="cancelOhiBtn" class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300">Annuler</button>
                <button type="submit" class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-blue-600 flex items-center justify-center gap-2">
                  <span>Ajouter</span>
                  <span id="ohiSpinner" class="hidden w-4 h-4 border-2 border-white/60 border-t-white rounded-full animate-spin"></span>
                </button>
              </div>
            </form>

            <div id="ohiList" class="space-y-4"></div>
          </div>
        </div>

        <!-- Progression Globale -->
        <div class="bg-white rounded-2xl p-6 shadow-sm">
          <h3 class="text-xl font-semibold text-gray-900 mb-6">Progression Globale</h3>
          <div class="flex items-center justify-center mb-6">
            <div class="relative w-32 h-32">
              <svg class="w-32 h-32" style="transform:rotate(-90deg)">
                <circle cx="64" cy="64" r="56" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
                <circle id="progressCircle" cx="64" cy="64" r="56" stroke="#3b82f6" stroke-width="8" fill="none"
                        stroke-dasharray="351.86" stroke-dashoffset="351.86" stroke-linecap="round"></circle>
              </svg>
              <div class="absolute inset-0 grid place-items-center">
                <span id="globalProgress" class="text-2xl font-bold text-gray-900">0%</span>
              </div>
            </div>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between text-sm"><span class="text-gray-600">OHI total</span><span id="totalObjectives" class="font-medium">0</span></div>
            <div class="flex justify-between text-sm"><span class="text-gray-600">OHI complétés</span><span id="completedObjectives" class="font-medium">0</span></div>
            <div class="flex justify-between text-sm"><span class="text-gray-600">Prochaine échéance</span><span id="nextDeadline" class="font-medium text-orange-600">-</span></div>
          </div>
        </div>
      </div>

      <!-- Toast -->
      <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-sm px-4 py-2 rounded-lg shadow-lg hidden"></div>
    </div>
  </main>

  <script>
    // ---------- CONFIG ----------
    const firebaseConfig = {
      /* ⬇️⬇️⬇️ METS TA CONFIG EXACTE ICI ⬇️⬇️⬇️
      apiKey: "...",
      authDomain: "...",
      projectId: "...",
      storageBucket: "...",
      messagingSenderId: "...",
      appId: "..."
      */
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
    auth.useDeviceLanguage();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    // ---------- helpers ----------
    const $ = (s) => document.querySelector(s);
    const show = (el) => el.classList.remove('hidden');
    const hide = (el) => el.classList.add('hidden');
    const spin = (el, on) => el && el.classList.toggle('hidden', !on);
    function toast(msg, err=false){
      const t = $('#toast'); if(!t) return;
      t.textContent = msg; t.classList.remove('hidden');
      t.classList.toggle('bg-red-600', err); t.classList.toggle('bg-gray-900', !err);
      setTimeout(()=>t.classList.add('hidden'), 2200);
    }
    const fmtDate = (ts) => { if(!ts) return '—'; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString(); };

    // ---------- auth state ----------
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        hide($('#authScreen')); show($('#appHeader')); show($('#appScreen'));
        $('#userEmail').textContent = user.email || 'Connecté';
        await loadOhis();
      } else {
        show($('#authScreen')); hide($('#appHeader')); hide($('#appScreen'));
      }
    });

    // ---------- email login / signup / google ----------
    $('#emailForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); spin($('#emailSpinner'), true);
      try { await auth.signInWithEmailAndPassword($('#authEmail').value.trim(), $('#authPass').value.trim()); toast('Connecté ✅'); }
      catch(err){ toast(err.message || 'Erreur de connexion', true); }
      finally { spin($('#emailSpinner'), false); }
    });
    $('#signupBtn').addEventListener('click', async ()=>{
      const email=$('#authEmail').value.trim(); const pass=$('#authPass').value.trim();
      if(!email||!pass) return toast('Renseigne email et mot de passe.');
      try { await auth.createUserWithEmailAndPassword(email, pass); toast('Compte créé 🎉'); }
      catch(err){ toast(err.message || 'Erreur création compte', true); }
    });
    $('#googleBtn').addEventListener('click', async ()=>{
      const provider = new firebase.auth.GoogleAuthProvider(); spin($('#googleSpinner'), true);
      try { await auth.signInWithPopup(provider); }
      catch(err){ if(err && /popup/.test(String(err.message||''))) { await auth.signInWithRedirect(provider); } else { toast(err.message||'Erreur Google', true); } }
      finally { spin($('#googleSpinner'), false); }
    });
    $('#logoutBtn').addEventListener('click', async ()=>{ try { await auth.signOut(); toast('Déconnecté'); } catch { toast('Erreur déconnexion', true); } });

    // ================= OHI (avec livrables) =================
    let ohis = [];

    async function loadOhis(){
      const u = auth.currentUser; if(!u) return;
      const snap = await db.collection('users').doc(u.uid).collection('ohis').orderBy('createdAt','desc').get();
      ohis = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderOhis();
      updateStatsFromOhis();
    }

    function renderOhis(){
      const list = $('#ohiList'); if(!list) return;
      if(!ohis.length){
        list.innerHTML = `
        <div class="text-center text-gray-500 py-8">
          <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" viewBox="0 0 20 20" fill="currentColor"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          <p>Aucun OHI</p><p class="text-sm">Ajoutez votre premier OHI</p>
        </div>`; return;
      }
      list.innerHTML = ohis.map(o=>{
        const pr=(o.priority||'').toLowerCase();
        const prColor = pr==='high'?'text-red-600': pr==='medium'?'text-yellow-600':'text-green-600';
        const progress=Number(o.progress||0);
        const daysLeft=o.deadline?Math.ceil((new Date(o.deadline)-new Date())/86400000):null;
        const badge=o.deadline ? (daysLeft<0?`<span class="text-xs text-red-600">${Math.abs(daysLeft)} jours de retard</span>`:`<span class="text-xs text-gray-600">${daysLeft} jours restants</span>`) : '';
        return `
          <div class="border border-gray-200 rounded-xl p-4 card-hover">
            <div class="flex items-start justify-between mb-3">
              <div>
                <h4 class="font-semibold text-gray-900">${o.title||'(Sans titre)'}</h4>
                <p class="text-sm text-gray-600">${o.description||''}</p>
                <div class="mt-1 text-xs ${prColor}">Priorité: ${o.priority||'-'}</div>
              </div>
              <div class="text-right">${badge}</div>
            </div>

            <!-- Progress -->
            <div class="mb-3">
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">Progression</span>
                <span class="font-medium">${progress}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-primary h-2 rounded-full" style="width:${progress}%"></div>
              </div>
            </div>

            <!-- Actions OHI -->
            <div class="flex flex-wrap gap-2 mb-3">
              <button class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm" data-action="ohiprog" data-delta="-10" data-id="${o.id}">-10%</button>
              <button class="px-3 py-1 bg-primary text-white hover:bg-blue-600 rounded text-sm" data-action="ohiprog" data-delta="10" data-id="${o.id}">+10%</button>
              <button class="px-3 py-1 bg-green-600 text-white hover:bg-green-700 rounded text-sm" data-action="ohidone" data-id="${o.id}">Terminé</button>
              <button class="px-3 py-1 bg-red-100 text-red-600 hover:bg-red-200 rounded text-sm" data-action="ohidel" data-id="${o.id}">Supprimer</button>
              <button class="px-3 py-1 bg-white border hover:bg-gray-50 rounded text-sm" data-action="toggle-deliv" data-id="${o.id}">📋 Livrables</button>
              <button class="px-3 py-1 bg-white border hover:bg-gray-50 rounded text-sm" data-action="recalc" data-id="${o.id}">↻ Recalculer depuis livrables</button>
            </div>

            <!-- Livrables (caché par défaut) -->
            <div id="delivBox-${o.id}" class="hidden border-t pt-3">
              <!-- formulaire ajout -->
              <form class="grid grid-cols-1 md:grid-cols-6 gap-2 mb-3" data-deliv-form="${o.id}">
                <input name="title" class="md:col-span-3 border rounded-lg px-3 py-2" placeholder="Titre du livrable" required>
                <input name="due" type="date" class="md:col-span-2 border rounded-lg px-3 py-2">
                <button class="md:col-span-1 bg-primary text-white rounded-lg px-3 py-2 hover:bg-blue-600">Ajouter</button>
                <textarea name="notes" class="md:col-span-6 border rounded-lg px-3 py-2" placeholder="Notes (optionnel)"></textarea>
              </form>
              <!-- liste -->
              <div id="delivList-${o.id}" class="space-y-2"></div>
            </div>
          </div>`;
      }).join('');
    }

    // Actions OHI (progress/done/delete + toggle livrables + recalc)
    $('#ohiList').addEventListener('click', async (e)=>{
      const btn = e.target.closest('[data-action]'); if(!btn) return;
      const action = btn.dataset.action; const ohiId = btn.dataset.id;
      const u = auth.currentUser; if(!u) return toast('Non connecté', true);
      const ref = db.collection('users').doc(u.uid).collection('ohis').doc(ohiId);

      try {
        if (action === 'ohiprog') {
          const delta = parseInt(btn.dataset.delta, 10);
          const curr = ohis.find(x=>x.id===ohiId)?.progress||0;
          const next = Math.max(0, Math.min(100, curr + delta));
          await ref.update({ progress: next, completed: next===100 });
          toast('Progression mise à jour');
          loadOhis();
        }
        else if (action === 'ohidone') {
          await ref.update({ progress: 100, completed: true });
          toast('OHI terminé 🎯'); loadOhis();
        }
        else if (action === 'ohidel') {
          if(!confirm('Supprimer cet OHI ?')) return;
          await ref.delete(); toast('OHI supprimé'); loadOhis();
        }
        else if (action === 'toggle-deliv') {
          const box = document.getElementById(`delivBox-${ohiId}`);
          box.classList.toggle('hidden');
          if (!box.classList.contains('hidden')) { await loadDeliverables(ohiId); }
        }
        else if (action === 'recalc') {
          await recalcProgressFromDeliverables(ohiId);
        }
      } catch (err) {
        console.error(err); toast('Action impossible', true);
      }
    });

    // Afficher formulaire ajout livrable (déjà dans le DOM) + Submit
    $('#ohiList').addEventListener('submit', async (e)=>{
      const form = e.target.closest('form[data-deliv-form]'); if(!form) return;
      e.preventDefault();
      const ohiId = form.getAttribute('data-deliv-form');
      const title = form.querySelector('input[name="title"]').value.trim();
      const due   = form.querySelector('input[name="due"]').value || null;
      const notes = form.querySelector('textarea[name="notes"]').value.trim();
      if(!title) return;

      try {
        await addDeliverable(ohiId, title, due, notes);
        form.reset();
        await loadDeliverables(ohiId);
        await recalcProgressFromDeliverables(ohiId);
      } catch(err){ console.error(err); toast("Ajout impossible", true); }
    });

    // ---------- Deliverables: CRUD ----------
    async function addDeliverable(ohiId, title, due=null, notes=""){
      const u = auth.currentUser; if(!u) throw new Error('Non connecté');
      const data = {
        title,
        done: false,
        order: Date.now(),
        due,
        notes,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await db.collection('users').doc(u.uid)
        .collection('ohis').doc(ohiId)
        .collection('deliverables').add(data);
      toast("Livrable ajouté ✅");
    }

    async function loadDeliverables(ohiId){
      const u = auth.currentUser; if(!u) return;
      const snap = await db.collection('users').doc(u.uid)
        .collection('ohis').doc(ohiId)
        .collection('deliverables').orderBy('order','asc').get();
      const items = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderDeliverables(ohiId, items);
    }

    function renderDeliverables(ohiId, items){
      const list = document.getElementById(`delivList-${ohiId}`); if(!list) return;
      if(!items.length){ list.innerHTML = `<div class="text-sm text-gray-500">Aucun livrable pour l’instant.</div>`; return; }
      list.innerHTML = items.map(d=>{
        const checked = d.done ? 'checked' : '';
        const due = d.due ? `<span class="text-xs text-gray-500">· Échéance: ${d.due}</span>` : '';
        const notes = d.notes ? `<div class="text-xs text-gray-500 mt-1">${d.notes}</div>` : '';
        return `
          <div class="border rounded-lg p-3 flex items-start justify-between">
            <label class="flex items-start gap-2">
              <input type="checkbox" data-action="toggle-done" data-ohi="${ohiId}" data-id="${d.id}" ${checked} class="mt-1">
              <div>
                <div class="text-sm ${d.done ? 'line-through text-gray-500' : 'text-gray-800'}">${d.title||''} ${due}</div>
                ${notes}
              </div>
            </label>
            <button class="text-xs text-red-600 hover:bg-red-50 px-2 py-1 rounded" data-action="del-deliv" data-ohi="${ohiId}" data-id="${d.id}">Supprimer</button>
          </div>`;
      }).join('');
    }

    // Toggle done / delete deliverable
    $('#ohiList').addEventListener('click', async (e)=>{
      const delBtn = e.target.closest('[data-action="del-deliv"]');
      const chk = e.target.closest('input[type="checkbox"][data-action="toggle-done"]');

      // delete
      if (delBtn) {
        const ohiId = delBtn.dataset.ohi, delivId = delBtn.dataset.id;
        const u = auth.currentUser; if(!u) return;
        try {
          await db.collection('users').doc(u.uid).collection('ohis').doc(ohiId)
            .collection('deliverables').doc(delivId).delete();
          await loadDeliverables(ohiId);
          await recalcProgressFromDeliverables(ohiId);
        } catch(err){ console.error(err); toast("Suppression impossible", true); }
      }

      // toggle done
      if (chk) {
        const ohiId = chk.dataset.ohi, delivId = chk.dataset.id;
        const u = auth.currentUser; if(!u) return;
        try {
          await db.collection('users').doc(u.uid).collection('ohis').doc(ohiId)
            .collection('deliverables').doc(delivId).update({ done: chk.checked });
          await recalcProgressFromDeliverables(ohiId);
        } catch(err){ console.error(err); toast("Mise à jour impossible", true); }
      }
    });

    // Recalcule et met à jour la progression d’un OHI depuis ses livrables
    async function recalcProgressFromDeliverables(ohiId){
      const u = auth.currentUser; if(!u) return;
      const ref = db.collection('users').doc(u.uid).collection('ohis').doc(ohiId);
      const snap = await ref.collection('deliverables').get();
      const total = snap.size;
      if (total === 0) { toast("Aucun livrable : progression manuelle conservée"); return; }
      const done = snap.docs.filter(d=>d.data().done).length;
      const pct = Math.round((done/total)*100);
      await ref.update({ progress: pct, completed: pct===100 });
      loadOhis();
    }

    // OHI: ouvrir/fermer form + submit
    $('#openOhiFormBtn').addEventListener('click', ()=>{
      $('#addOhiForm').classList.remove('hidden');
      const d=new Date(); d.setMonth(d.getMonth()+1); $('#deadline').value = d.toISOString().split('T')[0];
    });
    $('#cancelOhiBtn').addEventListener('click', ()=>{ $('#addOhiForm').classList.add('hidden'); $('#addOhiForm').reset(); });
    $('#addOhiForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); const u = auth.currentUser; if(!u) return;
      spin($('#ohiSpinner'), true);
      const data = {
        title: $('#title').value.trim(),
        description: $('#description').value.trim(),
        priority: $('#priority').value,
        deadline: $('#deadline').value || null,
        progress: 0,
        completed: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      };
      try {
        await db.collection('users').doc(u.uid).collection('ohis').add(data);
        toast('OHI ajouté.'); $('#addOhiForm').reset(); $('#addOhiForm').classList.add('hidden'); loadOhis();
      } catch (err) { console.error(err); toast('Erreur ajout OHI', true); }
      finally { spin($('#ohiSpinner'), false); }
    });

    // Stats
    function updateStatsFromOhis(){
      const total = ohis.length;
      const completed = ohis.filter(o=>o.completed).length;
      $('#totalObjectives').textContent = total;
      $('#completedObjectives').textContent = completed;
      const next = ohis.filter(o=>!o.completed && o.deadline).sort((a,b)=>new Date(a.deadline)-new Date(b.deadline))[0];
      $('#nextDeadline').textContent = next ? `${Math.ceil((new Date(next.deadline)-new Date())/86400000)} jours` : '-';
      const avg = Math.round((ohis.reduce((s,o)=>s+(o.progress||0),0)/Math.max(1,total)));
      $('#globalProgress').textContent = `${avg}%`;
      const c = $('#progressCircle'), C = 2*Math.PI*56, off = C-(avg/100)*C; c.style.strokeDashoffset = off;
    }

  </script>
</body>
</html>
