<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OHI – Coach & Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: {
        colors: {
          primary:'#3b82f6', secondary:'#8b5cf6',
          success:'#10b981', warning:'#f59e0b', danger:'#ef4444'
        }
      }}
    }
  </script>

  <!-- Fonts & styles -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .gradient-bg{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
    .card-hover{transition:all .25s ease}
    .card-hover:hover{transform:translateY(-2px);box-shadow:0 10px 25px -5px rgba(0,0,0,.1)}
    .toast{animation:slide .25s ease-out}
    @keyframes slide{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>

<body class="min-h-screen bg-gray-50">
  <!-- Header -->
  <header class="gradient-bg text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-6">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold">Coach Objectifs IA</h1>
            <p class="text-white/80 text-sm">Votre compagnon intelligent pour atteindre vos objectifs</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <span id="headerUserEmail" class="hidden text-sm text-white/90"></span>
          <button id="logoutBtn" class="hidden bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl">Déconnexion</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ===== AUTH VIEW ===== -->
  <main id="authView" class="max-w-md mx-auto -mt-10">
    <div class="bg-white shadow-2xl rounded-3xl p-8 card-hover">
      <h2 class="text-2xl font-bold mb-2">🔐 Connexion</h2>
      <p class="text-sm text-gray-600 mb-6">Connectez-vous pour accéder à votre tableau de bord.</p>

      <div class="grid grid-cols-1 gap-3 mb-6">
        <button id="googleBtn" class="w-full flex items-center justify-center gap-2 bg-white border hover:bg-gray-50 rounded-xl py-3">
          <span>Se connecter avec Google</span>
        </button>
        <button id="microsoftBtn" class="w-full flex items-center justify-center gap-2 bg-white border hover:bg-gray-50 rounded-xl py-3">
          <span>Se connecter avec Microsoft</span>
        </button>
      </div>

      <div class="relative my-6">
        <div class="border-t"></div>
        <span class="absolute -top-3 left-1/2 -translate-x-1/2 bg-white px-3 text-xs text-gray-500">ou e-mail</span>
      </div>

      <div class="flex mb-4 rounded-xl bg-gray-100 p-1">
        <button id="tabLogin"  class="flex-1 py-2 rounded-lg text-sm font-semibold bg-white">Se connecter</button>
        <button id="tabSignup" class="flex-1 py-2 rounded-lg text-sm font-semibold text-gray-600">Créer un compte</button>
      </div>

      <!-- Login -->
      <form id="loginForm" class="grid gap-3">
        <input id="loginEmail" type="email" placeholder="Email" required class="border rounded-xl p-3">
        <input id="loginPassword" type="password" placeholder="Mot de passe" required class="border rounded-xl p-3">
        <button type="submit" class="bg-primary hover:bg-blue-700 text-white rounded-xl py-3 font-semibold">Se connecter</button>
      </form>

      <!-- Signup -->
      <form id="signupForm" class="grid gap-3 hidden mt-4">
        <input id="signupEmail" type="email" placeholder="Email" required class="border rounded-xl p-3">
        <input id="signupPassword" type="password" placeholder="Mot de passe (6+ caractères)" minlength="6" required class="border rounded-xl p-3">
        <button type="submit" class="bg-primary hover:bg-blue-700 text-white rounded-xl py-3 font-semibold">Créer mon compte</button>
      </form>

      <p id="authError" class="text-sm text-red-600 mt-4 hidden"></p>
      <p class="text-xs text-gray-500 mt-3">
        Astuce: si la pop-up est bloquée ou si le domaine n’est pas autorisé, on bascule en redirection.
      </p>
    </div>
  </main>

  <!-- ===== APP VIEW ===== -->
  <section id="appView" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Coach -->
    <div class="bg-white rounded-2xl p-6 shadow-sm mb-8 border-l-4 border-primary">
      <div class="flex items-start gap-4">
        <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center shrink-0">
          <svg class="w-6 h-6 text-primary" fill="currentColor" viewBox="0 0 20 20">
            <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"/>
          </svg>
        </div>
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-2">
            <h3 class="font-semibold text-gray-900">Coach IA</h3>
            <span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">En ligne</span>
          </div>
          <div id="coachMessage" class="text-gray-700 mb-4">Bonjour 👋 ! Commence par définir ton 1er objectif.</div>
          <div class="flex flex-wrap gap-2">
            <button onclick="quickObjective('business')" class="px-3 py-1.5 bg-blue-100 text-blue-800 rounded-lg text-sm hover:bg-blue-200">🚀 Business</button>
            <button onclick="quickObjective('personal')" class="px-3 py-1.5 bg-green-100 text-green-800 rounded-lg text-sm hover:bg-green-200">🎯 Personnel</button>
            <button onclick="quickObjective('learning')" class="px-3 py-1.5 bg-purple-100 text-purple-800 rounded-lg text-sm hover:bg-purple-200">📚 Apprentissage</button>
            <button onclick="quickObjective('health')" class="px-3 py-1.5 bg-orange-100 text-orange-800 rounded-lg text-sm hover:bg-orange-200">💪 Santé</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Form OHI -->
    <div class="bg-white rounded-2xl p-6 shadow-sm mb-8 card-hover">
      <h2 class="text-xl font-semibold mb-4">➕ Ajouter un OHI</h2>
      <form id="addOhiForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input id="ohiTitle" type="text" placeholder="Titre" required class="border rounded-xl p-3"/>
        <input id="ohiDeadline" type="date" required class="border rounded-xl p-3"/>
        <textarea id="ohiDescription" placeholder="Description" class="border rounded-xl p-3 md:col-span-2"></textarea>
        <select id="ohiPriority" class="border rounded-xl p-3">
          <option value="high">Haute</option>
          <option value="medium" selected>Moyenne</option>
          <option value="low">Basse</option>
        </select>
        <button type="submit" class="bg-primary hover:bg-blue-700 text-white rounded-xl py-3">Ajouter</button>
      </form>
    </div>

    <!-- Liste OHI -->
    <div class="bg-white rounded-2xl p-6 shadow-sm mb-8 card-hover">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">📌 Mes OHI</h2>
      </div>
      <div id="ohiList" class="space-y-4"></div>
    </div>

    <!-- Tourbillons -->
    <div class="bg-white rounded-2xl p-6 shadow-sm mb-2 border-l-4 border-orange-500 card-hover">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">🌪️</div>
          <div>
            <h3 class="text-xl font-semibold text-gray-900">Tourbillons du mois</h3>
            <p class="text-sm text-gray-600">Actions importantes à forte dispersion</p>
          </div>
        </div>
        <button id="addWhirlwindBtn" class="bg-orange-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-orange-700">+ Nouveau tourbillon</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h4 class="font-medium text-gray-900 mb-3">En cours</h4>
          <div id="activeWhirlwinds" class="space-y-3"></div>
        </div>
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Terminés</h4>
          <div id="completedWhirlwinds" class="space-y-3"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Toast container -->
  <div id="toastStack" class="fixed bottom-4 right-4 space-y-2 z-[9999]"></div>

  <!-- Firebase Compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Ta config (doit appeler firebase.initializeApp({...})) -->
  <script src="./firebase.js"></script>

  <script>
    // ---------- Helpers UI ----------
    const $ = id => document.getElementById(id);
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');
    function toast(msg, type='info'){
      const stack = $('toastStack');
      const bg = type==='error'?'bg-red-600':type==='success'?'bg-green-600':'bg-gray-800';
      const el = document.createElement('div');
      el.className = `toast text-white ${bg} px-4 py-2 rounded-lg shadow`;
      el.textContent = msg;
      stack.appendChild(el);
      setTimeout(()=>{ el.style.opacity=.0; el.style.transform='translateY(6px)'; }, 3200);
      setTimeout(()=> el.remove(), 3800);
    }

    // ---------- Tabs auth ----------
    const tabLogin = $('tabLogin'), tabSignup = $('tabSignup');
    const loginForm = $('loginForm'), signupForm = $('signupForm'), authError = $('authError');
    tabLogin.onclick = () => { tabLogin.classList.add('bg-white'); tabSignup.classList.remove('bg-white'); loginForm.classList.remove('hidden'); signupForm.classList.add('hidden'); authError.classList.add('hidden'); }
    tabSignup.onclick = () => { tabSignup.classList.add('bg-white'); tabLogin.classList.remove('bg-white'); signupForm.classList.remove('hidden'); loginForm.classList.add('hidden'); authError.classList.add('hidden'); }

    // ---------- Firebase ----------
    if (!window.firebase?.apps?.length) {
      console.warn('⚠️ firebase.initializeApp() doit être appelé dans firebase.js');
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.useDeviceLanguage();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    const authView = $('authView'), appView = $('appView');
    const headerUserEmail = $('headerUserEmail'), logoutBtn = $('logoutBtn');

    function friendly(code){
      const m = {
        'auth/invalid-email': "Email invalide.",
        'auth/missing-password': "Mot de passe requis.",
        'auth/weak-password': "Mot de passe trop faible.",
        'auth/email-already-in-use': "Email déjà utilisé.",
        'auth/user-not-found': "Utilisateur introuvable.",
        'auth/wrong-password': "Mot de passe incorrect.",
        'auth/invalid-credential': "Identifiants invalides/expirés.",
        'auth/unauthorized-domain': "Domaine non autorisé (Firebase > Authentication > Authorized domains).",
        'auth/popup-blocked': "Pop-up bloquée par le navigateur.",
        'auth/operation-not-allowed': "Provider non activé dans Firebase."
      };
      return m[code] || "Une erreur est survenue.";
    }

    // Email login
    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault(); authError.classList.add('hidden');
      try {
        await auth.signInWithEmailAndPassword($('loginEmail').value.trim(), $('loginPassword').value);
        toast('Connecté ✅','success');
      } catch(err){ authError.textContent="Erreur: "+friendly(err.code); authError.classList.remove('hidden'); toast(friendly(err.code),'error'); console.error(err); }
    });

    // Email signup
    signupForm.addEventListener('submit', async (e)=>{
      e.preventDefault(); authError.classList.add('hidden');
      try {
        const cred = await auth.createUserWithEmailAndPassword($('signupEmail').value.trim(), $('signupPassword').value);
        await db.collection('users').doc(cred.user.uid).set({
          email: cred.user.email, provider:'password',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
        },{merge:true});
        toast('Compte créé ✅','success');
      } catch(err){ authError.textContent="Erreur: "+friendly(err.code); authError.classList.remove('hidden'); toast(friendly(err.code),'error'); console.error(err); }
    });

    // Google
    $('googleBtn').onclick = async ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({prompt:'select_account'});
      try { await auth.signInWithPopup(provider); }
      catch(err){
        if (['auth/popup-blocked','auth/unauthorized-domain','auth/operation-not-allowed'].includes(err.code)) {
          await auth.signInWithRedirect(provider);
        } else { toast(friendly(err.code),'error'); console.error(err); }
      }
    };

    // Microsoft
    $('microsoftBtn').onclick = async ()=>{
      const provider = new firebase.auth.OAuthProvider('microsoft.com');
      provider.setCustomParameters({prompt:'select_account'});
      try { await auth.signInWithPopup(provider); }
      catch(err){
        if (['auth/popup-blocked','auth/unauthorized-domain','auth/operation-not-allowed'].includes(err.code)) {
          await auth.signInWithRedirect(provider);
        } else { toast(friendly(err.code),'error'); console.error(err); }
      }
    };

    // Redirect result
    auth.getRedirectResult().then(async (res)=>{
      if(res?.user){
        await db.collection('users').doc(res.user.uid).set({
          email: res.user.email || null,
          displayName: res.user.displayName || null,
          photoURL: res.user.photoURL || null,
          provider: res.providerId || 'redirect',
          lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        },{merge:true});
      }
    }).catch(err=>{ toast(friendly(err.code),'error'); console.error(err); });

    // State
    let unsubOHIs=null, unsubWhirlwinds=null;
    auth.onAuthStateChanged(async (user)=>{
      if(user){
        headerUserEmail.textContent = user.email || '';
        show(headerUserEmail); show(logoutBtn);
        hide(authView); show(appView);
        await db.collection('users').doc(user.uid).set({
          email:user.email||null, displayName:user.displayName||null, photoURL:user.photoURL||null,
          lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
        },{merge:true});
        bindRealtime(user.uid);
        toast('Bienvenue 👋','success');
      } else {
        show(authView); hide(appView); hide(headerUserEmail); hide(logoutBtn);
        unsubOHIs && unsubOHIs(); unsubWhirlwinds && unsubWhirlwinds();
      }
    });

    logoutBtn.onclick = ()=> auth.signOut();

    // ---------- Realtime bindings ----------
    function pill(priority){
      if(priority==='high') return 'bg-red-100 text-red-700';
      if(priority==='medium') return 'bg-yellow-100 text-yellow-700';
      return 'bg-green-100 text-green-700';
    }
    function labelFor(p){ return p==='high'?'🔴 Haute':p==='medium'?'🟡 Moyenne':'🟢 Basse'; }
    function iconFor(cat){ const m={management:'👥',finance:'💰',operations:'⚙️',strategy:'🎯',hr:'👔',communication:'📢'}; return m[cat]||'🗂️'; }

    function bindRealtime(uid){
      // OHI
      unsubOHIs && unsubOHIs();
      unsubOHIs = db.collection('users').doc(uid).collection('ohis')
        .orderBy('createdAt','desc')
        .onSnapshot((snap)=>{
          const list = $('ohiList'); list.innerHTML='';
          if(snap.empty){ list.innerHTML='<div class="p-4 text-gray-500 border rounded-xl">Aucun OHI pour l’instant.</div>'; return; }
          snap.forEach(doc=>{
            const o=doc.data();
            const el=document.createElement('div');
            el.className='border rounded-xl p-4 bg-white';
            el.innerHTML = `
              <div class="flex justify-between items-start">
                <div>
                  <h4 class="font-semibold">${o.title||''}</h4>
                  <p class="text-sm text-gray-600">${o.description||''}</p>
                  <p class="text-xs text-gray-500 mt-1">Échéance: ${o.deadline||'-'}</p>
                </div>
                <span class="px-2 py-1 text-xs rounded-full ${pill(o.priority)}">
                  ${o.priority==='high'?'Haute':o.priority==='medium'?'Moyenne':'Basse'}
                </span>
              </div>`;
            list.appendChild(el);
          });
        }, (err)=>{ console.error(err); toast('Lecture OHI refusée (règles?)','error'); });

      // Tourbillons
      unsubWhirlwinds && unsubWhirlwinds();
      unsubWhirlwinds = db.collection('users').doc(uid).collection('whirlwinds')
        .orderBy('createdAt','desc')
        .onSnapshot((snap)=>{
          const active=$('activeWhirlwinds'); const done=$('completedWhirlwinds');
          active.innerHTML=''; done.innerHTML='';
          if(snap.empty){
            active.innerHTML='<div class="p-3 text-gray-500 border rounded-xl">Rien en cours.</div>';
            done.innerHTML  ='<div class="p-3 text-gray-500 border rounded-xl">Rien de terminé.</div>';
            return;
          }
          snap.forEach(doc=>{
            const w=doc.data();
            const overdue = w.deadline ? (new Date(w.deadline) < new Date()) : false;
            const card=document.createElement('div');
            card.className=`border-l-4 p-4 rounded-lg ${w.completed?'bg-gray-50 border-gray-300 opacity-80': w.priority==='high'?'bg-red-50 border-red-500': w.priority==='medium'?'bg-yellow-50 border-yellow-500':'bg-green-50 border-green-500'}`;
            card.innerHTML=`
              <div class="flex items-start justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span>${iconFor(w.category)}</span>
                  <h4 class="font-medium text-gray-900">${w.title||''}</h4>
                </div>
                <span class="text-xs ${overdue?'text-red-600':'text-gray-600'}">
                  ${w.deadline ? (overdue ? 'En retard' : w.deadline) : ''}
                </span>
              </div>
              <p class="text-sm text-gray-600 mb-3">${w.notes||''}</p>
              <div class="flex items-center justify-between">
                <span class="text-xs px-2 py-1 rounded-full bg-white/70 border">${labelFor(w.priority)}</span>
                ${w.completed?'':`<button class="text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">✓ Terminé</button>`}
              </div>`;
            if(!w.completed){
              card.querySelector('button')?.addEventListener('click', async ()=>{
                try{
                  await db.collection('users').doc(uid).collection('whirlwinds').doc(doc.id).set({
                    completed:true, completedAt: firebase.firestore.FieldValue.serverTimestamp()
                  },{merge:true});
                  toast('Tourbillon terminé ✅','success');
                }catch(err){ console.error(err); toast('Impossible de terminer (règles?)','error'); }
              });
              active.appendChild(card);
            }else{
              done.appendChild(card);
            }
          });
        }, (err)=>{ console.error(err); toast('Lecture tourbillons refusée (règles?)','error'); });
    }

    // ---------- Ajout OHI (avec erreurs visibles) ----------
    $('addOhiForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const user = auth.currentUser;
      if(!user){ toast('Connecte-toi d’abord','error'); return; }
      const data = {
        title: $('ohiTitle').value.trim(),
        description: $('ohiDescription').value.trim(),
        deadline: $('ohiDeadline').value || null,
        priority: $('ohiPriority').value || 'medium',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      try{
        await db.collection('users').doc(user.uid).collection('ohis').add(data);
        e.target.reset();
        toast('OHI ajouté ✅','success');
      }catch(err){
        console.error('Add OHI error', err);
        toast('Ajout OHI refusé: règles Firestore ?','error');
      }
    });

    // ---------- Coach (préremplir) ----------
    function quickObjective(type){
      const d = {
        business:{title:"Développer mon activité",description:"Augmenter le CA et la clientèle",priority:"high"},
        personal:{title:"Équilibre vie-travail", description:"Mieux répartir mes priorités",    priority:"medium"},
        learning:{title:"Nouvelle compétence",    description:"Apprendre une techno/langue",   priority:"medium"},
        health:  {title:"Forme & énergie",        description:"Routine sport + alimentation",  priority:"high"},
      }[type] || {title:"Nouvel objectif",description:"",priority:"medium"};
      $('ohiTitle').value = d.title;
      $('ohiDescription').value = d.description;
      $('ohiPriority').value = d.priority;
      $('coachMessage').textContent = "Parfait, choisis une date puis clique sur Ajouter ✅";
    }
    window.quickObjective = quickObjective; // accessible depuis onclick

    // ---------- Ajout Tourbillon ----------
    $('addWhirlwindBtn').addEventListener('click', async ()=>{
      const user = auth.currentUser;
      if(!user){ toast('Connecte-toi d’abord','error'); return; }
      const deadline = new Date(); deadline.setMonth(deadline.getMonth()+1);
      try{
        await db.collection('users').doc(user.uid).collection('whirlwinds').add({
          title:"Nouvelle action prioritaire",
          category:"operations",
          priority:"medium",
          deadline: deadline.toISOString().split('T')[0],
          notes:"Détaille l’action, les personnes impliquées et l’impact attendu.",
          completed:false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
        toast('Tourbillon ajouté ✅','success');
      }catch(err){
        console.error('Add Whirlwind error', err);
        toast('Ajout tourbillon refusé: règles Firestore ?','error');
      }
    });
  </script>
</body>
</html>
