<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OHI – Auth + Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#8b5cf6',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 p-6 text-gray-900">

  <!-- === AUTH VIEW === -->
  <div id="authView" class="max-w-md mx-auto bg-white/95 backdrop-blur-lg shadow-2xl rounded-3xl p-8">
    <h1 class="text-2xl font-bold mb-2">🔐 Connexion à OHI</h1>
    <p class="text-sm text-gray-600 mb-6">Identifie-toi pour accéder à ton tableau de bord.</p>

    <div class="grid grid-cols-1 gap-3 mb-6">
      <button id="googleBtn" class="w-full flex items-center justify-center gap-2 bg-white border hover:bg-gray-50 rounded-xl py-3">
        <span>Se connecter avec Google</span>
      </button>
      <button id="microsoftBtn" class="w-full flex items-center justify-center gap-2 bg-white border hover:bg-gray-50 rounded-xl py-3">
        <span>Se connecter avec Microsoft</span>
      </button>
    </div>

    <div class="relative my-6">
      <div class="border-t"></div>
      <span class="absolute -top-3 left-1/2 -translate-x-1/2 bg-white px-3 text-xs text-gray-500">ou avec e-mail</span>
    </div>

    <!-- Tabs -->
    <div class="flex mb-4 rounded-xl bg-gray-100 p-1">
      <button id="tabLogin" class="flex-1 py-2 rounded-lg text-sm font-semibold bg-white">Se connecter</button>
      <button id="tabSignup" class="flex-1 py-2 rounded-lg text-sm font-semibold text-gray-600">Créer un compte</button>
    </div>

    <!-- Login form -->
    <form id="loginForm" class="grid gap-3">
      <input id="loginEmail" type="email" placeholder="Email" required class="border rounded-xl p-3">
      <input id="loginPassword" type="password" placeholder="Mot de passe" required class="border rounded-xl p-3">
      <button type="submit" class="bg-primary hover:bg-blue-700 text-white rounded-xl py-3 font-semibold">Se connecter</button>
    </form>

    <!-- Signup form -->
    <form id="signupForm" class="grid gap-3 hidden mt-4">
      <input id="signupEmail" type="email" placeholder="Email" required class="border rounded-xl p-3">
      <input id="signupPassword" type="password" placeholder="Mot de passe (6+ caractères)" minlength="6" required class="border rounded-xl p-3">
      <button type="submit" class="bg-primary hover:bg-blue-700 text-white rounded-xl py-3 font-semibold">Créer mon compte</button>
    </form>

    <p id="authError" class="text-sm text-red-600 mt-4 hidden"></p>
  </div>

  <!-- === DASHBOARD VIEW === -->
  <div id="appView" class="hidden">
    <div class="max-w-6xl mx-auto bg-white/90 backdrop-blur-lg shadow-2xl rounded-3xl p-8">
      <header class="flex justify-between items-center mb-6">
        <div>
          <h1 class="text-2xl font-bold">📊 Tableau de bord OHI</h1>
          <p id="userEmail" class="text-sm text-gray-600"></p>
        </div>
        <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl">Déconnexion</button>
      </header>

      <!-- Coach + boutons rapides -->
      <section class="bg-white rounded-2xl p-6 shadow-sm mb-8 border-l-4 border-primary">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center shrink-0">
            <svg class="w-6 h-6 text-primary" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"/></svg>
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <h3 class="font-semibold text-gray-900">Coach IA</h3>
              <span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">En ligne</span>
            </div>
            <div id="coachMessage" class="text-gray-700 mb-4">
              Bonjour 👋 ! Commence par définir ton 1er objectif.
            </div>
            <div class="flex flex-wrap gap-2">
              <button onclick="quickObjective('business')" class="px-3 py-1.5 bg-blue-100 text-blue-800 rounded-lg text-sm hover:bg-blue-200">🚀 Business</button>
              <button onclick="quickObjective('personal')" class="px-3 py-1.5 bg-green-100 text-green-800 rounded-lg text-sm hover:bg-green-200">🎯 Personnel</button>
              <button onclick="quickObjective('learning')" class="px-3 py-1.5 bg-purple-100 text-purple-800 rounded-lg text-sm hover:bg-purple-200">📚 Apprentissage</button>
              <button onclick="quickObjective('health')" class="px-3 py-1.5 bg-orange-100 text-orange-800 rounded-lg text-sm hover:bg-orange-200">💪 Santé</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Formulaire OHI -->
      <section class="mb-8">
        <h2 class="text-xl font-semibold mb-4">➕ Ajouter un OHI</h2>
        <form id="addOhiForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input id="title" type="text" placeholder="Titre" required class="border rounded-xl p-3"/>
          <input id="deadline" type="date" required class="border rounded-xl p-3"/>
          <textarea id="description" placeholder="Description" class="border rounded-xl p-3 md:col-span-2"></textarea>
          <select id="priority" class="border rounded-xl p-3">
            <option value="high">Haute</option>
            <option value="medium">Moyenne</option>
            <option value="low">Basse</option>
          </select>
          <button type="submit" class="bg-primary hover:bg-blue-700 text-white rounded-xl py-3">Ajouter</button>
        </form>
      </section>

      <!-- Liste des OHI -->
      <section class="mb-10">
        <h2 class="text-xl font-semibold mb-4">📌 Mes OHI</h2>
        <div id="ohiList" class="space-y-4"></div>
      </section>

      <!-- Tourbillons -->
      <section class="bg-white rounded-2xl p-6 shadow-sm mb-2 border-l-4 border-orange-500">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
              <span>🌪️</span>
            </div>
            <div>
              <h3 class="text-xl font-semibold text-gray-900">Tourbillons du mois</h3>
              <p class="text-sm text-gray-600">Actions importantes à forte dispersion</p>
            </div>
          </div>
          <button id="addWhirlwindBtn" class="bg-orange-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-orange-700">+ Nouveau tourbillon</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h4 class="font-medium text-gray-900 mb-3">En cours</h4>
            <div id="activeWhirlwinds" class="space-y-3"></div>
          </div>
          <div>
            <h4 class="font-medium text-gray-900 mb-3">Terminés</h4>
            <div id="completedWhirlwinds" class="space-y-3"></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Ta config Firebase -->
  <script src="./firebase.js"></script>

  <script>
    // ----- Helpers UI
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove('hidden');
    const hide = (el) => el.classList.add('hidden');

    // ----- Firebase init (depuis firebase.js)
    // firebase.initializeApp({...}) doit déjà être appelé dans firebase.js
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.useDeviceLanguage();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    // ----- AUTH LOGIC
    const authView = $('authView');
    const appView  = $('appView');
    const authError = $('authError');

    // Tabs
    const tabLogin = $('tabLogin');
    const tabSignup = $('tabSignup');
    const loginForm = $('loginForm');
    const signupForm = $('signupForm');

    tabLogin.onclick = () => {
      tabLogin.classList.add('bg-white'); tabLogin.classList.remove('text-gray-600');
      tabSignup.classList.remove('bg-white'); tabSignup.classList.add('text-gray-600');
      signupForm.classList.add('hidden'); loginForm.classList.remove('hidden');
      authError.classList.add('hidden');
    };
    tabSignup.onclick = () => {
      tabSignup.classList.add('bg-white'); tabSignup.classList.remove('text-gray-600');
      tabLogin.classList.remove('bg-white'); tabLogin.classList.add('text-gray-600');
      loginForm.classList.add('hidden'); signupForm.classList.remove('hidden');
      authError.classList.add('hidden');
    };

    function humanizeAuthError(code) {
      const map = {
        'auth/invalid-email': "Adresse e-mail invalide.",
        'auth/missing-password': "Mot de passe requis.",
        'auth/weak-password': "Mot de passe trop faible (6+ caractères).",
        'auth/email-already-in-use': "Un compte existe déjà avec cet e-mail.",
        'auth/user-not-found': "Aucun compte avec cet e-mail.",
        'auth/wrong-password': "Mot de passe incorrect.",
        'auth/invalid-credential': "Identifiants invalides ou expirés.",
        'auth/popup-closed-by-user': "Fenêtre fermée avant la connexion.",
        'auth/operation-not-allowed': "Provider non activé dans Firebase.",
      };
      return map[code] || "Une erreur s'est produite. Réessaie.";
    }

    // Email login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      authError.classList.add('hidden');
      const email = $('loginEmail').value.trim();
      const pass  = $('loginPassword').value;
      try {
        await auth.signInWithEmailAndPassword(email, pass);
      } catch (err) {
        authError.textContent = "Erreur: " + humanizeAuthError(err.code);
        authError.classList.remove('hidden');
      }
    });

    // Email signup
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      authError.classList.add('hidden');
      const email = $('signupEmail').value.trim();
      const pass  = $('signupPassword').value;
      try {
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        // Crée le profil
        await db.collection('users').doc(cred.user.uid).set({
          email,
          provider: 'password',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
        }, { merge: true });
      } catch (err) {
        authError.textContent = "Erreur: " + humanizeAuthError(err.code);
        authError.classList.remove('hidden');
      }
    });

    // Google / Microsoft
    $('googleBtn').onclick = async () => {
      authError.classList.add('hidden');
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const cred = await auth.signInWithPopup(provider);
        await db.collection('users').doc(cred.user.uid).set({
          email: cred.user.email,
          displayName: cred.user.displayName || null,
          photoURL: cred.user.photoURL || null,
          provider: 'google',
          lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        }, { merge: true });
      } catch (err) {
        authError.textContent = "Erreur: " + humanizeAuthError(err.code);
        authError.classList.remove('hidden');
      }
    };

    $('microsoftBtn').onclick = async () => {
      authError.classList.add('hidden');
      const provider = new firebase.auth.OAuthProvider('microsoft.com');
      provider.setCustomParameters({ prompt: 'select_account' });
      try {
        const cred = await auth.signInWithPopup(provider);
        await db.collection('users').doc(cred.user.uid).set({
          email: cred.user.email,
          displayName: cred.user.displayName || null,
          photoURL: cred.user.photoURL || null,
          provider: 'microsoft',
          lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        }, { merge: true });
      } catch (err) {
        authError.textContent = "Erreur: " + humanizeAuthError(err.code);
        authError.classList.remove('hidden');
      }
    };

    // State
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        // Maj profil minimal
        await db.collection('users').doc(user.uid).set({
          email: user.email || null,
          displayName: user.displayName || null,
          photoURL: user.photoURL || null,
          lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
        }, { merge: true });

        $('userEmail').textContent = user.email || '';
        hide(authView);
        show(appView);
        attachDataBindings(user.uid);
      } else {
        show(authView);
        hide(appView);
      }
    });

    // Déconnexion
    $('logoutBtn').onclick = () => auth.signOut();

    // ---------- DASHBOARD DATA (OHI + Tourbillons) ----------
    let unsubOHIs = null;
    let unsubWhirlwinds = null;

    function attachDataBindings(uid) {
      // OHI – live list
      unsubOHIs && unsubOHIs();
      unsubOHIs = db.collection('users').doc(uid).collection('ohis')
        .orderBy('createdAt', 'desc')
        .onSnapshot((snap) => {
          const list = $('ohiList'); list.innerHTML = '';
          if (snap.empty) {
            list.innerHTML = '<div class="p-4 text-gray-500 border rounded-xl">Aucun OHI pour l’instant.</div>';
            return;
          }
          snap.forEach(doc => {
            const o = doc.data();
            const el = document.createElement('div');
            el.className = 'border rounded-xl p-4 bg-white';
            el.innerHTML = `
              <div class="flex justify-between items-start">
                <div>
                  <h4 class="font-semibold">${o.title || ''}</h4>
                  <p class="text-sm text-gray-600">${o.description || ''}</p>
                  <p class="text-xs text-gray-500 mt-1">Échéance: ${o.deadline || '-'}</p>
                </div>
                <span class="px-2 py-1 text-xs rounded-full ${pill(o.priority)}">
                  ${o.priority === 'high' ? 'Haute' : o.priority === 'medium' ? 'Moyenne' : 'Basse'}
                </span>
              </div>
            `;
            list.appendChild(el);
          });
        });

      // Tourbillons – live list
      unsubWhirlwinds && unsubWhirlwinds();
      unsubWhirlwinds = db.collection('users').doc(uid).collection('whirlwinds')
        .orderBy('createdAt', 'desc')
        .onSnapshot((snap) => {
          const active = $('activeWhirlwinds'); active.innerHTML = '';
          const done = $('completedWhirlwinds'); done.innerHTML = '';

          if (snap.empty) {
            active.innerHTML = '<div class="p-3 text-gray-500 border rounded-xl">Rien en cours.</div>';
            done.innerHTML = '<div class="p-3 text-gray-500 border rounded-xl">Rien de terminé.</div>';
            return;
          }

          snap.forEach(doc => {
            const w = doc.data();
            const card = document.createElement('div');
            const overdue = w.deadline ? (new Date(w.deadline) - new Date() < 0) : false;
            card.className = `border-l-4 p-4 rounded-lg ${w.completed ? 'bg-gray-50 border-gray-300 opacity-80' :
              w.priority === 'high' ? 'bg-red-50 border-red-500' :
              w.priority === 'medium' ? 'bg-yellow-50 border-yellow-500' : 'bg-green-50 border-green-500'}`;
            card.innerHTML = `
              <div class="flex items-start justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span>${iconFor(w.category)}</span>
                  <h4 class="font-medium text-gray-900">${w.title || ''}</h4>
                </div>
                <span class="text-xs ${overdue ? 'text-red-600' : 'text-gray-600'}">
                  ${w.deadline ? (overdue ? 'En retard' : w.deadline) : ''}
                </span>
              </div>
              <p class="text-sm text-gray-600 mb-3">${w.notes || ''}</p>
              <div class="flex items-center justify-between">
                <span class="text-xs px-2 py-1 rounded-full bg-white/70 border">${labelFor(w.priority)}</span>
                ${w.completed ? '' : `<button class="text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">✓ Terminé</button>`}
              </div>
            `;
            if (!w.completed) {
              card.querySelector('button')?.addEventListener('click', async () => {
                await db.collection('users').doc(uid).collection('whirlwinds').doc(doc.id).set({
                  completed: true,
                  completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                }, { merge: true });
              });
              active.appendChild(card);
            } else {
              done.appendChild(card);
            }
          });
        });
    }

    function pill(priority) {
      if (priority === 'high') return 'bg-red-100 text-red-700';
      if (priority === 'medium') return 'bg-yellow-100 text-yellow-700';
      return 'bg-green-100 text-green-700';
    }
    function labelFor(p) {
      return p === 'high' ? '🔴 Haute' : p === 'medium' ? '🟡 Moyenne' : '🟢 Basse';
    }
    function iconFor(cat) {
      const map = { management:'👥', finance:'💰', operations:'⚙️', strategy:'🎯', hr:'👔', communication:'📢' };
      return map[cat] || '🗂️';
    }

    // Ajouter un OHI
    $('addOhiForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return;
      const data = {
        title: $('title').value.trim(),
        description: $('description').value.trim(),
        deadline: $('deadline').value || null,
        priority: $('priority').value || 'medium',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await db.collection('users').doc(user.uid).collection('ohis').add(data);
      e.target.reset();
    });

    // Ajout rapide d’objectif via Coach
    function quickObjective(type) {
      const defaults = {
        business: { title: "Développer mon activité", description: "Augmenter le CA et la clientèle", priority: "high" },
        personal: { title: "Équilibre vie-travail", description: "Mieux répartir mes priorités", priority: "medium" },
        learning: { title: "Nouvelle compétence", description: "Apprendre une techno/langue", priority: "medium" },
        health: { title: "Meilleure condition physique", description: "Routine sport + alimentation", priority: "high" },
      };
      const d = defaults[type] || defaults.business;
      $('title').value = d.title;
      $('description').value = d.description;
      $('priority').value = d.priority;
      $('coachMessage').textContent = "Parfait, complète la date puis clique sur Ajouter ✅";
    }

    // Bouton "Nouveau tourbillon"
    $('addWhirlwindBtn').addEventListener('click', async () => {
      const user = auth.currentUser; if (!user) return;
      // Exemple minimal : ajoute un brouillon rapide
      const deadline = new Date(); deadline.setMonth(deadline.getMonth() + 1);
      await db.collection('users').doc(user.uid).collection('whirlwinds').add({
        title: "Nouvelle action prioritaire",
        category: "operations",
        priority: "medium",
        deadline: deadline.toISOString().split('T')[0],
        notes: "Détaille l’action, les personnes impliquées et l’impact attendu.",
        completed: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      });
    });
  </script>
</body>
</html>
