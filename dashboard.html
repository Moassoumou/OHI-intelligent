<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coach Objectifs IA â€“ Tableau de Bord</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#8b5cf6',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444'
          }
        }
      }
    }
  </script>

  <!-- Police -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,.1); }
    .progress-ring { transform: rotate(-90deg); }
    .chat-bubble { animation: slideIn .3s ease-out; }
    @keyframes slideIn { from { opacity:.0; transform: translateY(10px);} to { opacity:1; transform: translateY(0);} }
    .pulse-dot { animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Header -->
  <header class="gradient-bg text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-6">
        <div class="flex items-center space-x-4">
          <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold">Coach Objectifs IA</h1>
            <p class="text-white/80 text-sm">Votre compagnon intelligent pour atteindre vos objectifs</p>
          </div>
        </div>

        <!-- Zone utilisateur + dÃ©connexion -->
        <div class="flex items-center gap-3">
          <div class="hidden md:flex items-center space-x-2 bg-white/20 rounded-lg px-3 py-2">
            <div class="w-2 h-2 bg-green-400 rounded-full pulse-dot"></div>
            <span class="text-sm">Coach actif</span>
          </div>
          <span id="userEmail" class="text-sm opacity-90"></span>
          <button id="logoutBtn"
                  class="w-auto px-3 h-10 bg-white/20 rounded-lg flex items-center justify-center hover:bg-white/30 transition-all">
            DÃ©connexion
          </button>
          <button onclick="toggleCoach()"
                  class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center hover:bg-white/30 transition-all">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Coach IA Chat -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div id="coachPanel" class="bg-white rounded-2xl p-6 shadow-sm mb-8 border-l-4 border-primary">
      <div class="flex items-start space-x-4">
        <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center flex-shrink-0">
          <svg class="w-6 h-6 text-primary" fill="currentColor" viewBox="0 0 20 20">
            <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"/>
          </svg>
        </div>
        <div class="flex-1">
          <div class="flex items-center space-x-2 mb-2">
            <h3 class="font-semibold text-gray-900">Coach IA</h3>
            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">En ligne</span>
          </div>
          <div id="coachMessage" class="text-gray-700 mb-4">
            Bonjour ! ğŸ‘‹ Je suis votre coach personnel. CommenÃ§ons par dÃ©finir votre premier objectif. Que souhaitez-vous accomplir ?
          </div>
          <div class="flex flex-wrap gap-2">
            <button onclick="quickObjective('business')" class="px-4 py-2 bg-blue-100 text-blue-800 rounded-lg text-sm hover:bg-blue-200 transition-colors">ğŸš€ Objectif Business</button>
            <button onclick="quickObjective('personal')" class="px-4 py-2 bg-green-100 text-green-800 rounded-lg text-sm hover:bg-green-200 transition-colors">ğŸ¯ Objectif Personnel</button>
            <button onclick="quickObjective('learning')" class="px-4 py-2 bg-purple-100 text-purple-800 rounded-lg text-sm hover:bg-purple-200 transition-colors">ğŸ“š Apprentissage</button>
            <button onclick="quickObjective('health')" class="px-4 py-2 bg-orange-100 text-orange-800 rounded-lg text-sm hover:bg-orange-200 transition-colors">ğŸ’ª SantÃ© & Bien-Ãªtre</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Objectifs + Progression -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
      <div class="lg:col-span-2">
        <div class="bg-white rounded-2xl p-6 shadow-sm">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-900">Mes Objectifs</h3>
            <button onclick="addObjective()" class="bg-primary text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-colors">+ Nouvel Objectif</button>
          </div>
          <div id="objectivesList" class="space-y-4"></div>
        </div>
      </div>

      <div class="bg-white rounded-2xl p-6 shadow-sm">
        <h3 class="text-xl font-semibold text-gray-900 mb-6">Progression Globale</h3>
        <div class="flex items-center justify-center mb-6">
          <div class="relative w-32 h-32">
            <svg class="w-32 h-32 progress-ring">
              <circle cx="64" cy="64" r="56" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
              <circle id="progressCircle" cx="64" cy="64" r="56" stroke="#3b82f6" stroke-width="8" fill="none"
                      stroke-dasharray="351.86" stroke-dashoffset="351.86" stroke-linecap="round"></circle>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
              <span id="globalProgress" class="text-2xl font-bold text-gray-900">0%</span>
            </div>
          </div>
        </div>
        <div class="space-y-3">
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Objectifs complÃ©tÃ©s</span>
            <span id="completedCount" class="font-medium">0/0</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Streak actuel</span>
            <span id="currentStreak" class="font-medium text-green-600">0 jours</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Prochaine Ã©chÃ©ance</span>
            <span id="nextDeadline" class="font-medium text-orange-600">-</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Tourbillons -->
    <div class="bg-white rounded-2xl p-6 shadow-sm mb-8 border-l-4 border-orange-500">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
            <svg class="w-6 h-6 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div>
            <h3 class="text-xl font-semibold text-gray-900">ğŸŒªï¸ Tourbillons du Mois</h3>
            <p class="text-sm text-gray-600">Actions importantes pour ne pas se disperser</p>
          </div>
        </div>
        <div class="flex space-x-2">
          <button onclick="addWhirlwind()" class="bg-orange-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-orange-700 transition-colors">+ Nouveau Tourbillon</button>
          <button onclick="toggleManagerMode()" id="managerModeBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300 transition-colors">ğŸ‘” Mode Responsable</button>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Actions en cours</h4>
          <div id="activeWhirlwinds" class="space-y-3"></div>
        </div>
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Actions terminÃ©es</h4>
          <div id="completedWhirlwinds" class="space-y-3"></div>
        </div>
      </div>
    </div>

    <!-- Livrables & Actions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <div class="bg-white rounded-2xl p-6 shadow-sm">
        <h3 class="text-xl font-semibold text-gray-900 mb-6">Livrables GÃ©nÃ©rÃ©s</h3>
        <div id="deliverablesList" class="space-y-3">
          <div class="text-center text-gray-500 py-8">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v12h8V4H6z" clip-rule="evenodd"/>
            </svg>
            <p>Aucun livrable gÃ©nÃ©rÃ© pour le moment</p>
            <p class="text-sm">DÃ©finissez un objectif pour commencer</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl p-6 shadow-sm">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-semibold text-gray-900">Actions RecommandÃ©es</h3>
          <button onclick="refreshRecommendations()" class="text-primary hover:text-blue-600 text-sm">ğŸ”„ Actualiser</button>
        </div>
        <div id="actionsList" class="space-y-3">
          <div class="text-center text-gray-500 py-8">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
            </svg>
            <p>Aucune action recommandÃ©e</p>
            <p class="text-sm">Le coach analysera vos objectifs</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Insights -->
    <div class="bg-white rounded-2xl p-6 shadow-sm">
      <h3 class="text-xl font-semibold text-gray-900 mb-6">Insights & Statistiques</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="text-center">
          <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"/><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"/></svg>
          </div>
          <p class="text-2xl font-bold text-gray-900" id="totalObjectives">0</p>
          <p class="text-sm text-gray-600">Objectifs crÃ©Ã©s</p>
        </div>
        <div class="text-center">
          <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
          </div>
          <p class="text-2xl font-bold text-gray-900" id="completedObjectives">0</p>
          <p class="text-sm text-gray-600">Objectifs atteints</p>
        </div>
        <div class="text-center">
          <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <svg class="w-8 h-8 text-purple-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd"/></svg>
          </div>
          <p class="text-2xl font-bold text-gray-900" id="averageProgress">0%</p>
          <p class="text-sm text-gray-600">Progression moyenne</p>
        </div>
        <div class="text-center">
          <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <svg class="w-8 h-8 text-orange-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/></svg>
          </div>
          <p class="text-2xl font-bold text-gray-900" id="daysActive">0</p>
          <p class="text-sm text-gray-600">Jours actifs</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nouvel Objectif -->
  <div id="objectiveModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
      <h3 class="text-xl font-semibold text-gray-900 mb-6">CrÃ©er un Nouvel Objectif</h3>
      <form id="objectiveForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Titre de l'objectif</label>
          <input type="text" id="objectiveTitle" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Ex: Lancer mon entreprise">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">CatÃ©gorie</label>
          <select id="objectiveCategory" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
            <option value="business">ğŸš€ Business</option>
            <option value="personal">ğŸ¯ Personnel</option>
            <option value="learning">ğŸ“š Apprentissage</option>
            <option value="health">ğŸ’ª SantÃ©</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Date limite</label>
          <input type="date" id="objectiveDeadline" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Description (optionnel)</label>
          <textarea id="objectiveDescription" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="DÃ©crivez votre objectif..."></textarea>
        </div>
        <div class="flex space-x-3 pt-4">
          <button type="button" onclick="closeModal()" class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Annuler</button>
          <button type="submit" class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">CrÃ©er</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Nouveau Tourbillon -->
  <div id="whirlwindModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-lg w-full mx-4">
      <h3 class="text-xl font-semibold text-gray-900 mb-6">ğŸŒªï¸ Nouveau Tourbillon</h3>
      <form id="whirlwindForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Action Ã  mener</label>
          <input type="text" id="whirlwindTitle" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Ex: Ã‰tablir la masse salariale">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">CatÃ©gorie</label>
          <select id="whirlwindCategory" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
            <option value="management">ğŸ‘¥ Management</option>
            <option value="finance">ğŸ’° Finance</option>
            <option value="operations">âš™ï¸ OpÃ©rations</option>
            <option value="strategy">ğŸ¯ StratÃ©gie</option>
            <option value="hr">ğŸ‘” RH</option>
            <option value="communication">ğŸ“¢ Communication</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">PrioritÃ©</label>
          <select id="whirlwindPriority" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
            <option value="high">ğŸ”´ Haute</option>
            <option value="medium">ğŸŸ¡ Moyenne</option>
            <option value="low">ğŸŸ¢ Basse</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Ã‰chÃ©ance</label>
          <input type="date" id="whirlwindDeadline" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
          <textarea id="whirlwindNotes" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="DÃ©tails, personnes impliquÃ©es, ressources nÃ©cessaires..."></textarea>
        </div>
        <div class="flex space-x-3 pt-4">
          <button type="button" onclick="closeWhirlwindModal()" class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Annuler</button>
          <button type="submit" class="flex-1 bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">CrÃ©er</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- Ton fichier d'init Firebase (firebase.initializeApp(...)) -->
  <script src="./firebase.js"></script>

  <script>
    /* =========================
       Ã‰TAT / PERSISTENCE LOCALE
       ========================= */
    let objectives = [];
    let whirlwinds = [];
    let coachVisible = true;
    let managerMode = false;

    const STORAGE_KEY = 'coach_ohi_v1';
    function saveToStorage() {
      try {
        const payload = { objectives, whirlwinds, ts: Date.now() };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      } catch (e) {}
    }
    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const data = JSON.parse(raw);
        objectives = Array.isArray(data.objectives) ? data.objectives : [];
        whirlwinds = Array.isArray(data.whirlwinds) ? data.whirlwinds : [];
        return true;
      } catch (e) { return false; }
    }

    /* =========================
       COACH â€“ MESSAGES & UI
       ========================= */
    const coachMessages = {
      welcome: "Bonjour ! ğŸ‘‹ Je suis votre coach personnel. CommenÃ§ons par dÃ©finir votre premier objectif. Que souhaitez-vous accomplir ?",
      firstObjective: "Excellent choix ! ğŸ¯ Je vais gÃ©nÃ©rer un plan d'action personnalisÃ© pour vous aider Ã  atteindre cet objectif. Voici mes recommandations :",
      progress: "Bravo pour vos progrÃ¨s ! ğŸŒŸ Continuez sur cette lancÃ©e. Voici ce que je recommande pour la suite :",
      motivation: "Je remarque que vous n'avez pas mis Ã  jour vos objectifs rÃ©cemment. ğŸ’ª Prenons quelques minutes pour faire le point ensemble !",
      celebration: "FÃ©licitations ! ğŸ‰ Vous avez atteint un objectif important. ÃŠtes-vous prÃªt pour le prochain dÃ©fi ?"
    };

    function toggleCoach() {
      const panel = document.getElementById('coachPanel');
      coachVisible = !coachVisible;
      panel.style.display = coachVisible ? 'block' : 'none';
    }
    function updateCoachMessage(type, customMessage = null) {
      const messageElement = document.getElementById('coachMessage');
      const message = customMessage || coachMessages[type];
      messageElement.innerHTML = message;
      messageElement.classList.add('chat-bubble');
      setTimeout(() => messageElement.classList.remove('chat-bubble'), 350);
    }

    function quickObjective(type) {
      const templates = {
        business: { title: "DÃ©velopper mon activitÃ©", category: "business", description: "Augmenter mon chiffre d'affaires et dÃ©velopper ma clientÃ¨le" },
        personal: { title: "AmÃ©liorer mon Ã©quilibre vie-travail", category: "personal", description: "Consacrer plus de temps Ã  ma famille et mes loisirs" },
        learning: { title: "Apprendre une nouvelle compÃ©tence", category: "learning", description: "MaÃ®triser une nouvelle technologie ou langue" },
        health: { title: "AmÃ©liorer ma condition physique", category: "health", description: "Adopter une routine d'exercice rÃ©guliÃ¨re" }
      };
      const template = templates[type];
      document.getElementById('objectiveTitle').value = template.title;
      document.getElementById('objectiveCategory').value = template.category;
      document.getElementById('objectiveDescription').value = template.description;

      const deadline = new Date(); deadline.setMonth(deadline.getMonth() + 3);
      document.getElementById('objectiveDeadline').value = deadline.toISOString().split('T')[0];

      document.getElementById('objectiveModal').classList.remove('hidden');
      document.getElementById('objectiveModal').classList.add('flex');
    }

    function addObjective() {
      document.getElementById('objectiveModal').classList.remove('hidden');
      document.getElementById('objectiveModal').classList.add('flex');
    }
    function closeModal() {
      document.getElementById('objectiveModal').classList.add('hidden');
      document.getElementById('objectiveModal').classList.remove('flex');
      document.getElementById('objectiveForm').reset();
    }

    /* =========================
       GÃ‰NÃ‰RATION LIVRABLES/ACTIONS
       ========================= */
    function generateDeliverables(objective) {
      const deliverables = {
        business: ["Plan d'affaires dÃ©taillÃ©","StratÃ©gie marketing","Analyse de la concurrence","PrÃ©visions financiÃ¨res"],
        personal: ["Planning hebdomadaire optimisÃ©","Liste de prioritÃ©s personnelles","Routine de bien-Ãªtre","Objectifs de dÃ©veloppement personnel"],
        learning: ["Programme d'apprentissage structurÃ©","Ressources et supports de cours","Planning de rÃ©visions","Projets pratiques"],
        health: ["Programme d'entraÃ®nement personnalisÃ©","Plan nutritionnel Ã©quilibrÃ©","Suivi des progrÃ¨s","Objectifs hebdomadaires"]
      };
      return deliverables[objective.category] || ["Plan d'action personnalisÃ©"];
    }

    function generateActions(objective) {
      const simpleActions = {
        business: [
          { action: "CrÃ©er un plan d'affaires simple", description: "DÃ©finissez votre idÃ©e, votre marchÃ© et vos revenus",
            steps: ["DÃ©crire votre idÃ©e en une phrase","Identifier 3 clients potentiels","Calculer vos coÃ»ts de base","DÃ©finir votre prix de vente"],
            progress: 0, advancedResources: ["ğŸ“– Business Model Canvas - Alexander Osterwalder","ğŸ“š The Lean Startup - Eric Ries","ğŸ“ Coursera: Entrepreneurship","ğŸŒ SCORE.org - Mentoring"]
          },
          { action: "Analyser la concurrence", description: "Ã‰tudiez 5 concurrents directs pour vous positionner",
            steps: ["Lister 5 concurrents principaux","Analyser leurs prix et services","Identifier leurs points faibles","DÃ©finir votre avantage unique"],
            progress: 0, advancedResources: ["ğŸ“– Blue Ocean Strategy","ğŸ” SEMrush","ğŸ“Š SimilarWeb","ğŸ¯ Five Forces"]
          },
          { action: "DÃ©finir votre clientÃ¨le cible", description: "CrÃ©ez le profil de votre client idÃ©al",
            steps: ["DÃ©finir l'Ã¢ge et le sexe","Identifier les besoins principaux","Localiser oÃ¹ ils se trouvent","Comprendre leur budget"],
            progress: 0, advancedResources: ["ğŸ“– The Mom Test","ğŸ¯ Persona Templates","ğŸ“Š Google Analytics","ğŸ”¬ Jobs-to-be-Done"]
          }
        ],
        personal: [
          { action: "Organiser votre temps quotidien", description: "CrÃ©ez une routine qui fonctionne pour vous",
            steps: ["Noter vos activitÃ©s actuelles","Identifier 3 prioritÃ©s quotidiennes","Bloquer du temps pour chaque prioritÃ©","Ã‰liminer 2 activitÃ©s non essentielles"],
            progress: 0, advancedResources: ["ğŸ“– Getting Things Done","â° Pomodoro","ğŸ“± Todoist/Notion/Trello","ğŸ“ Time Management"]
          },
          { action: "AmÃ©liorer votre Ã©quilibre vie-travail", description: "DÃ©finissez des limites claires entre travail et vie privÃ©e",
            steps: ["Fixer des heures de travail prÃ©cises","CrÃ©er un espace de travail dÃ©diÃ©","Planifier du temps pour vos loisirs","Apprendre Ã  dire non"],
            progress: 0, advancedResources: ["ğŸ“– 4-Hour Workweek","ğŸ§˜ Mindfulness at Work","ğŸ“± Headspace/Calm","ğŸ¯ Boundary Setting"]
          },
          { action: "DÃ©velopper une habitude positive", description: "IntÃ©grez une nouvelle habitude bÃ©nÃ©fique",
            steps: ["Choisir une habitude simple","La lier Ã  une habitude existante","Commencer par 2 minutes/jour","Suivre vos progrÃ¨s"],
            progress: 0, advancedResources: ["ğŸ“– Atomic Habits","ğŸ§  Power of Habit","ğŸ“± Habitica/Streaks","ğŸ“ Behavior Change"]
          }
        ],
        learning: [
          { action: "Apprendre une nouvelle compÃ©tence", description: "MaÃ®trisez les bases en 30 jours",
            steps: ["Choisir une compÃ©tence","Trouver 3 ressources","Pratiquer 30 min/jour","CrÃ©er un projet"],
            progress: 0, advancedResources: ["ğŸ“– Peak (Ericsson)","ğŸ“ Coursera/Udemy","ğŸ§  Technique Feynman","ğŸ“š Anki (SRS)"]
          },
          { action: "Lire plus efficacement", description: "Vitesse & comprÃ©hension",
            steps: ["Mesurer votre vitesse","RÃ©duire la subvocalisation","Utiliser un guide visuel","Pratiquer 15 min/jour"],
            progress: 0, advancedResources: ["ğŸ“– How to Read a Book","âš¡ Speed Reading","ğŸ“± Spreeder/ReadMe","ğŸ¯ SQ3R"]
          },
          { action: "MÃ©moriser plus facilement", description: "Techniques de rÃ©tention",
            steps: ["Associations visuelles","RÃ©pÃ©tition espacÃ©e","Enseigner ce que vous apprenez","Tests rÃ©guliers"],
            progress: 0, advancedResources: ["ğŸ“– Moonwalking w/ Einstein","ğŸ§  Memory Palace","ğŸ“± Anki/Quizlet","ğŸ“ Learning How to Learn"]
          }
        ],
        health: [
          { action: "Bouger plus au quotidien", description: "Ajoutez du mouvement",
            steps: ["Marcher 10 min aprÃ¨s repas","Prendre les escaliers","Ã‰tirements chaque heure","3 sÃ©ances/semaine"],
            progress: 0, advancedResources: ["ğŸ“– Spark (Ratey)","ğŸ’ª 7 Minute Workout","ğŸƒ C25K","ğŸ¯ HIIT"]
          },
          { action: "AmÃ©liorer votre alimentation", description: "Habitudes saines",
            steps: ["Verre d'eau avant repas","Des lÃ©gumes Ã  chaque repas","RÃ©duire portions 20%","Meal prep"],
            progress: 0, advancedResources: ["ğŸ“– How Not to Die","ğŸ¥— MÃ©diterranÃ©enne","ğŸ“± MyFitnessPal","ğŸ“ edX Nutrition"]
          },
          { action: "Mieux dormir", description: "Sommeil optimal",
            steps: ["Heure de coucher fixe","Sans Ã©cran 1h avant","Chambre fraÃ®che & sombre","Routine de relaxation"],
            progress: 0, advancedResources: ["ğŸ“– Why We Sleep","ğŸ˜´ Sleep Hygiene","ğŸ“± Sleep Cycle","ğŸŒ™ Rythme circadien"]
          }
        ]
      };
      return simpleActions[objective.category] || [{
        action: "DÃ©finir un plan d'action",
        description: "CrÃ©ez un plan simple pour atteindre votre objectif",
        steps: ["DÃ©finir l'objectif prÃ©cisÃ©ment","Lister les Ã©tapes","Fixer des Ã©chÃ©ances","Commencer par la premiÃ¨re Ã©tape"],
        progress: 0, advancedResources: ["ğŸ“– SMART","ğŸ¯ OKR","ğŸ“Š PM Basics","ğŸ”„ Agile"]
      }];
    }

    /* =========================
       OBJECTIFS â€“ FORM / RENDER
       ========================= */
    document.getElementById('objectiveForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const objective = {
        id: Date.now(),
        title: document.getElementById('objectiveTitle').value,
        category: document.getElementById('objectiveCategory').value,
        deadline: document.getElementById('objectiveDeadline').value,
        description: document.getElementById('objectiveDescription').value,
        progress: 0, completed: false, createdAt: new Date(),
        deliverables: [], actions: []
      };
      objective.deliverables = generateDeliverables(objective);
      objective.actions = generateActions(objective);

      objectives.push(objective);
      saveToStorage();

      renderObjectives();
      renderDeliverables();
      renderActions();
      updateStats();
      closeModal();

      if (objectives.length === 1) updateCoachMessage('firstObjective');
      else updateCoachMessage('progress');
    });

    function renderObjectives() {
      const container = document.getElementById('objectivesList');
      if (objectives.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p>Aucun objectif dÃ©fini</p>
            <p class="text-sm">CrÃ©ez votre premier objectif pour commencer</p>
          </div>`;
        return;
      }
      container.innerHTML = objectives.map(obj => {
        const categoryIcons = { business: 'ğŸš€', personal: 'ğŸ¯', learning: 'ğŸ“š', health: 'ğŸ’ª' };
        const daysLeft = Math.ceil((new Date(obj.deadline) - new Date()) / (1000*60*60*24));
        const isOverdue = daysLeft < 0;
        return `
          <div class="border border-gray-200 rounded-xl p-4 card-hover">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-start space-x-3">
                <span class="text-2xl">${categoryIcons[obj.category] || 'ğŸ¯'}</span>
                <div>
                  <h4 class="font-semibold text-gray-900">${obj.title}</h4>
                  <p class="text-sm text-gray-600">${obj.description || ''}</p>
                </div>
              </div>
              <div class="text-right">
                <span class="text-sm ${isOverdue ? 'text-red-600' : 'text-gray-600'}">
                  ${isOverdue ? `${Math.abs(daysLeft)} jours de retard` : `${daysLeft} jours restants`}
                </span>
              </div>
            </div>
            <div class="mb-3">
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">Progression</span>
                <span class="font-medium">${obj.progress}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-primary h-2 rounded-full transition-all duration-300" style="width:${obj.progress}%"></div>
              </div>
            </div>
            <div class="flex space-x-2">
              <button onclick="updateProgress(${obj.id}, -10)" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm">-10%</button>
              <button onclick="updateProgress(${obj.id}, 10)" class="px-3 py-1 bg-primary text-white hover:bg-blue-600 rounded text-sm">+10%</button>
              <button onclick="completeObjective(${obj.id})" class="px-3 py-1 bg-green-600 text-white hover:bg-green-700 rounded text-sm">TerminÃ©</button>
              <button onclick="deleteObjective(${obj.id})" class="px-3 py-1 bg-red-100 text-red-600 hover:bg-red-200 rounded text-sm">Supprimer</button>
            </div>
          </div>`;
      }).join('');
    }

    function renderDeliverables() {
      const container = document.getElementById('deliverablesList');
      if (objectives.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v12h8V4H6z" clip-rule="evenodd"/>
            </svg>
            <p>Aucun livrable gÃ©nÃ©rÃ©</p>
            <p class="text-sm">CrÃ©ez un objectif pour voir les livrables</p>
          </div>`;
        return;
      }
      container.innerHTML = objectives.map(obj => `
        <div class="mb-4">
          <h4 class="font-medium text-gray-900 mb-2">${obj.title}</h4>
          <div class="space-y-2">
            ${obj.deliverables.map(del => `
              <div class="flex items-center space-x-3 p-2 bg-gray-50 rounded-lg">
                <svg class="w-4 h-4 text-primary" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v12h8V4H6z" clip-rule="evenodd"/>
                </svg>
                <span class="text-sm text-gray-700">${del}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    function renderActions() {
      const container = document.getElementById('actionsList');
      if (objectives.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
            </svg>
            <p>Aucune action recommandÃ©e</p>
            <p class="text-sm">Le coach analysera vos objectifs</p>
          </div>`;
        return;
      }
      const latest = objectives[objectives.length - 1];
      container.innerHTML = `
        <div class="space-y-4">
          ${latest.actions.map((a, index) => `
            <div class="border border-gray-200 rounded-lg p-4 bg-gradient-to-r from-blue-50 to-indigo-50">
              <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">${index+1}</div>
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-900 mb-1">${a.action}</h4>
                  <p class="text-sm text-gray-600 mb-3">${a.description}</p>
                  <div class="mb-3">
                    <div class="flex justify-between text-xs mb-1">
                      <span class="text-gray-600">Progression</span>
                      <span class="font-medium">${a.progress}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                      <div class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width:${a.progress}%"></div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <h5 class="text-xs font-medium text-gray-900 mb-2">Ã‰tapes Ã  suivre :</h5>
                    <div class="space-y-1">
                      ${a.steps.map((step, si) => `
                        <label class="flex items-start space-x-2 text-xs text-gray-700 cursor-pointer">
                          <input type="checkbox" onchange="updateActionProgress(${index}, ${si})" class="mt-1 w-3 h-3 text-green-600 rounded">
                          <span>${step}</span>
                        </label>
                      `).join('')}
                    </div>
                  </div>
                  <div class="mb-3">
                    <button onclick="toggleAdvancedResources(${index})" class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full hover:bg-purple-200 transition-colors">
                      ğŸ“š Ressources pour aller plus loin
                    </button>
                    <div id="advancedResources${index}" class="hidden mt-2 bg-white rounded-lg p-3 border border-purple-200">
                      <h5 class="font-medium text-gray-900 mb-2 text-xs">Pour approfondir :</h5>
                      <div class="space-y-1 text-xs text-gray-700">
                        ${a.advancedResources.map(r => `
                          <div class="flex items-start space-x-2">
                            <span class="text-purple-600">â€¢</span><span>${r}</span>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Action recommandÃ©e</span>
                    <button onclick="markActionCompleted(${index})" class="text-xs text-primary hover:text-blue-600 font-medium">âœ“ Action terminÃ©e</button>
                  </div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>`;
    }

    function updateActionProgress(actionIndex, stepIndex) {
      const latestObjective = objectives[objectives.length - 1];
      const action = latestObjective.actions[actionIndex];
      // recompute based on checkboxes visible (ids are dynamic by index)
      // simpler: incrementally compute with count of checked in DOM for that action
      const boxes = Array.from(document.querySelectorAll('#actionsList input[type="checkbox"]'))
        .filter(el => el.onchange && el.getAttribute('onchange').startsWith(`updateActionProgress(${actionIndex},`));
      const checked = boxes.filter(b => b.checked).length;
      action.progress = Math.round((checked / action.steps.length) * 100);
      saveToStorage();
      renderActions();
    }

    function toggleAdvancedResources(index) {
      const el = document.getElementById(`advancedResources${index}`);
      el.classList.toggle('hidden');
    }
    function markActionCompleted(actionIndex) {
      const latestObjective = objectives[objectives.length - 1];
      const action = latestObjective.actions[actionIndex];
      action.progress = 100;
      saveToStorage();
      renderActions();
      updateCoachMessage('celebration', 'ğŸ‰ Excellent travail ! Vous avez terminÃ© cette action. Continuez sur cette lancÃ©e !');
    }

    function updateProgress(id, change) {
      const o = objectives.find(x => x.id === id);
      if (!o) return;
      o.progress = Math.max(0, Math.min(100, o.progress + change));
      if (o.progress === 100) { o.completed = true; updateCoachMessage('celebration'); }
      saveToStorage();
      renderObjectives();
      updateStats();
    }
    function completeObjective(id) {
      const o = objectives.find(x => x.id === id);
      if (!o) return;
      o.progress = 100; o.completed = true;
      saveToStorage();
      renderObjectives();
      updateStats();
      updateCoachMessage('celebration');
    }
    function deleteObjective(id) {
      objectives = objectives.filter(x => x.id !== id);
      saveToStorage();
      renderObjectives();
      renderDeliverables();
      renderActions();
      updateStats();
    }

    function updateStats() {
      const total = objectives.length;
      const completed = objectives.filter(o => o.completed).length;
      const avg = total ? Math.round(objectives.reduce((s,o) => s + o.progress, 0)/total) : 0;

      document.getElementById('totalObjectives').textContent = total;
      document.getElementById('completedObjectives').textContent = completed;
      document.getElementById('completedCount').textContent = `${completed}/${total}`;
      document.getElementById('averageProgress').textContent = `${avg}%`;
      document.getElementById('globalProgress').textContent = `${avg}%`;

      const circle = document.getElementById('progressCircle');
      const circumference = 2 * Math.PI * 56;
      circle.style.strokeDashoffset = (circumference - (avg/100) * circumference);

      document.getElementById('daysActive').textContent = Math.max(1, total * 7);
      document.getElementById('currentStreak').textContent = `${Math.min(total * 3, 30)} jours`;

      if (objectives.length > 0) {
        const next = objectives.filter(o => !o.completed).sort((a,b) => new Date(a.deadline)-new Date(b.deadline))[0];
        if (next) {
          const days = Math.ceil((new Date(next.deadline) - new Date()) / (1000*60*60*24));
          document.getElementById('nextDeadline').textContent = `${days} jours`;
        } else {
          document.getElementById('nextDeadline').textContent = `-`;
        }
      } else {
        document.getElementById('nextDeadline').textContent = `-`;
      }
    }

    /* =========================
       TOURBILLONS â€“ FORM / RENDER
       ========================= */
    function addWhirlwind() {
      document.getElementById('whirlwindModal').classList.remove('hidden');
      document.getElementById('whirlwindModal').classList.add('flex');
      const d = new Date(); d.setMonth(d.getMonth() + 1);
      document.getElementById('whirlwindDeadline').value = d.toISOString().split('T')[0];
    }
    function closeWhirlwindModal() {
      document.getElementById('whirlwindModal').classList.add('hidden');
      document.getElementById('whirlwindModal').classList.remove('flex');
      document.getElementById('whirlwindForm').reset();
    }
    function toggleManagerMode() {
      managerMode = !managerMode;
      const btn = document.getElementById('managerModeBtn');
      if (managerMode) {
        btn.textContent = 'ğŸ‘¤ Mode Utilisateur';
        btn.classList.remove('bg-gray-200','text-gray-700');
        btn.classList.add('bg-orange-600','text-white');
        updateCoachMessage('motivation','ğŸ‘” Mode Responsable activÃ© ! Vous pouvez maintenant suggÃ©rer des actions futures Ã  votre Ã©quipe.');
      } else {
        btn.textContent = 'ğŸ‘” Mode Responsable';
        btn.classList.remove('bg-orange-600','text-white');
        btn.classList.add('bg-gray-200','text-gray-700');
        updateCoachMessage('motivation','ğŸ‘¤ Retour au mode utilisateur. Concentrez-vous sur vos objectifs personnels.');
      }
    }
    function generateManagerSuggestions() {
      const list = [
        { title: "RÃ©vision des processus qualitÃ©", category: "operations", priority: "high", notes: "Audit des procÃ©dures actuelles et identification des amÃ©liorations possibles" },
        { title: "Formation Ã©quipe sur nouvelles technologies", category: "hr", priority: "medium", notes: "Planifier sessions de formation pour maintenir la compÃ©titivitÃ©" },
        { title: "Analyse des coÃ»ts opÃ©rationnels", category: "finance", priority: "high", notes: "Identifier les postes de dÃ©penses optimisables" },
        { title: "RÃ©union stratÃ©gique trimestrielle", category: "strategy", priority: "medium", notes: "Faire le point sur les objectifs et ajuster la stratÃ©gie" }
      ];
      return list[Math.floor(Math.random()*list.length)];
    }
    document.getElementById('whirlwindForm').addEventListener('submit', function(e){
      e.preventDefault();
      const w = {
        id: Date.now(),
        title: document.getElementById('whirlwindTitle').value,
        category: document.getElementById('whirlwindCategory').value,
        priority: document.getElementById('whirlwindPriority').value,
        deadline: document.getElementById('whirlwindDeadline').value,
        notes: document.getElementById('whirlwindNotes').value,
        completed: false, createdAt: new Date(),
        createdBy: managerMode ? 'manager' : 'user'
      };
      whirlwinds.push(w);
      saveToStorage();
      renderWhirlwinds();
      closeWhirlwindModal();
      updateCoachMessage('motivation', managerMode
        ? 'ğŸ‘” Action ajoutÃ©e avec succÃ¨s ! Votre Ã©quipe sera notifiÃ©e de cette nouvelle prioritÃ©.'
        : 'ğŸŒªï¸ Nouveau tourbillon ajoutÃ© ! Gardez le focus sur cette action pour ne pas vous disperser.');
    });

    function renderWhirlwinds() {
      const activeC = document.getElementById('activeWhirlwinds');
      const completedC = document.getElementById('completedWhirlwinds');
      const active = whirlwinds.filter(w => !w.completed);
      const done = whirlwinds.filter(w => w.completed);

      if (active.length === 0) {
        activeC.innerHTML = `<div class="text-center text-gray-500 py-4"><p class="text-sm">Aucune action en cours</p></div>`;
      } else {
        activeC.innerHTML = active.map(w => {
          const icons = { management:'ğŸ‘¥', finance:'ğŸ’°', operations:'âš™ï¸', strategy:'ğŸ¯', hr:'ğŸ‘”', communication:'ğŸ“¢' };
          const priorityColors = { high:'border-red-500 bg-red-50', medium:'border-yellow-500 bg-yellow-50', low:'border-green-500 bg-green-50' };
          const priorityLabels = { high:'ğŸ”´ Haute', medium:'ğŸŸ¡ Moyenne', low:'ğŸŸ¢ Basse' };
          const daysLeft = Math.ceil((new Date(w.deadline) - new Date())/(1000*60*60*24));
          const isOverdue = daysLeft < 0;
          return `
            <div class="border-l-4 ${priorityColors[w.priority]} p-4 rounded-lg">
              <div class="flex items-start justify-between mb-2">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">${icons[w.category] || 'âš™ï¸'}</span>
                  <h4 class="font-medium text-gray-900">${w.title}</h4>
                  ${w.createdBy === 'manager' ? '<span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full">ğŸ‘” Responsable</span>' : ''}
                </div>
                <span class="text-xs ${isOverdue ? 'text-red-600' : 'text-gray-600'}">
                  ${isOverdue ? `${Math.abs(daysLeft)}j retard` : `${daysLeft}j restants`}
                </span>
              </div>
              <p class="text-sm text-gray-600 mb-3">${w.notes || ''}</p>
              <div class="flex items-center justify-between">
                <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700">${priorityLabels[w.priority]}</span>
                <div class="space-x-2">
                  <button onclick="completeWhirlwind(${w.id})" class="text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">âœ“ TerminÃ©</button>
                  <button onclick="deleteWhirlwind(${w.id})" class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded hover:bg-red-200">Supprimer</button>
                </div>
              </div>
            </div>`;
        }).join('');
      }

      if (done.length === 0) {
        completedC.innerHTML = `<div class="text-center text-gray-500 py-4"><p class="text-sm">Aucune action terminÃ©e</p></div>`;
      } else {
        completedC.innerHTML = done.slice(-3).map(w => {
          const icons = { management:'ğŸ‘¥', finance:'ğŸ’°', operations:'âš™ï¸', strategy:'ğŸ¯', hr:'ğŸ‘”', communication:'ğŸ“¢' };
          return `
            <div class="border border-gray-200 p-3 rounded-lg bg-gray-50 opacity-75">
              <div class="flex items-center space-x-2 mb-1">
                <span class="text-sm">${icons[w.category] || 'âš™ï¸'}</span>
                <h4 class="text-sm font-medium text-gray-700 line-through">${w.title}</h4>
                <span class="text-xs text-green-600">âœ“</span>
              </div>
              <p class="text-xs text-gray-500">${w.notes || ''}</p>
            </div>`;
        }).join('');
      }
    }

    function completeWhirlwind(id) {
      const w = whirlwinds.find(x => x.id === id);
      if (!w) return;
      w.completed = true; w.completedAt = new Date();
      saveToStorage();
      renderWhirlwinds();
      updateCoachMessage('celebration', 'ğŸ‰ Excellent ! Une action de moins dans le tourbillon. Vous gardez le cap !');
    }
    function deleteWhirlwind(id) {
      whirlwinds = whirlwinds.filter(x => x.id !== id);
      saveToStorage();
      renderWhirlwinds();
    }
    function refreshRecommendations() {
      if (managerMode && whirlwinds.length < 5) {
        const s = generateManagerSuggestions();
        const d = new Date(); d.setMonth(d.getMonth() + 1);
        const nw = {
          id: Date.now(), title: s.title, category: s.category, priority: s.priority,
          deadline: d.toISOString().split('T')[0], notes: s.notes, completed: false,
          createdAt: new Date(), createdBy: 'manager'
        };
        whirlwinds.push(nw);
        saveToStorage();
        renderWhirlwinds();
        updateCoachMessage('motivation',"ğŸ’¡ J'ai ajoutÃ© une suggestion d'action basÃ©e sur les meilleures pratiques managÃ©riales !");
      } else {
        updateCoachMessage('motivation', "ğŸ”„ Recommandations actualisÃ©es ! Concentrez-vous sur vos objectifs actuels avant d'en ajouter de nouveaux.");
      }
    }

    /* =========================
       INITIALISATION
       ========================= */
    function initUI() {
      loadFromStorage();
      renderObjectives();
      renderDeliverables();
      renderActions();
      renderWhirlwinds();
      updateStats();

      // Messages pÃ©riodiques du coach (demo)
      setInterval(() => {
        if (objectives.length > 0 && Math.random() > 0.7) {
          const tips = [
            "ğŸ’¡ Astuce : Divisez vos grands objectifs en petites Ã©tapes quotidiennes !",
            "ğŸŒŸ Vous progressez bien ! N'oubliez pas de cÃ©lÃ©brer vos petites victoires.",
            "â° Il est temps de faire le point sur vos objectifs. Comment vous sentez-vous ?",
            "ğŸš€ PrÃªt pour un nouveau dÃ©fi ? Vos progrÃ¨s sont impressionnants !",
            "ğŸ’ª La constance est la clÃ© du succÃ¨s. Continuez sur cette lancÃ©e !"
          ];
          updateCoachMessage('motivation', tips[Math.floor(Math.random()*tips.length)]);
        }
      }, 30000);
    }

    /* =========================
       AUTH FIREBASE â€“ DÃ‰CONNEXION
       ========================= */
    const AFTER_LOGOUT_REDIRECT = './login.html'; // â† change si besoin

    function wireAuth() {
      const auth = firebase.auth();
      const userEmailSpan = document.getElementById('userEmail');
      const logoutBtn = document.getElementById('logoutBtn');

      auth.onAuthStateChanged((user) => {
        if (user) {
          userEmailSpan.textContent = user.email || '';
          logoutBtn.classList.remove('hidden');
        } else {
          // Pas connectÃ© â†’ rediriger vers login (si la page existe), sinon recharger
          if (AFTER_LOGOUT_REDIRECT) {
            window.location.href = AFTER_LOGOUT_REDIRECT;
          } else {
            window.location.reload();
          }
        }
      });

      logoutBtn.addEventListener('click', async () => {
        try {
          await auth.signOut();
        } catch (e) {
          console.error('Erreur de dÃ©connexion :', e);
          // Fallback visuel
          alert("DÃ©connexion Ã©chouÃ©e. RÃ©essayez.");
        }
      });
    }

    // Boot
    document.addEventListener('DOMContentLoaded', () => {
      initUI();
      try { wireAuth(); } catch (e) { console.warn("Auth non initialisÃ©e (firebase.js requis).", e); }
    });
  </script>
</body>
</html>
