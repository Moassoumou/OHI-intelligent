<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coach Objectifs IA â€” OHI & Tourbillons</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#8b5cf6',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444'
          }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-hover { transition: all 0.25s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -6px rgba(0,0,0,0.12); }
    .progress-ring { transform: rotate(-90deg); }
    .pulse-dot { animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100% { opacity:1 } 50% { opacity:.5 } }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">

  <!-- HEADER -->
  <header class="gradient-bg text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-6">
        <div class="flex items-center space-x-4">
          <div class="w-12 h-12 bg-white/20 rounded-xl grid place-items-center">
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold">Coach Objectifs IA</h1>
            <p class="text-white/80 text-sm">OHI (Objectifs) & ğŸŒªï¸ Tourbillons</p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <div class="hidden md:flex items-center gap-2 bg-white/20 rounded-lg px-3 py-2">
            <span class="w-2 h-2 bg-green-400 rounded-full pulse-dot"></span>
            <span class="text-sm">Coach actif</span>
          </div>
          <span id="userEmail" class="hidden sm:inline text-sm opacity-90"></span>
          <button id="logoutBtn"
                  class="bg-white/20 hover:bg-white/30 transition-colors text-white px-4 py-2 rounded-lg">
            DÃ©connexion
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- BARRE Dâ€™OUTILS -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
    <div class="bg-white rounded-2xl shadow-sm border p-4 md:p-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 md:gap-4">
        <!-- Recherche -->
        <div class="md:col-span-2">
          <label class="text-xs text-gray-600">Rechercher</label>
          <div class="relative">
            <input id="searchInput" type="text" placeholder="Titre, descriptionâ€¦"
                   class="w-full border rounded-xl pl-10 pr-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent"/>
            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10 18a8 8 0 100-16 8 8 0 000 16z"/>
            </svg>
          </div>
        </div>

        <!-- Filtres -->
        <div>
          <label class="text-xs text-gray-600">CatÃ©gorie</label>
          <select id="filterCategory" class="w-full border rounded-xl p-2">
            <option value="">Toutes</option>
            <option value="business">ğŸš€ Business</option>
            <option value="personal">ğŸ¯ Personnel</option>
            <option value="learning">ğŸ“š Apprentissage</option>
            <option value="health">ğŸ’ª SantÃ©</option>
          </select>
        </div>

        <div class="grid grid-cols-2 gap-3 md:gap-4 md:grid-cols-2 md:col-span-1">
          <div>
            <label class="text-xs text-gray-600">PrioritÃ©</label>
            <select id="filterPriority" class="w-full border rounded-xl p-2">
              <option value="">Toutes</option>
              <option value="high">ğŸ”´ Haute</option>
              <option value="medium">ğŸŸ¡ Moyenne</option>
              <option value="low">ğŸŸ¢ Basse</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-gray-600">Statut</label>
            <select id="filterStatus" class="w-full border rounded-xl p-2">
              <option value="">Tous</option>
              <option value="open">En cours</option>
              <option value="done">TerminÃ©s</option>
            </select>
          </div>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
        <div>
          <label class="text-xs text-gray-600">Trier par</label>
          <select id="sortBy" class="w-full border rounded-xl p-2">
            <option value="createdAt_desc">CrÃ©ation (rÃ©cent â†’ ancien)</option>
            <option value="createdAt_asc">CrÃ©ation (ancien â†’ rÃ©cent)</option>
            <option value="deadline_asc">Ã‰chÃ©ance (proche â†’ loin)</option>
            <option value="progress_desc">Progression (haut â†’ bas)</option>
            <option value="priority_desc">PrioritÃ© (haute â†’ basse)</option>
          </select>
        </div>

        <div class="col-span-1 flex items-end gap-2">
          <button id="exportCsvBtn" class="w-full border rounded-xl py-2 hover:bg-gray-50">Exporter CSV</button>
          <button id="exportPdfBtn" class="w-full border rounded-xl py-2 hover:bg-gray-50">Exporter PDF</button>
        </div>

        <div class="col-span-2 md:col-span-1 flex items-end gap-2 justify-end">
          <button id="newObjectiveBtn" class="bg-primary text-white px-4 py-2 rounded-xl hover:bg-blue-600">+ Nouvel OHI</button>
          <button id="newWhirlwindBtn" class="bg-orange-600 text-white px-4 py-2 rounded-xl hover:bg-orange-700">+ Tourbillon</button>
        </div>

        <div class="hidden md:flex items-end justify-end text-sm text-gray-500">
          <span id="filterCount">0 Ã©lÃ©ments</span>
        </div>
      </div>
    </div>
  </section>

  <!-- CONTENU -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-8">

    <!-- Grille principale -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <!-- Colonne gauche : OHI -->
      <section class="lg:col-span-2">
        <div class="bg-white rounded-2xl p-6 shadow-sm border">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-900">ğŸ“Œ Mes OHI</h3>
          </div>
          <div id="objectivesList" class="space-y-4"></div>
          <div id="emptyObjectives" class="text-center text-gray-500 py-10 hidden">
            <p>Aucun OHI correspondant aux filtres.</p>
          </div>
        </div>
      </section>

      <!-- Colonne droite : Progression -->
      <aside>
        <div class="bg-white rounded-2xl p-6 shadow-sm border">
          <h3 class="text-xl font-semibold text-gray-900 mb-6">Progression Globale</h3>
          <div class="flex items-center justify-center mb-6">
            <div class="relative w-32 h-32">
              <svg class="w-32 h-32 progress-ring">
                <circle cx="64" cy="64" r="56" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
                <circle id="progressCircle" cx="64" cy="64" r="56" stroke="#3b82f6" stroke-width="8" fill="none"
                        stroke-dasharray="351.86" stroke-dashoffset="351.86" stroke-linecap="round"></circle>
              </svg>
              <div class="absolute inset-0 grid place-items-center">
                <span id="globalProgress" class="text-2xl font-bold text-gray-900">0%</span>
              </div>
            </div>
          </div>
          <div class="space-y-3 text-sm">
            <div class="flex justify-between"><span class="text-gray-600">Objectifs complÃ©tÃ©s</span><span id="completedCount" class="font-medium">0/0</span></div>
            <div class="flex justify-between"><span class="text-gray-600">Streak actuel</span><span id="currentStreak" class="font-medium text-green-600">0 jours</span></div>
            <div class="flex justify-between"><span class="text-gray-600">Prochaine Ã©chÃ©ance</span><span id="nextDeadline" class="font-medium text-orange-600">-</span></div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Tourbillons -->
    <section class="bg-white rounded-2xl p-6 shadow-sm border border-orange-200">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-orange-100 rounded-lg grid place-items-center">
            <svg class="w-6 h-6 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div>
            <h3 class="text-xl font-semibold text-gray-900">ğŸŒªï¸ Tourbillons du Mois</h3>
            <p class="text-sm text-gray-600">Actions importantes pour ne pas se disperser</p>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="toggleManagerBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300">
            ğŸ‘” Mode Responsable
          </button>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <h4 class="font-medium text-gray-900 mb-3">En cours</h4>
          <div id="activeWhirlwinds" class="space-y-3"></div>
        </div>
        <div>
          <h4 class="font-medium text-gray-900 mb-3">TerminÃ©s</h4>
          <div id="completedWhirlwinds" class="space-y-3"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL OHI -->
  <div id="objectiveModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
      <h3 class="text-xl font-semibold text-gray-900 mb-6">CrÃ©er un OHI</h3>
      <form id="objectiveForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Titre</label>
          <input type="text" id="objectiveTitle" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Ex: Lancer mon produit" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">CatÃ©gorie</label>
          <select id="objectiveCategory" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
            <option value="business">ğŸš€ Business</option>
            <option value="personal">ğŸ¯ Personnel</option>
            <option value="learning">ğŸ“š Apprentissage</option>
            <option value="health">ğŸ’ª SantÃ©</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Ã‰chÃ©ance</label>
          <input type="date" id="objectiveDeadline" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
          <textarea id="objectiveDescription" rows="3" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="DÃ©crivez votre objectifâ€¦"></textarea>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" id="cancelObjective" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300">Annuler</button>
          <button type="submit" class="flex-1 bg-primary text-white py-2 rounded-lg hover:bg-blue-600">CrÃ©er</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL TOURBILLON -->
  <div id="whirlwindModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-lg w-full mx-4">
      <h3 class="text-xl font-semibold text-gray-900 mb-6">ğŸŒªï¸ Nouveau Tourbillon</h3>
      <form id="whirlwindForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Action</label>
          <input type="text" id="whirlwindTitle" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Ex: Lancer la campagne pub" required>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">CatÃ©gorie</label>
            <select id="whirlwindCategory" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500">
              <option value="management">ğŸ‘¥ Management</option>
              <option value="finance">ğŸ’° Finance</option>
              <option value="operations">âš™ï¸ OpÃ©rations</option>
              <option value="strategy">ğŸ¯ StratÃ©gie</option>
              <option value="hr">ğŸ‘” RH</option>
              <option value="communication">ğŸ“¢ Communication</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">PrioritÃ©</label>
            <select id="whirlwindPriority" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500">
              <option value="high">ğŸ”´ Haute</option>
              <option value="medium">ğŸŸ¡ Moyenne</option>
              <option value="low">ğŸŸ¢ Basse</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Ã‰chÃ©ance</label>
            <input type="date" id="whirlwindDeadline" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
          <textarea id="whirlwindNotes" rows="3" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500" placeholder="DÃ©tails, personnes impliquÃ©es, ressources nÃ©cessairesâ€¦"></textarea>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" id="cancelWhirlwind" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300">Annuler</button>
          <button type="submit" class="flex-1 bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700">CrÃ©er</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Librairies export PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase (facultatif, pour dÃ©connexion) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="./firebase.js"></script>

  <!-- LOGIQUE -->
  <script>
    // ---- Ã‰TAT ----
    let objectives = JSON.parse(localStorage.getItem('objectives') || '[]');
    let whirlwinds = JSON.parse(localStorage.getItem('whirlwinds') || '[]');
    let managerMode = false;

    // ---- HELPERS ----
    const $ = (sel) => document.querySelector(sel);
    const saveAll = () => {
      localStorage.setItem('objectives', JSON.stringify(objectives));
      localStorage.setItem('whirlwinds', JSON.stringify(whirlwinds));
    };

    const categoryIcons = { business:'ğŸš€', personal:'ğŸ¯', learning:'ğŸ“š', health:'ğŸ’ª' };
    const priorityRank = { high:3, medium:2, low:1 };

    // ---- FILTRES & TRI ----
    const ui = {
      search: $('#searchInput'),
      fCat: $('#filterCategory'),
      fPri: $('#filterPriority'),
      fSta: $('#filterStatus'),
      sort: $('#sortBy'),
      count: $('#filterCount')
    };

    function applyFilters(list) {
      const q = ui.search.value.trim().toLowerCase();
      const cat = ui.fCat.value;
      const pri = ui.fPri.value;
      const sta = ui.fSta.value;

      let filtered = list.filter(item => {
        const txt = (item.title + ' ' + (item.description||'') + ' ' + (item.notes||'')).toLowerCase();
        if (q && !txt.includes(q)) return false;
        if (cat && item.category !== cat) return false;
        if (pri && (item.priority || '') !== pri) return false;
        if (sta) {
          const isDone = !!item.completed;
          if (sta === 'open' && isDone) return false;
          if (sta === 'done' && !isDone) return false;
        }
        return true;
      });

      // TRI
      const [key, dir] = ui.sort.value.split('_');
      filtered.sort((a,b)=>{
        const mul = dir === 'asc' ? 1 : -1;
        if (key === 'deadline') {
          const da = a.deadline ? new Date(a.deadline).getTime() : Infinity;
          const db = b.deadline ? new Date(b.deadline).getTime() : Infinity;
          return (da - db) * mul;
        }
        if (key === 'progress') return ((a.progress||0) - (b.progress||0)) * mul;
        if (key === 'priority') return ((priorityRank[a.priority||'low']) - (priorityRank[b.priority||'low'])) * mul;
        // createdAt
        return ((new Date(a.createdAt||0).getTime()) - (new Date(b.createdAt||0).getTime())) * mul;
      });

      ui.count.textContent = filtered.length + ' Ã©lÃ©ments';
      return filtered;
    }

    // ---- RENDUS ----
    function renderObjectives() {
      const container = $('#objectivesList');
      container.innerHTML = '';
      const items = applyFilters(objectives);
      $('#emptyObjectives').classList.toggle('hidden', items.length !== 0);

      if (items.length === 0) return;

      container.innerHTML = items.map(obj => {
        const daysLeft = obj.deadline ? Math.ceil((new Date(obj.deadline) - new Date())/86400000) : null;
        const overdue = daysLeft !== null && daysLeft < 0;
        return `
          <div class="border rounded-xl p-4 card-hover">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-start gap-3">
                <span class="text-2xl">${categoryIcons[obj.category]||'ğŸ¯'}</span>
                <div>
                  <h4 class="font-semibold text-gray-900">${escapeHTML(obj.title)}</h4>
                  <p class="text-sm text-gray-600">${escapeHTML(obj.description||'')}</p>
                </div>
              </div>
              <div class="text-right">
                ${obj.deadline ? `<span class="text-xs text-gray-500 block">${obj.deadline}</span>`:''}
                <span class="text-sm ${overdue ? 'text-red-600':'text-gray-600'}">
                  ${obj.deadline ? (overdue ? `${Math.abs(daysLeft)}j de retard` : `${daysLeft}j restants`) : '-'}
                </span>
              </div>
            </div>

            <div class="mb-3">
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">Progression</span>
                <span class="font-medium">${obj.progress||0}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-primary h-2 rounded-full transition-all" style="width:${obj.progress||0}%"></div>
              </div>
            </div>

            <div class="flex flex-wrap gap-2">
              <button class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm" onclick="updateProgress(${obj.id}, -10)">-10%</button>
              <button class="px-3 py-1 bg-primary text-white hover:bg-blue-600 rounded text-sm" onclick="updateProgress(${obj.id}, 10)">+10%</button>
              <button class="px-3 py-1 bg-green-600 text-white hover:bg-green-700 rounded text-sm" onclick="completeObjective(${obj.id})">TerminÃ©</button>
              <button class="px-3 py-1 bg-red-100 text-red-600 hover:bg-red-200 rounded text-sm" onclick="deleteObjective(${obj.id})">Supprimer</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderWhirlwinds() {
      const activeC = $('#activeWhirlwinds');
      const doneC = $('#completedWhirlwinds');

      const active = applyFilters(whirlwinds.filter(w=>!w.completed));
      const done = applyFilters(whirlwinds.filter(w=>w.completed));

      // Actifs
      activeC.innerHTML = active.length ? active.map(w => {
        const daysLeft = w.deadline ? Math.ceil((new Date(w.deadline) - new Date())/86400000) : null;
        const overdue = daysLeft !== null && daysLeft < 0;
        const priorityColors = { high:'border-red-500 bg-red-50', medium:'border-yellow-500 bg-yellow-50', low:'border-green-500 bg-green-50' };
        const priorityLabels = { high:'ğŸ”´ Haute', medium:'ğŸŸ¡ Moyenne', low:'ğŸŸ¢ Basse' };
        const cats = { management:'ğŸ‘¥', finance:'ğŸ’°', operations:'âš™ï¸', strategy:'ğŸ¯', hr:'ğŸ‘”', communication:'ğŸ“¢' };

        return `
          <div class="border-l-4 ${priorityColors[w.priority||'low']} p-4 rounded-lg">
            <div class="flex items-start justify-between mb-2">
              <div class="flex items-center gap-2">
                <span class="text-lg">${cats[w.category]||'ğŸ“Œ'}</span>
                <h4 class="font-medium text-gray-900">${escapeHTML(w.title)}</h4>
                ${w.createdBy === 'manager' ? '<span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full">ğŸ‘” Responsable</span>' : ''}
              </div>
              <span class="text-xs ${overdue ? 'text-red-600':'text-gray-600'}">
                ${w.deadline ? (overdue ? `${Math.abs(daysLeft)}j retard` : `${daysLeft}j restants`) : '-'}
              </span>
            </div>
            <p class="text-sm text-gray-600 mb-3">${escapeHTML(w.notes||'')}</p>
            <div class="flex items-center justify-between">
              <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700">${priorityLabels[w.priority||'low']}</span>
              <div class="space-x-2">
                <button class="text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700" onclick="completeWhirlwind(${w.id})">âœ“ TerminÃ©</button>
                <button class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded hover:bg-red-200" onclick="deleteWhirlwind(${w.id})">Supprimer</button>
              </div>
            </div>
          </div>
        `;
      }).join('') : `<div class="text-sm text-gray-500">Aucune action en cours</div>`;

      // TerminÃ©s
      doneC.innerHTML = done.length ? done.slice(-10).map(w => `
        <div class="border p-3 rounded-lg bg-gray-50 opacity-80">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-sm">âœ…</span>
            <h4 class="text-sm font-medium text-gray-700 line-through">${escapeHTML(w.title)}</h4>
          </div>
          <p class="text-xs text-gray-500">${escapeHTML(w.notes||'')}</p>
        </div>
      `).join('') : `<div class="text-sm text-gray-500">Aucune action terminÃ©e</div>`;
    }

    function updateStats() {
      const total = objectives.length;
      const completed = objectives.filter(o=>o.completed).length;
      const avg = total ? Math.round(objectives.reduce((s,o)=>s+(o.progress||0),0)/total) : 0;

      $('#completedCount').textContent = `${completed}/${total}`;
      $('#globalProgress').textContent = `${avg}%`;

      const circle = $('#progressCircle');
      const circ = 2 * Math.PI * 56;
      circle.style.strokeDashoffset = (circ - (avg/100)*circ);

      $('#currentStreak').textContent = `${Math.min(total*3, 30)} jours`;
      if (objectives.length) {
        const next = objectives.filter(o=>!o.completed && o.deadline)
                               .sort((a,b)=>new Date(a.deadline)-new Date(b.deadline))[0];
        $('#nextDeadline').textContent = next ? `${Math.ceil((new Date(next.deadline)-new Date())/86400000)} jours` : '-';
      } else {
        $('#nextDeadline').textContent = '-';
      }
    }

    // ---- ACTIONS OHI ----
    function updateProgress(id, delta) {
      const o = objectives.find(x=>x.id===id);
      if (!o) return;
      o.progress = Math.max(0, Math.min(100, (o.progress||0)+delta));
      if (o.progress === 100) o.completed = true;
      saveAll(); renderObjectives(); updateStats();
    }
    function completeObjective(id) {
      const o = objectives.find(x=>x.id===id);
      if (!o) return;
      o.progress = 100; o.completed = true;
      saveAll(); renderObjectives(); updateStats();
    }
    function deleteObjective(id) {
      objectives = objectives.filter(x=>x.id!==id);
      saveAll(); renderObjectives(); updateStats();
    }

    // ---- ACTIONS TOURBILLON ----
    function completeWhirlwind(id) {
      const w = whirlwinds.find(x=>x.id===id);
      if (!w) return;
      w.completed = true;
      saveAll(); renderWhirlwinds();
    }
    function deleteWhirlwind(id) {
      whirlwinds = whirlwinds.filter(x=>x.id!==id);
      saveAll(); renderWhirlwinds();
    }

    // ---- FORMULAIRES ----
    const objectiveModal = $('#objectiveModal');
    const whirlwindModal = $('#whirlwindModal');

    $('#newObjectiveBtn').addEventListener('click', ()=>{
      $('#objectiveForm').reset();
      objectiveModal.classList.remove('hidden'); objectiveModal.classList.add('flex');
    });
    $('#cancelObjective').addEventListener('click', ()=>{ objectiveModal.classList.add('hidden'); objectiveModal.classList.remove('flex'); });

    $('#newWhirlwindBtn').addEventListener('click', ()=>{
      $('#whirlwindForm').reset();
      // dÃ©faut: Ã©chÃ©ance +1 mois
      const d = new Date(); d.setMonth(d.getMonth()+1);
      $('#whirlwindDeadline').value = d.toISOString().split('T')[0];
      whirlwindModal.classList.remove('hidden'); whirlwindModal.classList.add('flex');
    });
    $('#cancelWhirlwind').addEventListener('click', ()=>{ whirlwindModal.classList.add('hidden'); whirlwindModal.classList.remove('flex'); });

    $('#objectiveForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const obj = {
        id: Date.now(),
        title: $('#objectiveTitle').value.trim(),
        category: $('#objectiveCategory').value,
        deadline: $('#objectiveDeadline').value || null,
        description: $('#objectiveDescription').value.trim(),
        progress: 0,
        completed: false,
        createdAt: new Date().toISOString(),
        priority: null // pour filtres cohÃ©rents, laissÃ© Ã  null
      };
      objectives.push(obj); saveAll();
      objectiveModal.classList.add('hidden'); objectiveModal.classList.remove('flex');
      renderObjectives(); updateStats();
    });

    $('#whirlwindForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const w = {
        id: Date.now(),
        title: $('#whirlwindTitle').value.trim(),
        category: $('#whirlwindCategory').value,
        priority: $('#whirlwindPriority').value,
        deadline: $('#whirlwindDeadline').value || null,
        notes: $('#whirlwindNotes').value.trim(),
        completed: false,
        createdAt: new Date().toISOString(),
        createdBy: managerMode ? 'manager':'user'
      };
      whirlwinds.push(w); saveAll();
      whirlwindModal.classList.add('hidden'); whirlwindModal.classList.remove('flex');
      renderWhirlwinds();
    });

    // ---- MANAGER MODE ----
    $('#toggleManagerBtn').addEventListener('click', ()=>{
      managerMode = !managerMode;
      const btn = $('#toggleManagerBtn');
      if (managerMode) {
        btn.textContent = 'ğŸ‘¤ Mode Utilisateur';
        btn.classList.remove('bg-gray-200','text-gray-700');
        btn.classList.add('bg-orange-600','text-white');
      } else {
        btn.textContent = 'ğŸ‘” Mode Responsable';
        btn.classList.add('bg-gray-200','text-gray-700');
        btn.classList.remove('bg-orange-600','text-white');
      }
    });

    // ---- RECHERCHE (debounce) & FILTRES ----
    ;['input','change'].forEach(ev=>{
      ui.search.addEventListener(ev, debounce(()=>{
        renderObjectives(); renderWhirlwinds();
      }, 200));
    });
    [ui.fCat, ui.fPri, ui.fSta, ui.sort].forEach(el=>{
      el.addEventListener('change', ()=>{ renderObjectives(); renderWhirlwinds(); });
    });

    function debounce(fn, d){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); } }
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

    // ---- EXPORTS ----
    $('#exportCsvBtn').addEventListener('click', ()=>{
      const rows = [
        ['Type','Titre','CatÃ©gorie','PrioritÃ©','Ã‰chÃ©ance','Progression','Statut','CrÃ©Ã© le']
      ];

      const objRows = applyFilters(objectives).map(o=>[
        'OHI', o.title, o.category||'', '', o.deadline||'', (o.progress||0)+'%', o.completed?'TerminÃ©':'En cours', o.createdAt||''
      ]);
      const whRows = applyFilters(whirlwinds).map(w=>[
        'Tourbillon', w.title, w.category||'', w.priority||'', w.deadline||'', '', w.completed?'TerminÃ©':'En cours', w.createdAt||''
      ]);

      const data = rows.concat(objRows, whRows);
      const csv = data.map(r=>r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'dashboard_export.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    $('#exportPdfBtn').addEventListener('click', ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });

      doc.setFontSize(16);
      doc.text('Export OHI & Tourbillons', 40, 40);

      // OHI
      const o = applyFilters(objectives).map(x=>[
        x.title, x.category||'', x.deadline||'', (x.progress||0)+'%', x.completed?'TerminÃ©':'En cours'
      ]);
      doc.autoTable({
        startY: 60,
        head: [['OHI','CatÃ©gorie','Ã‰chÃ©ance','Progression','Statut']],
        body: o.length ? o : [['(aucun)','-','-','-','-']]
      });

      // Tourbillons
      const y = doc.lastAutoTable.finalY + 20;
      const w = applyFilters(whirlwinds).map(x=>[
        x.title, x.category||'', x.priority||'', x.deadline||'', x.completed?'TerminÃ©':'En cours'
      ]);
      doc.autoTable({
        startY: y,
        head: [['Tourbillon','CatÃ©gorie','PrioritÃ©','Ã‰chÃ©ance','Statut']],
        body: w.length ? w : [['(aucun)','-','-','-','-']]
      });

      doc.save('dashboard_export.pdf');
    });

    // ---- DÃ‰CONNEXION ----
    const logoutBtn = document.getElementById('logoutBtn');
    const userEmail = document.getElementById('userEmail');

    // Affichage email si Firebase Auth dispo
    try {
      if (window.firebase?.auth) {
        firebase.auth().onAuthStateChanged((u)=>{
          userEmail.textContent = u?.email || '';
        });
      }
    } catch(e){ /* ignore */ }

    logoutBtn.addEventListener('click', async ()=>{
      // Si Firebase Auth existe, on signOut
      try {
        if (window.firebase?.auth) {
          await firebase.auth().signOut();
        }
      } catch(e){ console.warn('SignOut Firebase:', e); }
      // Fallback: nettoyage local
      // (on garde objectifs/tourbillons locaux volontairement)
      window.location.reload();
    });

    // ---- INIT ----
    function initDefaults() {
      // si premiÃ¨re fois, initialise des exemples
      if (!objectives.length && !whirlwinds.length) {
        const d = new Date(); const threeM = new Date(); threeM.setMonth(threeM.getMonth()+3);
        objectives = [{
          id: Date.now(),
          title: 'DÃ©velopper mon activitÃ©',
          category: 'business',
          deadline: threeM.toISOString().split('T')[0],
          description: 'Augmenter mon chiffre dâ€™affaires',
          progress: 20,
          completed: false,
          createdAt: d.toISOString()
        }];
        const oneM = new Date(); oneM.setMonth(oneM.getMonth()+1);
        whirlwinds = [{
          id: Date.now()+1,
          title: 'Lancer une campagne Facebook Ads',
          category: 'marketing',
          priority: 'high',
          deadline: oneM.toISOString().split('T')[0],
          notes: 'Budget test 200â‚¬',
          completed: false,
          createdAt: d.toISOString(),
          createdBy: 'user'
        }];
        saveAll();
      }
    }

    initDefaults();
    renderObjectives();
    renderWhirlwinds();
    updateStats();
  </script>
</body>
</html>
