<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard OHI ‚Äì Coach Objectifs IA</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#8b5cf6',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444'
          }
        }
      }
    }
  </script>

  <!-- Inter font -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,.1); }
    .progress-ring { transform: rotate(-90deg); }
    .chat-bubble { animation: slideIn .3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .pulse-dot { animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .5; } }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="gradient-bg text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-6">
        <div class="flex items-center space-x-4">
          <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold">Coach Objectifs IA</h1>
            <p class="text-white text-opacity-80 text-sm">Votre compagnon intelligent pour atteindre vos objectifs</p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <div class="hidden sm:flex items-center space-x-2 bg-white/20 rounded-lg px-3 py-1.5">
            <div class="w-2 h-2 bg-green-400 rounded-full pulse-dot"></div>
            <span class="text-sm">Coach actif</span>
          </div>
          <span id="userEmail" class="text-sm bg-white/20 rounded-lg px-3 py-1.5"></span>
          <button id="logoutBtn" class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center hover:bg-white/30 transition">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 3a2 2 0 012-2h6a2 2 0 012 2v3a1 1 0 11-2 0V3H5v14h6v-3a1 1 0 112 0v3a2 2 0 01-2 2H5a2 2 0 01-2-2V3zm12.293 4.293a1 1 0 011.414 1.414L15.414 11H9a1 1 0 110-2h6.414l-1.707-1.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Coach IA Chat -->
    <section id="coachPanel" class="bg-white rounded-2xl p-6 shadow-sm mb-8 border-l-4 border-primary">
      <div class="flex items-start space-x-4">
        <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center flex-shrink-0">
          <svg class="w-6 h-6 text-primary" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"/></svg>
        </div>
        <div class="flex-1">
          <div class="flex items-center space-x-2 mb-2">
            <h3 class="font-semibold text-gray-900">Coach IA</h3>
            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">En ligne</span>
          </div>
          <div id="coachMessage" class="text-gray-700 mb-4">
            Bonjour ! üëã Je suis votre coach personnel. Commen√ßons par d√©finir votre premier objectif. Que souhaitez-vous accomplir ?
          </div>
          <div class="flex flex-wrap gap-2">
            <button onclick="quickObjective('business')" class="px-4 py-2 bg-blue-100 text-blue-800 rounded-lg text-sm hover:bg-blue-200">üöÄ Objectif Business</button>
            <button onclick="quickObjective('personal')" class="px-4 py-2 bg-green-100 text-green-800 rounded-lg text-sm hover:bg-green-200">üéØ Objectif Personnel</button>
            <button onclick="quickObjective('learning')" class="px-4 py-2 bg-purple-100 text-purple-800 rounded-lg text-sm hover:bg-purple-200">üìö Apprentissage</button>
            <button onclick="quickObjective('health')" class="px-4 py-2 bg-orange-100 text-orange-800 rounded-lg text-sm hover:bg-orange-200">üí™ Sant√© & Bien-√™tre</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Objectifs + progression -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
      <div class="lg:col-span-2">
        <div class="bg-white rounded-2xl p-6 shadow-sm">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-900">Mes Objectifs (OHI)</h3>
            <button onclick="openObjectiveModal()" class="bg-primary text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600">+ Nouvel Objectif</button>
          </div>
          <div id="objectivesList" class="space-y-4"></div>
        </div>
      </div>

      <aside class="bg-white rounded-2xl p-6 shadow-sm">
        <h3 class="text-xl font-semibold text-gray-900 mb-6">Progression Globale</h3>
        <div class="flex items-center justify-center mb-6">
          <div class="relative w-32 h-32">
            <svg class="w-32 h-32 progress-ring">
              <circle cx="64" cy="64" r="56" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
              <circle id="progressCircle" cx="64" cy="64" r="56" stroke="#3b82f6" stroke-width="8" fill="none" stroke-dasharray="351.86" stroke-dashoffset="351.86" stroke-linecap="round"></circle>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
              <span id="globalProgress" class="text-2xl font-bold text-gray-900">0%</span>
            </div>
          </div>
        </div>
        <div class="space-y-3">
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Objectifs compl√©t√©s</span>
            <span id="completedCount" class="font-medium">0/0</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Streak actuel</span>
            <span id="currentStreak" class="font-medium text-green-600">0 jours</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Prochaine √©ch√©ance</span>
            <span id="nextDeadline" class="font-medium text-orange-600">-</span>
          </div>
        </div>
      </aside>
    </section>

    <!-- Tourbillons -->
    <section class="bg-white rounded-2xl p-6 shadow-sm mb-8 border-l-4 border-orange-500">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
            <svg class="w-6 h-6 text-orange-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/></svg>
          </div>
          <div>
            <h3 class="text-xl font-semibold text-gray-900">üå™Ô∏è Tourbillons du Mois</h3>
            <p class="text-sm text-gray-600">Actions importantes pour ne pas se disperser</p>
          </div>
        </div>
        <div class="flex space-x-2">
          <button onclick="openWhirlwindModal()" class="bg-orange-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-orange-700">+ Nouveau Tourbillon</button>
          <button onclick="toggleManagerMode()" id="managerModeBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300">üëî Mode Responsable</button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Actions en cours</h4>
          <div id="activeWhirlwinds" class="space-y-3"></div>
        </div>
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Actions termin√©es</h4>
          <div id="completedWhirlwinds" class="space-y-3"></div>
        </div>
      </div>
    </section>

    <!-- Livrables + Actions recommand√©es -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <div class="bg-white rounded-2xl p-6 shadow-sm">
        <h3 class="text-xl font-semibold text-gray-900 mb-6">Livrables G√©n√©r√©s</h3>
        <div id="deliverablesList" class="space-y-3"></div>
      </div>

      <div class="bg-white rounded-2xl p-6 shadow-sm">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-semibold text-gray-900">Actions Recommand√©es</h3>
          <button onclick="refreshRecommendations()" class="text-primary hover:text-blue-600 text-sm">üîÑ Actualiser</button>
        </div>
        <div id="actionsList" class="space-y-3"></div>
      </div>
    </section>

    <!-- Stats -->
    <section class="bg-white rounded-2xl p-6 shadow-sm">
      <h3 class="text-xl font-semibold text-gray-900 mb-6">Insights & Statistiques</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="text-center">
          <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"/><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"/></svg>
          </div>
          <p class="text-2xl font-bold text-gray-900" id="totalObjectives">0</p>
          <p class="text-sm text-gray-600">Objectifs cr√©√©s</p>
        </div>
        <div class="text-center">
          <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
          </div>
          <p class="text-2xl font-bold text-gray-900" id="completedObjectives">0</p>
          <p class="text-sm text-gray-600">Objectifs atteints</p>
        </div>
        <div class="text-center">
          <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <svg class="w-8 h-8 text-purple-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd"/></svg>
          </div>
          <p class="text-2xl font-bold text-gray-900" id="averageProgress">0%</p>
          <p class="text-sm text-gray-600">Progression moyenne</p>
        </div>
        <div class="text-center">
          <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <svg class="w-8 h-8 text-orange-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/></svg>
          </div>
          <p class="text-2xl font-bold text-gray-900" id="daysActive">0</p>
          <p class="text-sm text-gray-600">Jours actifs</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal Nouvel Objectif -->
  <div id="objectiveModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
      <h3 class="text-xl font-semibold text-gray-900 mb-6">Cr√©er un Nouvel Objectif</h3>
      <form id="objectiveForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Titre de l'objectif</label>
          <input type="text" id="objectiveTitle" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Ex: Lancer mon entreprise" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Cat√©gorie</label>
          <select id="objectiveCategory" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
            <option value="business">üöÄ Business</option>
            <option value="personal">üéØ Personnel</option>
            <option value="learning">üìö Apprentissage</option>
            <option value="health">üí™ Sant√©</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Date limite</label>
          <input type="date" id="objectiveDeadline" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Description (optionnel)</label>
          <textarea id="objectiveDescription" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="D√©crivez votre objectif..."></textarea>
        </div>
        <div class="flex space-x-3 pt-4">
          <button type="button" onclick="closeObjectiveModal()" class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300">Annuler</button>
          <button type="submit" class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-blue-600">Cr√©er</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Nouveau Tourbillon -->
  <div id="whirlwindModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-lg w-full mx-4">
      <h3 class="text-xl font-semibold text-gray-900 mb-6">üå™Ô∏è Nouveau Tourbillon</h3>
      <form id="whirlwindForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Action √† mener</label>
          <input type="text" id="whirlwindTitle" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Ex: √âtablir la masse salariale" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Cat√©gorie</label>
          <select id="whirlwindCategory" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
            <option value="management">üë• Management</option>
            <option value="finance">üí∞ Finance</option>
            <option value="operations">‚öôÔ∏è Op√©rations</option>
            <option value="strategy">üéØ Strat√©gie</option>
            <option value="hr">üëî RH</option>
            <option value="communication">üì¢ Communication</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Priorit√©</label>
          <select id="whirlwindPriority" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
            <option value="high">üî¥ Haute</option>
            <option value="medium">üü° Moyenne</option>
            <option value="low">üü¢ Basse</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">√âch√©ance</label>
          <input type="date" id="whirlwindDeadline" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
          <textarea id="whirlwindNotes" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="D√©tails, personnes impliqu√©es, ressources n√©cessaires..."></textarea>
        </div>
        <div class="flex space-x-3 pt-4">
          <button type="button" onclick="closeWhirlwindModal()" class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300">Annuler</button>
          <button type="submit" class="flex-1 bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700">Cr√©er</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Ta config (doit faire firebase.initializeApp(...)) -->
  <script src="./firebase.js"></script>

  <!-- App logic -->
  <script>
    // --- Firebase handles ---
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // --- State ---
    let uid = null;
    let managerMode = false;
    let objectives = [];   // [{id, ...data}]
    let whirlwinds = [];   // [{id, ...data}]

    // --- Coach messages ---
    const coachMessages = {
      welcome: "Bonjour ! üëã Je suis votre coach personnel. Commen√ßons par d√©finir votre premier objectif. Que souhaitez-vous accomplir ?",
      firstObjective: "Excellent choix ! üéØ Je vais g√©n√©rer un plan d'action personnalis√© pour vous aider √† atteindre cet objectif. Voici mes recommandations :",
      progress: "Bravo pour vos progr√®s ! üåü Continuez sur cette lanc√©e. Voici ce que je recommande pour la suite :",
      motivation: "Je remarque que vous n'avez pas mis √† jour vos objectifs r√©cemment. üí™ Prenons quelques minutes pour faire le point ensemble !",
      celebration: "F√©licitations ! üéâ Vous avez atteint un objectif important. √ätes-vous pr√™t pour le prochain d√©fi ?"
    };

    function updateCoachMessage(type, customMessage = null) {
      const el = document.getElementById('coachMessage');
      el.innerHTML = customMessage || coachMessages[type] || coachMessages.welcome;
      el.classList.add('chat-bubble');
      setTimeout(()=>el.classList.remove('chat-bubble'), 350);
    }

    // --- Auth UI ---
    document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());

    auth.onAuthStateChanged(user => {
      if (!user) {
        document.getElementById('userEmail').textContent = 'Non connect√©';
        // Optionnel: window.location.href = '/login.html';
        return;
      }
      uid = user.uid;
      document.getElementById('userEmail').textContent = user.email || '';
      bootRealtime();
    });

    // --- Collections paths (no index needed) ---
    const ohisCol = () => db.collection('users').doc(uid).collection('ohis');
    const whirlsCol = () => db.collection('users').doc(uid).collection('whirlwinds');

    function bootRealtime() {
      // OHI listener
      ohisCol().orderBy('createdAt', 'asc').onSnapshot(snap => {
        objectives = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderObjectives();
        renderDeliverables();
        renderActions();
        updateStats();
      });

      // Whirlwinds listener
      whirlsCol().orderBy('createdAt', 'asc').onSnapshot(snap => {
        whirlwinds = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderWhirlwinds();
      });
    }

    // --- Modals ---
    function openObjectiveModal() {
      const m = document.getElementById('objectiveModal');
      m.classList.remove('hidden'); m.classList.add('flex');
    }
    function closeObjectiveModal() {
      const m = document.getElementById('objectiveModal');
      m.classList.add('hidden'); m.classList.remove('flex');
      document.getElementById('objectiveForm').reset();
    }
    function openWhirlwindModal() {
      const m = document.getElementById('whirlwindModal');
      // default +1 month
      const deadline = new Date(); deadline.setMonth(deadline.getMonth() + 1);
      document.getElementById('whirlwindDeadline').value = deadline.toISOString().split('T')[0];
      m.classList.remove('hidden'); m.classList.add('flex');
    }
    function closeWhirlwindModal() {
      const m = document.getElementById('whirlwindModal');
      m.classList.add('hidden'); m.classList.remove('flex');
      document.getElementById('whirlwindForm').reset();
    }

    // --- Quick objective templates ---
    function quickObjective(type) {
      const templates = {
        business: { title: "D√©velopper mon activit√©", category: "business", description: "Augmenter mon chiffre d'affaires et d√©velopper ma client√®le" },
        personal: { title: "Am√©liorer mon √©quilibre vie-travail", category: "personal", description: "Consacrer plus de temps √† ma famille et mes loisirs" },
        learning: { title: "Apprendre une nouvelle comp√©tence", category: "learning", description: "Ma√Ætriser une nouvelle technologie ou langue" },
        health:   { title: "Am√©liorer ma condition physique", category: "health", description: "Adopter une routine d'exercice r√©guli√®re" }
      };
      const t = templates[type]; if (!t) return;
      document.getElementById('objectiveTitle').value = t.title;
      document.getElementById('objectiveCategory').value = t.category;
      document.getElementById('objectiveDescription').value = t.description;
      const d = new Date(); d.setMonth(d.getMonth() + 3);
      document.getElementById('objectiveDeadline').value = d.toISOString().split('T')[0];
      openObjectiveModal();
    }

    // --- Deliverables & Actions generators ---
    function generateDeliverables(objective) {
      const byCat = {
        business: ["Plan d'affaires d√©taill√©","Strat√©gie marketing","Analyse de la concurrence","Pr√©visions financi√®res"],
        personal: ["Planning hebdomadaire optimis√©","Liste de priorit√©s personnelles","Routine de bien-√™tre","Objectifs de d√©veloppement personnel"],
        learning: ["Programme d'apprentissage structur√©","Ressources et supports de cours","Planning de r√©visions","Projets pratiques"],
        health:   ["Programme d'entra√Ænement personnalis√©","Plan nutritionnel √©quilibr√©","Suivi des progr√®s","Objectifs hebdomadaires"]
      };
      return byCat[objective.category] || ["Plan d'action personnalis√©"];
    }

    function generateActions(objective) {
      const defs = {
        business: [
          { action:"Cr√©er un plan d'affaires simple", description:"D√©finissez votre id√©e, votre march√© et vos revenus",
            steps:["D√©crire votre id√©e en une phrase","Identifier 3 clients potentiels","Calculer vos co√ªts de base","D√©finir votre prix de vente"],
            advancedResources:["üìñ Business Model Canvas - Alexander Osterwalder","üìö The Lean Startup - Eric Ries","üéì Coursera Entrepreneurship","üåê SCORE.org"],
          },
          { action:"Analyser la concurrence", description:"√âtudiez 5 concurrents directs pour vous positionner",
            steps:["Lister 5 concurrents principaux","Analyser leurs prix et services","Identifier leurs points faibles","D√©finir votre avantage unique"],
            advancedResources:["üìñ Blue Ocean Strategy","üîç SEMrush","üìä SimilarWeb","üéØ Five Forces"],
          },
          { action:"D√©finir votre client√®le cible", description:"Cr√©ez le profil de votre client id√©al",
            steps:["D√©finir l'√¢ge et le sexe","Identifier les besoins principaux","Localiser o√π ils se trouvent","Comprendre leur budget"],
            advancedResources:["üìñ The Mom Test","üéØ Persona Templates","üìä Google Analytics","üî¨ Jobs-to-be-Done"],
          }
        ],
        personal: [
          { action:"Organiser votre temps quotidien", description:"Cr√©ez une routine qui fonctionne pour vous",
            steps:["Noter vos activit√©s actuelles","Identifier 3 priorit√©s quotidiennes","Bloquer du temps pour chaque priorit√©","√âliminer 2 activit√©s non essentielles"],
            advancedResources:["üìñ Getting Things Done","‚è∞ Pomodoro","üì± Todoist/Notion/Trello","üéì Time Management"],
          },
          { action:"Am√©liorer votre √©quilibre vie-travail", description:"D√©finissez des limites claires",
            steps:["Fixer des heures de travail","Cr√©er un espace d√©di√©","Planifier des loisirs","Apprendre √† dire non"],
            advancedResources:["üìñ 4-Hour Workweek","üßò Mindfulness","üì± Headspace/Calm","üéØ Boundary setting"],
          },
          { action:"D√©velopper une habitude positive", description:"Int√©grez une nouvelle habitude",
            steps:["Choisir une habitude simple","Lier √† une habitude existante","Commencer par 2 minutes","Suivre les progr√®s"],
            advancedResources:["üìñ Atomic Habits","üß† Power of Habit","üì± Habitica/Streaks","üéì Behavior change"],
          }
        ],
        learning: [
          { action:"Apprendre une nouvelle comp√©tence", description:"Ma√Ætrisez les bases en 30 jours",
            steps:["Choisir la comp√©tence","Trouver 3 ressources","Pratiquer 30 min/j","Cr√©er un projet"],
            advancedResources:["üìñ Peak (Ericsson)","üéì Coursera/Udemy/Khan","üß† Feynman","üìö Anki (SRS)"],
          },
          { action:"Lire plus efficacement", description:"Vitesse et compr√©hension",
            steps:["Mesurer vitesse","√âliminer subvocalisation","Utiliser guide visuel","15 min/j"],
            advancedResources:["üìñ How to Read a Book","‚ö° Speed Reading","üì± Spreeder/ReadMe","üéØ SQ3R"],
          },
          { action:"M√©moriser plus facilement", description:"Techniques de m√©morisation",
            steps:["Associations visuelles","R√©p√©tition espac√©e","Enseigner ce que vous apprenez","Auto-tests"],
            advancedResources:["üìñ Moonwalking with Einstein","üß† Memory Palace","üì± Anki/Quizlet","üéì Learning How to Learn"],
          }
        ],
        health: [
          { action:"Bouger plus au quotidien", description:"Plus d'activit√© physique",
            steps:["Marcher 10 min apr√®s repas","Prendre les escaliers","√âtirements horaires","3 s√©ances/semaine"],
            advancedResources:["üìñ Spark (Ratey)","üí™ 7 Minute Workout","üèÉ C25K","üéØ HIIT"],
          },
          { action:"Am√©liorer votre alimentation", description:"Habitudes saines",
            steps:["Verre d'eau avant repas","Des l√©gumes √† chaque repas","Portions -20%","Meal prep"],
            advancedResources:["üìñ How Not to Die","ü•ó M√©diterran√©enne","üì± MyFitnessPal","üéì edX Nutrition"],
          },
          { action:"Mieux dormir", description:"Optimisez votre sommeil",
            steps:["Heure de coucher fixe","Sans √©crans 1h avant","Chambre fra√Æche et sombre","Routine d√©tente"],
            advancedResources:["üìñ Why We Sleep","üò¥ Sleep hygiene","üì± Sleep Cycle","üåô Rythme circadien"],
          }
        ]
      };
      const list = defs[objective.category] || [{
        action:"D√©finir un plan d'action", description:"Plan simple pour atteindre votre objectif",
        steps:["D√©finir pr√©cis√©ment","Lister les √©tapes","Fixer des √©ch√©ances","Commencer par la 1re √©tape"],
        advancedResources:["üìñ SMART","üéØ OKR","üìä Gestion de projet","üîÑ Agile"],
      }];
      // enrich with progress + checkedSteps
      return list.map(a => ({
        ...a,
        progress: 0,
        checkedSteps: new Array(a.steps.length).fill(false)
      }));
    }

    // --- Objective create ---
    document.getElementById('objectiveForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!uid) return;
      const title = document.getElementById('objectiveTitle').value.trim();
      const category = document.getElementById('objectiveCategory').value;
      const deadline = document.getElementById('objectiveDeadline').value;
      const description = document.getElementById('objectiveDescription').value.trim();
      const objective = {
        title, category, deadline,
        deadlineMs: deadline ? new Date(deadline).getTime() : null,
        description,
        progress: 0,
        completed: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        deliverables: [], actions: []
      };
      objective.deliverables = generateDeliverables(objective);
      objective.actions = generateActions(objective);
      await ohisCol().add(objective);
      closeObjectiveModal();
      updateCoachMessage(objectives.length === 0 ? 'firstObjective' : 'progress');
    });

    // --- Rendering: Objectives ---
    function renderObjectives() {
      const c = document.getElementById('objectivesList');
      if (!objectives.length) {
        c.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <p>Aucun objectif d√©fini</p><p class="text-sm">Cr√©ez votre premier objectif pour commencer</p>
          </div>`;
        return;
      }
      const icons = { business:'üöÄ', personal:'üéØ', learning:'üìö', health:'üí™' };
      c.innerHTML = objectives.map(obj => {
        const daysLeft = obj.deadline ? Math.ceil((new Date(obj.deadline) - new Date())/(1000*60*60*24)) : null;
        const isOverdue = daysLeft !== null && daysLeft < 0;
        return `
          <div class="border border-gray-200 rounded-xl p-4 card-hover">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-start space-x-3">
                <span class="text-2xl">${icons[obj.category] || 'üéØ'}</span>
                <div>
                  <h4 class="font-semibold text-gray-900">${escapeHtml(obj.title)}</h4>
                  <p class="text-sm text-gray-600">${escapeHtml(obj.description || '')}</p>
                </div>
              </div>
              <div class="text-right">
                <span class="text-sm ${isOverdue ? 'text-red-600' : 'text-gray-600'}">
                  ${obj.deadline ? (isOverdue ? `${Math.abs(daysLeft)} jours de retard` : `${daysLeft} jours restants`) : '-'}
                </span>
              </div>
            </div>
            <div class="mb-3">
              <div class="flex justify-between text-sm mb-1"><span class="text-gray-600">Progression</span><span class="font-medium">${obj.progress || 0}%</span></div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-primary h-2 rounded-full transition-all duration-300" style="width:${obj.progress || 0}%"></div>
              </div>
            </div>
            <div class="flex flex-wrap gap-2">
              <button onclick="updateProgress('${obj.id}', -10)" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm">-10%</button>
              <button onclick="updateProgress('${obj.id}', 10)" class="px-3 py-1 bg-primary text-white hover:bg-blue-600 rounded text-sm">+10%</button>
              <button onclick="completeObjective('${obj.id}')" class="px-3 py-1 bg-green-600 text-white hover:bg-green-700 rounded text-sm">Termin√©</button>
              <button onclick="deleteObjective('${obj.id}')" class="px-3 py-1 bg-red-100 text-red-600 hover:bg-red-200 rounded text-sm">Supprimer</button>
            </div>
          </div>`;
      }).join('');
    }

    // --- Deliverables ---
    function renderDeliverables() {
      const c = document.getElementById('deliverablesList');
      if (!objectives.length) {
        c.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v12h8V4H6z" clip-rule="evenodd"/></svg>
            <p>Aucun livrable g√©n√©r√©</p><p class="text-sm">Cr√©ez un objectif pour voir les livrables</p>
          </div>`;
        return;
      }
      c.innerHTML = objectives.map(obj => `
        <div class="mb-4">
          <h4 class="font-medium text-gray-900 mb-2">${escapeHtml(obj.title)}</h4>
          <div class="space-y-2">
            ${(obj.deliverables || generateDeliverables(obj)).map(d => `
              <div class="flex items-center space-x-3 p-2 bg-gray-50 rounded-lg">
                <svg class="w-4 h-4 text-primary" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v12h8V4H6z" clip-rule="evenodd"/></svg>
                <span class="text-sm text-gray-700">${escapeHtml(d)}</span>
              </div>`).join('')}
          </div>
        </div>`).join('');
    }

    // --- Actions (based on latest created objective) ---
    function renderActions() {
      const c = document.getElementById('actionsList');
      if (!objectives.length) {
        c.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/></svg>
            <p>Aucune action recommand√©e</p><p class="text-sm">Le coach analysera vos objectifs</p>
          </div>`;
        return;
      }
      const latest = objectives[objectives.length - 1];
      const actions = latest.actions && latest.actions.length ? latest.actions : generateActions(latest);

      c.innerHTML = `
        <div class="space-y-4">
          ${actions.map((a, i) => `
            <div class="border border-gray-200 rounded-lg p-4 bg-gradient-to-r from-blue-50 to-indigo-50">
              <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">${i+1}</div>
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-900 mb-1">${escapeHtml(a.action)}</h4>
                  <p class="text-sm text-gray-600 mb-3">${escapeHtml(a.description)}</p>

                  <div class="mb-3">
                    <div class="flex justify-between text-xs mb-1"><span class="text-gray-600">Progression</span><span class="font-medium">${a.progress||0}%</span></div>
                    <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width:${a.progress||0}%"></div></div>
                  </div>

                  <div class="mb-3">
                    <h5 class="text-xs font-medium text-gray-900 mb-2">√âtapes √† suivre :</h5>
                    <div class="space-y-1">
                      ${a.steps.map((s, si) => {
                        const checked = a.checkedSteps && a.checkedSteps[si] ? 'checked' : '';
                        return `
                          <div class="flex items-start space-x-2">
                            <input type="checkbox" ${checked}
                              onchange="updateActionProgress('${latest.id}', ${i}, ${si}, this.checked)"
                              class="mt-1 w-3 h-3 text-green-600 rounded">
                            <label class="text-xs text-gray-700 cursor-pointer">${escapeHtml(s)}</label>
                          </div>`;
                      }).join('')}
                    </div>
                  </div>

                  <div class="mb-3">
                    <button onclick="toggleAdvancedResources('${latest.id}', ${i})" class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full hover:bg-purple-200">üìö Ressources pour aller plus loin</button>
                    <div id="advancedResources_${latest.id}_${i}" class="hidden mt-2 bg-white rounded-lg p-3 border border-purple-200">
                      <h5 class="font-medium text-gray-900 mb-2 text-xs">Pour approfondir :</h5>
                      <div class="space-y-1 text-xs text-gray-700">
                        ${(a.advancedResources || []).map(r => `
                          <div class="flex items-start space-x-2">
                            <span class="text-purple-600">‚Ä¢</span><span>${escapeHtml(r)}</span>
                          </div>`).join('')}
                      </div>
                    </div>
                  </div>

                  <div class="flex items-center justify-between">
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Action recommand√©e</span>
                    <button onclick="markActionCompleted('${latest.id}', ${i})" class="text-xs text-primary hover:text-blue-600 font-medium">‚úì Action termin√©e</button>
                  </div>
                </div>
              </div>
            </div>`).join('')}
        </div>`;
    }

    function toggleAdvancedResources(objId, actionIndex) {
      const el = document.getElementById(`advancedResources_${objId}_${actionIndex}`);
      el.classList.toggle('hidden');
    }

    async function updateActionProgress(objectiveId, actionIndex, stepIndex, checked) {
      const obj = objectives.find(o => o.id === objectiveId);
      if (!obj) return;
      const actions = (obj.actions && obj.actions.length) ? JSON.parse(JSON.stringify(obj.actions)) : generateActions(obj);
      actions[actionIndex].checkedSteps[stepIndex] = !!checked;
      const total = actions[actionIndex].steps.length;
      const done = actions[actionIndex].checkedSteps.filter(Boolean).length;
      actions[actionIndex].progress = Math.round((done / total) * 100);
      await ohisCol().doc(objectiveId).update({ actions });
      renderActions();
    }

    async function markActionCompleted(objectiveId, actionIndex) {
      const obj = objectives.find(o => o.id === objectiveId);
      if (!obj) return;
      const actions = JSON.parse(JSON.stringify(obj.actions));
      actions[actionIndex].checkedSteps = actions[actionIndex].steps.map(() => true);
      actions[actionIndex].progress = 100;
      await ohisCol().doc(objectiveId).update({ actions });
      renderActions();
      updateCoachMessage('celebration', 'üéâ Excellent travail ! Vous avez termin√© cette action. Continuez sur cette lanc√©e !');
    }

    // --- Objective updates ---
    async function updateProgress(id, delta) {
      const obj = objectives.find(o => o.id === id); if (!obj) return;
      const p = Math.max(0, Math.min(100, (obj.progress || 0) + delta));
      await ohisCol().doc(id).update({ progress: p, completed: p === 100 });
      if (p === 100) updateCoachMessage('celebration');
    }
    async function completeObjective(id) {
      await ohisCol().doc(id).update({ progress: 100, completed: true });
      updateCoachMessage('celebration');
    }
    async function deleteObjective(id) {
      await ohisCol().doc(id).delete();
      renderActions(); // au cas o√π le dernier a √©t√© supprim√©
    }

    // --- Stats ---
    function updateStats() {
      const total = objectives.length;
      const completed = objectives.filter(o => o.completed).length;
      const avg = total ? Math.round(objectives.reduce((s,o)=>s+(o.progress||0),0)/total) : 0;

      document.getElementById('totalObjectives').textContent = total;
      document.getElementById('completedObjectives').textContent = completed;
      document.getElementById('completedCount').textContent = `${completed}/${total}`;
      document.getElementById('averageProgress').textContent = `${avg}%`;
      document.getElementById('globalProgress').textContent = `${avg}%`;

      const circle = document.getElementById('progressCircle');
      const circumference = 2 * Math.PI * 56;
      circle.style.strokeDashoffset = (circumference - (avg/100) * circumference);

      // simple "actif" & streak simul√©s
      document.getElementById('daysActive').textContent = Math.max(1, total * 7);
      document.getElementById('currentStreak').textContent = `${Math.min(total * 3, 30)} jours`;

      // Prochaine √©ch√©ance
      const pending = objectives.filter(o => !o.completed && o.deadlineMs);
      if (pending.length) {
        pending.sort((a,b)=>a.deadlineMs - b.deadlineMs);
        const days = Math.ceil((pending[0].deadlineMs - Date.now())/(1000*60*60*24));
        document.getElementById('nextDeadline').textContent = `${days} jours`;
      } else {
        document.getElementById('nextDeadline').textContent = '-';
      }
    }

    // --- Whirlwinds CRUD ---
    function toggleManagerMode() {
      managerMode = !managerMode;
      const btn = document.getElementById('managerModeBtn');
      if (managerMode) {
        btn.textContent = 'üë§ Mode Utilisateur';
        btn.classList.remove('bg-gray-200', 'text-gray-700');
        btn.classList.add('bg-orange-600','text-white');
        updateCoachMessage('motivation', 'üëî Mode Responsable activ√© ! Vous pouvez maintenant sugg√©rer des actions futures √† votre √©quipe.');
      } else {
        btn.textContent = 'üëî Mode Responsable';
        btn.classList.remove('bg-orange-600','text-white');
        btn.classList.add('bg-gray-200','text-gray-700');
        updateCoachMessage('motivation', 'üë§ Retour au mode utilisateur. Concentrez-vous sur vos objectifs personnels.');
      }
    }

    document.getElementById('whirlwindForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!uid) return;
      const w = {
        title: document.getElementById('whirlwindTitle').value.trim(),
        category: document.getElementById('whirlwindCategory').value,
        priority: document.getElementById('whirlwindPriority').value,
        deadline: document.getElementById('whirlwindDeadline').value,
        deadlineMs: new Date(document.getElementById('whirlwindDeadline').value).getTime(),
        notes: document.getElementById('whirlwindNotes').value.trim(),
        completed: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: managerMode ? 'manager' : 'user'
      };
      await whirlsCol().add(w);
      closeWhirlwindModal();
      updateCoachMessage('motivation', managerMode
        ? 'üëî Action ajout√©e avec succ√®s ! Votre √©quipe sera notifi√©e de cette nouvelle priorit√©.'
        : 'üå™Ô∏è Nouveau tourbillon ajout√© ! Gardez le focus sur cette action pour ne pas vous disperser.');
    });

    async function completeWhirlwind(id) {
      await whirlsCol().doc(id).update({ completed: true, completedAt: firebase.firestore.FieldValue.serverTimestamp() });
      updateCoachMessage('celebration', 'üéâ Excellent ! Une action de moins dans le tourbillon. Vous gardez le cap !');
    }
    async function deleteWhirlwind(id) { await whirlsCol().doc(id).delete(); }

    function renderWhirlwinds() {
      const active = whirlwinds.filter(w => !w.completed);
      const done = whirlwinds.filter(w => w.completed);

      const activeC = document.getElementById('activeWhirlwinds');
      const compC = document.getElementById('completedWhirlwinds');

      if (!active.length) {
        activeC.innerHTML = `<div class="text-center text-gray-500 py-4"><p class="text-sm">Aucune action en cours</p></div>`;
      } else {
        const cat = { management:'üë•', finance:'üí∞', operations:'‚öôÔ∏è', strategy:'üéØ', hr:'üëî', communication:'üì¢' };
        const pColor = { high:'border-red-500 bg-red-50', medium:'border-yellow-500 bg-yellow-50', low:'border-green-500 bg-green-50' };
        const pLabel = { high:'üî¥ Haute', medium:'üü° Moyenne', low:'üü¢ Basse' };
        activeC.innerHTML = active.map(w => {
          const daysLeft = w.deadlineMs ? Math.ceil((w.deadlineMs - Date.now())/(1000*60*60*24)) : null;
          const isOver = daysLeft !== null && daysLeft < 0;
          return `
            <div class="border-l-4 ${pColor[w.priority]} p-4 rounded-lg">
              <div class="flex items-start justify-between mb-2">
                <div class="flex items-center space-x-2">
                  <span class="text-lg">${cat[w.category] || 'üìå'}</span>
                  <h4 class="font-medium text-gray-900">${escapeHtml(w.title)}</h4>
                  ${w.createdBy === 'manager' ? '<span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full">üëî Responsable</span>' : ''}
                </div>
                <span class="text-xs ${isOver ? 'text-red-600' : 'text-gray-600'}">
                  ${w.deadline ? (isOver ? `${Math.abs(daysLeft)}j retard` : `${daysLeft}j restants`) : '-'}
                </span>
              </div>
              <p class="text-sm text-gray-600 mb-3">${escapeHtml(w.notes || '')}</p>
              <div class="flex items-center justify-between">
                <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700">${pLabel[w.priority]}</span>
                <div class="space-x-2">
                  <button onclick="completeWhirlwind('${w.id}')" class="text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">‚úì Termin√©</button>
                  <button onclick="deleteWhirlwind('${w.id}')" class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded hover:bg-red-200">Supprimer</button>
                </div>
              </div>
            </div>`;
        }).join('');
      }

      if (!done.length) {
        compC.innerHTML = `<div class="text-center text-gray-500 py-4"><p class="text-sm">Aucune action termin√©e</p></div>`;
      } else {
        const cat = { management:'üë•', finance:'üí∞', operations:'‚öôÔ∏è', strategy:'üéØ', hr:'üëî', communication:'üì¢' };
        compC.innerHTML = done.slice(-3).map(w => `
          <div class="border border-gray-200 p-3 rounded-lg bg-gray-50 opacity-75">
            <div class="flex items-center space-x-2 mb-1">
              <span class="text-sm">${cat[w.category] || 'üìå'}</span>
              <h4 class="text-sm font-medium text-gray-700 line-through">${escapeHtml(w.title)}</h4>
              <span class="text-xs text-green-600">‚úì</span>
            </div>
            <p class="text-xs text-gray-500">${escapeHtml(w.notes || '')}</p>
          </div>`).join('');
      }
    }

    // --- Recommendations (manager mode) ---
    function generateManagerSuggestions() {
      const all = [
        { title:"R√©vision des processus qualit√©", category:"operations", priority:"high",  notes:"Audit des proc√©dures actuelles et identification des am√©liorations" },
        { title:"Formation √©quipe sur nouvelles technologies", category:"hr", priority:"medium", notes:"Planifier des sessions pour rester comp√©titifs" },
        { title:"Analyse des co√ªts op√©rationnels", category:"finance", priority:"high", notes:"Identifier les postes optimisables" },
        { title:"R√©union strat√©gique trimestrielle", category:"strategy", priority:"medium", notes:"Point sur les objectifs et ajustements" }
      ];
      return all[Math.floor(Math.random()*all.length)];
    }
    async function refreshRecommendations() {
      if (managerMode && whirlwinds.filter(w=>!w.completed).length < 5) {
        const s = generateManagerSuggestions();
        const d = new Date(); d.setMonth(d.getMonth()+1);
        await whirlsCol().add({
          ...s,
          deadline: d.toISOString().split('T')[0],
          deadlineMs: d.getTime(),
          completed: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: 'manager'
        });
        updateCoachMessage('motivation', 'üí° Suggestion d‚Äôaction ajout√©e selon les meilleures pratiques manag√©riales.');
      } else {
        updateCoachMessage('motivation', 'üîÑ Recommandations actualis√©es ! Terminez d‚Äôabord vos actions en cours.');
      }
    }

    // --- Helpers ---
    function escapeHtml(str) {
      if (typeof str !== 'string') return '';
      return str
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    // Periodic coach nudge
    setInterval(() => {
      if (objectives.length && Math.random() > 0.7) {
        const msgs = [
          "üí° Astuce : Divisez vos grands objectifs en petites √©tapes quotidiennes !",
          "üåü Vous progressez bien ! N'oubliez pas de c√©l√©brer vos petites victoires.",
          "‚è∞ Il est temps de faire le point sur vos objectifs. Comment vous sentez-vous ?",
          "üöÄ Pr√™t pour un nouveau d√©fi ? Vos progr√®s sont impressionnants !",
          "üí™ La constance est la cl√© du succ√®s. Continuez sur cette lanc√©e !"
        ];
        updateCoachMessage('motivation', msgs[Math.floor(Math.random()*msgs.length)]);
      }
    }, 30000);
  </script>
</body>
</html>
