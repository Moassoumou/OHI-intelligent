<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coach Objectifs IA — OHI & Tourbillons (subtasks + tags)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary:'#3b82f6', secondary:'#8b5cf6',
            success:'#10b981', warning:'#f59e0b', danger:'#ef4444'
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body{font-family:'Inter',sans-serif}
    .gradient-bg{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
    .card-hover{transition:.2s ease}
    .card-hover:hover{transform:translateY(-2px);box-shadow:0 10px 25px -8px rgba(0,0,0,.12)}
    .progress-ring{transform:rotate(-90deg)}
    .chip{background:#eef2ff;color:#4338ca}
    .chip.active{background:#dbeafe;color:#1d4ed8}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- HEADER -->
  <header class="gradient-bg text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-6">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-white/20 rounded-xl grid place-items-center">
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold">Coach Objectifs IA</h1>
            <p class="text-white/80 text-sm">OHI + 🌪️ Tourbillons — sous-tâches, tags, commentaires</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <span id="userEmail" class="hidden sm:inline text-sm opacity-90"></span>
          <button id="logoutBtn" class="bg-white/20 hover:bg-white/30 transition-colors text-white px-4 py-2 rounded-lg">Déconnexion</button>
        </div>
      </div>
    </div>
  </header>

  <!-- BARRE OUTILS -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
    <div class="bg-white rounded-2xl shadow-sm border p-4 md:p-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 md:gap-4">
        <div class="md:col-span-2">
          <label class="text-xs text-gray-600">Rechercher</label>
          <div class="relative">
            <input id="searchInput" type="text" placeholder="Titre, description, commentaire…"
                   class="w-full border rounded-xl pl-10 pr-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent"/>
            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10 18a8 8 0 100-16 8 8 0 000 16z"/>
            </svg>
          </div>
        </div>
        <div>
          <label class="text-xs text-gray-600">Catégorie</label>
          <select id="filterCategory" class="w-full border rounded-xl p-2">
            <option value="">Toutes</option>
            <option value="business">🚀 Business</option>
            <option value="personal">🎯 Personnel</option>
            <option value="learning">📚 Apprentissage</option>
            <option value="health">💪 Santé</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-600">Statut</label>
          <select id="filterStatus" class="w-full border rounded-xl p-2">
            <option value="">Tous</option>
            <option value="open">En cours</option>
            <option value="done">Terminés</option>
          </select>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-5 gap-3">
        <div class="md:col-span-2">
          <label class="text-xs text-gray-600">Tag</label>
          <div class="flex gap-2 flex-wrap" id="tagBar">
            <!-- tags dynamiques -->
          </div>
        </div>
        <div>
          <label class="text-xs text-gray-600">Trier par</label>
          <select id="sortBy" class="w-full border rounded-xl p-2">
            <option value="createdAt_desc">Création (récent → ancien)</option>
            <option value="deadline_asc">Échéance (proche → loin)</option>
            <option value="progress_desc">Progression (haut → bas)</option>
            <option value="title_asc">Titre (A → Z)</option>
          </select>
        </div>
        <div class="flex items-end gap-2">
          <button id="exportCsvBtn" class="w-full border rounded-xl py-2 hover:bg-gray-50">Export CSV</button>
          <button id="exportPdfBtn" class="w-full border rounded-xl py-2 hover:bg-gray-50">Export PDF</button>
        </div>
        <div class="flex items-end justify-end gap-2">
          <button id="newObjectiveBtn" class="bg-primary text-white px-4 py-2 rounded-xl hover:bg-blue-600">+ OHI</button>
          <button id="newWhirlwindBtn" class="bg-orange-600 text-white px-4 py-2 rounded-xl hover:bg-orange-700">+ Tourbillon</button>
        </div>
      </div>
      <div class="mt-2 text-right text-sm text-gray-500"><span id="filterCount">0 élément</span></div>
    </div>
  </section>

  <!-- CONTENU -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- OHI -->
      <section class="lg:col-span-2">
        <div class="bg-white rounded-2xl p-6 shadow-sm border">
          <h3 class="text-xl font-semibold text-gray-900 mb-6">📌 Mes OHI</h3>
          <div id="objectivesList" class="space-y-4"></div>
          <div id="emptyObjectives" class="text-center text-gray-500 py-10 hidden">Aucun OHI pour ces filtres.</div>
        </div>
      </section>

      <!-- Stats -->
      <aside>
        <div class="bg-white rounded-2xl p-6 shadow-sm border">
          <h3 class="text-xl font-semibold text-gray-900 mb-6">Progression Globale</h3>
          <div class="flex items-center justify-center mb-6">
            <div class="relative w-32 h-32">
              <svg class="w-32 h-32 progress-ring">
                <circle cx="64" cy="64" r="56" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
                <circle id="progressCircle" cx="64" cy="64" r="56" stroke="#3b82f6" stroke-width="8" fill="none"
                        stroke-dasharray="351.86" stroke-dashoffset="351.86" stroke-linecap="round"></circle>
              </svg>
              <div class="absolute inset-0 grid place-items-center">
                <span id="globalProgress" class="text-2xl font-bold text-gray-900">0%</span>
              </div>
            </div>
          </div>
          <div class="space-y-3 text-sm">
            <div class="flex justify-between"><span class="text-gray-600">Objectifs complétés</span><span id="completedCount" class="font-medium">0/0</span></div>
            <div class="flex justify-between"><span class="text-gray-600">Streak actuel</span><span id="currentStreak" class="font-medium text-green-600">0 jours</span></div>
            <div class="flex justify-between"><span class="text-gray-600">Prochaine échéance</span><span id="nextDeadline" class="font-medium text-orange-600">-</span></div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Tourbillons -->
    <section class="bg-white rounded-2xl p-6 shadow-sm border border-orange-200">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-orange-100 rounded-lg grid place-items-center">
            <svg class="w-6 h-6 text-orange-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/></svg>
          </div>
          <div>
            <h3 class="text-xl font-semibold text-gray-900">🌪️ Tourbillons</h3>
            <p class="text-sm text-gray-600">Actions clés à court terme</p>
          </div>
        </div>
        <button id="toggleManagerBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300">👔 Mode Responsable</button>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <h4 class="font-medium text-gray-900 mb-3">En cours</h4>
          <div id="activeWhirlwinds" class="space-y-3"></div>
        </div>
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Terminés</h4>
          <div id="completedWhirlwinds" class="space-y-3"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL OHI -->
  <div id="objectiveModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
      <h3 class="text-xl font-semibold text-gray-900 mb-6">Créer un OHI</h3>
      <form id="objectiveForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Titre</label>
          <input type="text" id="objectiveTitle" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Catégorie</label>
          <select id="objectiveCategory" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary">
            <option value="business">🚀 Business</option>
            <option value="personal">🎯 Personnel</option>
            <option value="learning">📚 Apprentissage</option>
            <option value="health">💪 Santé</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Échéance</label>
          <input type="date" id="objectiveDeadline" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Tags (séparés par des virgules)</label>
          <input type="text" id="objectiveTags" class="w-full border rounded-lg px-3 py-2" placeholder="ex: marketing, Q3">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
          <textarea id="objectiveDescription" rows="3" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary" placeholder="Décrivez votre objectif…"></textarea>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" id="cancelObjective" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300">Annuler</button>
          <button type="submit" class="flex-1 bg-primary text-white py-2 rounded-lg hover:bg-blue-600">Créer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL TOURBILLON -->
  <div id="whirlwindModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-lg w-full mx-4">
      <h3 class="text-xl font-semibold text-gray-900 mb-6">🌪️ Nouveau Tourbillon</h3>
      <form id="whirlwindForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Action</label>
          <input type="text" id="whirlwindTitle" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500" required>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Catégorie</label>
            <select id="whirlwindCategory" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500">
              <option value="management">👥 Management</option>
              <option value="finance">💰 Finance</option>
              <option value="operations">⚙️ Opérations</option>
              <option value="strategy">🎯 Stratégie</option>
              <option value="hr">👔 RH</option>
              <option value="communication">📢 Communication</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Priorité</label>
            <select id="whirlwindPriority" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500">
              <option value="high">🔴 Haute</option>
              <option value="medium">🟡 Moyenne</option>
              <option value="low">🟢 Basse</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Échéance</label>
            <input type="date" id="whirlwindDeadline" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
          <textarea id="whirlwindNotes" rows="3" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500" placeholder="Détails, personnes impliquées, ressources nécessaires…"></textarea>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" id="cancelWhirlwind" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300">Annuler</button>
          <button type="submit" class="flex-1 bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700">Créer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Export PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase (optionnel pour logout) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="./firebase.js"></script>

  <!-- LOGIQUE -->
  <script>
    // ---------- ÉTAT ----------
    let objectives = JSON.parse(localStorage.getItem('objectives') || '[]');
    let whirlwinds = JSON.parse(localStorage.getItem('whirlwinds') || '[]');
    let managerMode = false;
    let activeTag = '';

    // ---------- HELPERS ----------
    const $ = s => document.querySelector(s);
    const esc = s => (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
    const save = () => {
      localStorage.setItem('objectives', JSON.stringify(objectives));
      localStorage.setItem('whirlwinds', JSON.stringify(whirlwinds));
      renderTagBar();
    };
    const catIcon = { business:'🚀', personal:'🎯', learning:'📚', health:'💪' };

    // ---------- FILTRES ----------
    const ui = {
      q: $('#searchInput'),
      cat: $('#filterCategory'),
      sta: $('#filterStatus'),
      sort: $('#sortBy'),
      count: $('#filterCount')
    };

    function matchFilters(item, type='ohi') {
      const text = (item.title+' '+(item.description||'')+' '+(item.notes||'')+' '+(item.comments||[]).map(c=>c.text).join(' ')).toLowerCase();
      const q = ui.q.value.trim().toLowerCase();
      if (q && !text.includes(q)) return false;
      if (ui.cat.value && item.category !== ui.cat.value) return false;
      if (ui.sta.value) {
        const done = !!item.completed;
        if (ui.sta.value === 'open' && done) return false;
        if (ui.sta.value === 'done' && !done) return false;
      }
      if (activeTag) {
        const tags = (item.tags||[]);
        if (!tags.map(t=>t.toLowerCase()).includes(activeTag.toLowerCase())) return false;
      }
      return true;
    }

    function sortList(list) {
      const [key, dir] = ($('#sortBy').value||'createdAt_desc').split('_');
      const mul = dir === 'asc' ? 1 : -1;
      return list.sort((a,b)=>{
        if (key==='deadline') {
          const da = a.deadline ? new Date(a.deadline).getTime() : Infinity;
          const db = b.deadline ? new Date(b.deadline).getTime() : Infinity;
          return (da-db)*mul;
        }
        if (key==='progress') return ((a.progress||0)-(b.progress||0))*mul;
        if (key==='title') return (a.title||'').localeCompare(b.title||'')*mul;
        // createdAt
        return ((new Date(a.createdAt||0)) - (new Date(b.createdAt||0))) * mul;
      });
    }

    // ---------- TAGS ----------
    function collectAllTags() {
      const set = new Set();
      objectives.forEach(o => (o.tags||[]).forEach(t=>t && set.add(t)));
      return Array.from(set).sort((a,b)=>a.localeCompare(b));
    }
    function renderTagBar() {
      const bar = $('#tagBar');
      const tags = collectAllTags();
      bar.innerHTML = '';
      if (!tags.length) {
        bar.innerHTML = `<span class="text-xs text-gray-400">Aucun tag pour l’instant</span>`;
        return;
      }
      const clear = document.createElement('button');
      clear.className = `px-3 py-1 rounded-full text-xs border ${activeTag?'':'chip'}`
      clear.textContent = 'Tous';
      clear.onclick = () => { activeTag=''; renderObjectives(); renderWhirlwinds(); renderTagBar(); };
      bar.appendChild(clear);

      tags.forEach(t=>{
        const b = document.createElement('button');
        b.className = `px-3 py-1 rounded-full text-xs border chip ${activeTag===t?'active':''}`;
        b.textContent = t;
        b.onclick = ()=>{ activeTag = (activeTag===t?'':t); renderObjectives(); renderWhirlwinds(); renderTagBar(); };
        bar.appendChild(b);
      });
    }

    // ---------- RENDU OHI ----------
    function renderObjectives() {
      const wrap = $('#objectivesList');
      wrap.innerHTML = '';
      const filtered = sortList(objectives.filter(o => matchFilters(o,'ohi')));
      $('#emptyObjectives').classList.toggle('hidden', filtered.length !== 0);
      ui.count.textContent = filtered.length + ' élément' + (filtered.length>1?'s':'');

      wrap.innerHTML = filtered.map(o=>{
        // progress = si sous-tâches, % done ; sinon valeur stockée
        const totalSub = (o.subtasks||[]).length;
        const doneSub = (o.subtasks||[]).filter(s=>s.done).length;
        const progress = totalSub ? Math.round(doneSub/totalSub*100) : (o.progress||0);
        o.progress = progress; // garde aligné

        const daysLeft = o.deadline ? Math.ceil((new Date(o.deadline)-new Date())/86400000) : null;
        const overdue = daysLeft!==null && daysLeft<0;

        const tags = (o.tags||[]).map(t=>`<span class="text-[11px] px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 border">${esc(t)}</span>`).join(' ');

        const subtasksHtml = (o.subtasks||[]).map(s=>`
          <label class="flex items-start gap-2 text-sm">
            <input type="checkbox" ${s.done?'checked':''} onchange="toggleSubtask(${o.id},${s.id})" class="mt-1 w-4 h-4 text-green-600 rounded">
            <span class="${s.done?'line-through text-gray-400':''}">${esc(s.title)}</span>
          </label>
        `).join('') || `<div class="text-xs text-gray-400">Aucune sous-tâche</div>`;

        const commentsHtml = (o.comments||[]).slice(-3).map(c=>`
          <div class="text-xs text-gray-700"><span class="text-gray-400">${new Date(c.at).toLocaleString()}</span> — ${esc(c.text)}</div>
        `).join('') || `<div class="text-xs text-gray-400">Aucun commentaire</div>`;

        return `
          <div class="border rounded-xl p-4 card-hover">
            <div class="flex items-start justify-between gap-3">
              <div class="flex items-start gap-3">
                <span class="text-2xl">${catIcon[o.category]||'🎯'}</span>
                <div>
                  <h4 class="font-semibold text-gray-900">${esc(o.title)}</h4>
                  <p class="text-sm text-gray-600">${esc(o.description||'')}</p>
                  <div class="mt-2 flex flex-wrap gap-2">${tags}</div>
                </div>
              </div>
              <div class="text-right text-sm">
                ${o.deadline?`<div class="text-gray-500">${o.deadline}</div>`:''}
                <div class="${overdue?'text-red-600':'text-gray-600'}">
                  ${o.deadline?(overdue?`${Math.abs(daysLeft)}j de retard`:`${daysLeft}j restants`):'-'}
                </div>
              </div>
            </div>

            <div class="mt-3">
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">Progression</span>
                <span class="font-medium">${progress}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-primary h-2 rounded-full transition-all" style="width:${progress}%"></div>
              </div>
            </div>

            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <div class="flex items-center justify-between mb-1">
                  <h5 class="text-sm font-medium text-gray-900">Sous-tâches</h5>
                  <button class="text-xs text-primary" onclick="promptAddSubtask(${o.id})">+ Ajouter</button>
                </div>
                <div class="space-y-2">${subtasksHtml}</div>
              </div>
              <div>
                <div class="flex items-center justify-between mb-1">
                  <h5 class="text-sm font-medium text-gray-900">Commentaires</h5>
                  <button class="text-xs text-primary" onclick="promptAddComment(${o.id})">+ Ajouter</button>
                </div>
                <div class="space-y-1">${commentsHtml}</div>
              </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
              <button class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700" onclick="completeObjective(${o.id})">Terminé</button>
              <button class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm" onclick="nudgeProgress(${o.id},10)">+10%</button>
              <button class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm" onclick="nudgeProgress(${o.id},-10)">-10%</button>
              <button class="px-3 py-1 bg-red-100 text-red-600 hover:bg-red-200 rounded text-sm" onclick="deleteObjective(${o.id})">Supprimer</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // ---------- RENDU TOURBILLONS ----------
    function renderWhirlwinds() {
      const activeC = $('#activeWhirlwinds');
      const doneC = $('#completedWhirlwinds');

      const active = sortList(whirlwinds.filter(w => !w.completed && matchFilters(w,'whirl')));
      const done = sortList(whirlwinds.filter(w => w.completed && matchFilters(w,'whirl')));

      const pCol = {high:'border-red-500 bg-red-50',medium:'border-yellow-500 bg-yellow-50',low:'border-green-500 bg-green-50'};
      const pLbl = {high:'🔴 Haute',medium:'🟡 Moyenne',low:'🟢 Basse'};
      const cats = {management:'👥',finance:'💰',operations:'⚙️',strategy:'🎯',hr:'👔',communication:'📢'};

      activeC.innerHTML = active.length ? active.map(w=>{
        const daysLeft = w.deadline ? Math.ceil((new Date(w.deadline)-new Date())/86400000) : null;
        const od = daysLeft!==null && daysLeft<0;
        return `
          <div class="border-l-4 ${pCol[w.priority||'low']} p-4 rounded-lg">
            <div class="flex items-start justify-between mb-2">
              <div class="flex items-center gap-2">
                <span class="text-lg">${cats[w.category]||'📌'}</span>
                <h4 class="font-medium text-gray-900">${esc(w.title)}</h4>
                ${w.createdBy==='manager'?'<span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full">👔 Responsable</span>':''}
              </div>
              <span class="text-xs ${od?'text-red-600':'text-gray-600'}">${w.deadline?(od?`${Math.abs(daysLeft)}j retard`:`${daysLeft}j restants`):'-'}</span>
            </div>
            <p class="text-sm text-gray-600 mb-3">${esc(w.notes||'')}</p>
            <div class="flex items-center justify-between">
              <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700">${pLbl[w.priority||'low']}</span>
              <div class="space-x-2">
                <button class="text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700" onclick="completeWhirlwind(${w.id})">✓ Terminé</button>
                <button class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded hover:bg-red-200" onclick="deleteWhirlwind(${w.id})">Supprimer</button>
              </div>
            </div>
          </div>
        `;
      }).join('') : `<div class="text-sm text-gray-500">Aucune action en cours</div>`;

      doneC.innerHTML = done.length ? done.slice(-10).map(w=>`
        <div class="border p-3 rounded-lg bg-gray-50 opacity-80">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-sm">✅</span>
            <h4 class="text-sm font-medium text-gray-700 line-through">${esc(w.title)}</h4>
          </div>
          <p class="text-xs text-gray-500">${esc(w.notes||'')}</p>
        </div>
      `).join('') : `<div class="text-sm text-gray-500">Aucune action terminée</div>`;
    }

    // ---------- STATISTIQUES ----------
    function updateStats() {
      const total = objectives.length;
      const completed = objectives.filter(o=>o.completed).length;
      const avg = total ? Math.round(objectives.reduce((s,o)=>s+(o.progress||0),0)/total) : 0;

      $('#completedCount').textContent = `${completed}/${total}`;
      $('#globalProgress').textContent = `${avg}%`;

      const circ = 2 * Math.PI * 56;
      $('#progressCircle').style.strokeDashoffset = (circ - (avg/100)*circ);

      $('#currentStreak').textContent = `${Math.min(total*3, 30)} jours`;
      if (objectives.length) {
        const next = objectives.filter(o=>!o.completed && o.deadline)
                               .sort((a,b)=>new Date(a.deadline)-new Date(b.deadline))[0];
        $('#nextDeadline').textContent = next ? `${Math.ceil((new Date(next.deadline)-new Date())/86400000)} jours` : '-';
      } else $('#nextDeadline').textContent = '-';
    }

    // ---------- OHI : opérations ----------
    function nudgeProgress(id,delta){
      const o = objectives.find(x=>x.id===id); if(!o) return;
      if (o.subtasks && o.subtasks.length) return; // progression auto si sous-tâches
      o.progress = Math.max(0, Math.min(100, (o.progress||0)+delta));
      if (o.progress===100) o.completed = true;
      save(); renderObjectives(); updateStats();
    }
    function completeObjective(id){
      const o = objectives.find(x=>x.id===id); if(!o) return;
      o.completed = true; o.progress = 100;
      if (o.subtasks) o.subtasks.forEach(s=>s.done=true);
      save(); renderObjectives(); updateStats();
    }
    function deleteObjective(id){
      objectives = objectives.filter(x=>x.id!==id);
      save(); renderObjectives(); updateStats();
    }

    // Sous-tâches
    function promptAddSubtask(oid){
      const title = prompt('Titre de la sous-tâche :');
      if(!title) return;
      const o = objectives.find(x=>x.id===oid); if(!o) return;
      o.subtasks = o.subtasks||[];
      o.subtasks.push({ id: Date.now(), title: title.trim(), done:false });
      save(); renderObjectives(); updateStats();
    }
    function toggleSubtask(oid, sid){
      const o = objectives.find(x=>x.id===oid); if(!o) return;
      const s = (o.subtasks||[]).find(u=>u.id===sid); if(!s) return;
      s.done = !s.done;
      // recalcul progress
      const total = (o.subtasks||[]).length, done = (o.subtasks||[]).filter(x=>x.done).length;
      o.progress = total ? Math.round(done/total*100) : (o.progress||0);
      if (o.progress===100) o.completed = true; else o.completed = false;
      save(); renderObjectives(); updateStats();
    }

    // Commentaires
    function promptAddComment(oid){
      const text = prompt('Votre commentaire :');
      if(!text) return;
      const o = objectives.find(x=>x.id===oid); if(!o) return;
      o.comments = o.comments||[];
      o.comments.push({ at: new Date().toISOString(), text: text.trim() });
      save(); renderObjectives();
    }

    // ---------- TOURBILLONS : opérations ----------
    function completeWhirlwind(id){
      const w = whirlwinds.find(x=>x.id===id); if(!w) return;
      w.completed = true; save(); renderWhirlwinds();
    }
    function deleteWhirlwind(id){
      whirlwinds = whirlwinds.filter(x=>x.id!==id);
      save(); renderWhirlwinds();
    }

    // ---------- FORMULAIRES ----------
    const objectiveModal = $('#objectiveModal');
    const whirlwindModal = $('#whirlwindModal');

    $('#newObjectiveBtn').addEventListener('click', ()=>{ $('#objectiveForm').reset(); objectiveModal.classList.remove('hidden'); objectiveModal.classList.add('flex'); });
    $('#cancelObjective').addEventListener('click', ()=>{ objectiveModal.classList.add('hidden'); objectiveModal.classList.remove('flex'); });

    $('#newWhirlwindBtn').addEventListener('click', ()=>{
      $('#whirlwindForm').reset();
      const d = new Date(); d.setMonth(d.getMonth()+1);
      $('#whirlwindDeadline').value = d.toISOString().split('T')[0];
      whirlwindModal.classList.remove('hidden'); whirlwindModal.classList.add('flex');
    });
    $('#cancelWhirlwind').addEventListener('click', ()=>{ whirlwindModal.classList.add('hidden'); whirlwindModal.classList.remove('flex'); });

    $('#objectiveForm').addEventListener('submit', e=>{
      e.preventDefault();
      const tags = ($('#objectiveTags').value||'').split(',').map(t=>t.trim()).filter(Boolean);
      const obj = {
        id: Date.now(),
        title: $('#objectiveTitle').value.trim(),
        category: $('#objectiveCategory').value,
        deadline: $('#objectiveDeadline').value || null,
        description: $('#objectiveDescription').value.trim(),
        tags,
        subtasks: [], comments: [],
        progress: 0, completed: false,
        createdAt: new Date().toISOString()
      };
      objectives.push(obj); save();
      objectiveModal.classList.add('hidden'); objectiveModal.classList.remove('flex');
      renderObjectives(); updateStats();
    });

    $('#whirlwindForm').addEventListener('submit', e=>{
      e.preventDefault();
      const w = {
        id: Date.now(),
        title: $('#whirlwindTitle').value.trim(),
        category: $('#whirlwindCategory').value,
        priority: $('#whirlwindPriority').value,
        deadline: $('#whirlwindDeadline').value || null,
        notes: $('#whirlwindNotes').value.trim(),
        completed: false,
        createdAt: new Date().toISOString(),
        createdBy: managerMode ? 'manager':'user'
      };
      whirlwinds.push(w); save();
      whirlwindModal.classList.add('hidden'); whirlwindModal.classList.remove('flex');
      renderWhirlwinds();
    });

    // ---------- MANAGER MODE ----------
    $('#toggleManagerBtn').addEventListener('click', ()=>{
      managerMode = !managerMode;
      const btn = $('#toggleManagerBtn');
      if (managerMode) { btn.textContent='👤 Mode Utilisateur'; btn.classList.remove('bg-gray-200','text-gray-700'); btn.classList.add('bg-orange-600','text-white'); }
      else { btn.textContent='👔 Mode Responsable'; btn.classList.add('bg-gray-200','text-gray-700'); btn.classList.remove('bg-orange-600','text-white'); }
    });

    // ---------- RECHERCHE/FILTRES ----------
    function refreshAll(){ renderObjectives(); renderWhirlwinds(); updateStats(); }
    $('#searchInput').addEventListener('input', debounce(refreshAll, 180));
    [ui.cat, ui.sta, ui.sort].forEach(el=>el.addEventListener('change', refreshAll));
    function debounce(fn, d){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); }; }

    // ---------- EXPORT ----------
    $('#exportCsvBtn').addEventListener('click', ()=>{
      const header = ['Type','Titre','Catégorie','Échéance','Progression','Statut','Tags','Créé le'];
      const oRows = objectives.filter(o=>matchFilters(o)).map(o=>[
        'OHI', o.title, o.category||'', o.deadline||'', (o.progress||0)+'%', o.completed?'Terminé':'En cours', (o.tags||[]).join('|'), o.createdAt||''
      ]);
      const wRows = whirlwinds.filter(w=>matchFilters(w)).map(w=>[
        'Tourbillon', w.title, w.category||'', w.deadline||'', '', w.completed?'Terminé':'En cours', '', w.createdAt||''
      ]);
      const data = [header].concat(oRows, wRows);
      const csv = data.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = 'dashboard_export.csv'; a.click(); URL.revokeObjectURL(a.href);
    });

    $('#exportPdfBtn').addEventListener('click', ()=>{
      const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit:'pt', format:'a4' });
      doc.setFontSize(16); doc.text('Export OHI & Tourbillons', 40, 40);

      const o = objectives.filter(o=>matchFilters(o)).map(x=>[
        x.title, x.category||'', x.deadline||'', (x.progress||0)+'%', (x.tags||[]).join(', ')
      ]);
      doc.autoTable({ startY:60, head:[['OHI','Catégorie','Échéance','Progression','Tags']], body: o.length?o:[['(aucun)','-','-','-','-']] });

      const y = doc.lastAutoTable.finalY + 20;
      const w = whirlwinds.filter(w=>matchFilters(w)).map(x=>[
        x.title, x.category||'', x.priority||'', x.deadline||'', x.completed?'Terminé':'En cours'
      ]);
      doc.autoTable({ startY:y, head:[['Tourbillon','Catégorie','Priorité','Échéance','Statut']], body: w.length?w:[['(aucun)','-','-','-','-']] });

      doc.save('dashboard_export.pdf');
    });

    // ---------- DÉCONNEXION ----------
    const logoutBtn = document.getElementById('logoutBtn');
    const userEmail = document.getElementById('userEmail');
    try {
      if (window.firebase?.auth) {
        firebase.auth().onAuthStateChanged(u => { userEmail.textContent = u?.email || ''; });
      }
    } catch(e){}
    logoutBtn.addEventListener('click', async ()=>{
      try { if (window.firebase?.auth) await firebase.auth().signOut(); } catch(e){}
      location.reload();
    });

    // ---------- INIT ----------
    function seed() {
      if (!objectives.length && !whirlwinds.length) {
        const now = new Date();
        const o1 = {
          id: Date.now(),
          title: 'Développer mon activité',
          category: 'business',
          deadline: new Date(now.getFullYear(), now.getMonth()+3, now.getDate()).toISOString().split('T')[0],
          description: 'Augmenter le CA de 20%',
          tags: ['marketing','Q3'],
          subtasks: [
            {id:Date.now()+1, title:'Créer l’offre', done:true},
            {id:Date.now()+2, title:'Landing page', done:false},
            {id:Date.now()+3, title:'Campagne emailing', done:false},
          ],
          comments: [{at: now.toISOString(), text:'Kickoff effectué ✅'}],
          progress: 0, completed:false, createdAt: now.toISOString()
        };
        const w1 = {
          id: Date.now()+10, title:'Lancer Facebook Ads', category:'operations', priority:'high',
          deadline: new Date(now.getFullYear(), now.getMonth()+1, now.getDate()).toISOString().split('T')[0],
          notes:'Budget test 200€', completed:false, createdAt: now.toISOString(), createdBy:'user'
        };
        objectives = [o1]; whirlwinds = [w1]; save();
      }
    }
    seed(); renderTagBar(); renderObjectives(); renderWhirlwinds(); updateStats();
  </script>
</body>
</html>
